(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function r(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=r(s);fetch(s.href,o)}})();const kt=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Be(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function Qe(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function _t(t,...e){if(!Be(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function qn(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Qe(t.outputLen),Qe(t.blockLen)}function he(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function Mr(t,e){_t(t);const r=e.outputLen;if(t.length<r)throw new Error("digestInto() expects output buffer of length at least "+r)}function ge(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function Ue(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function J(t,e){return t<<32-e|t>>>e}const Pn=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Hr=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function W(t){if(_t(t),Pn)return t.toHex();let e="";for(let r=0;r<t.length;r++)e+=Hr[t[r]];return e}const tt={_0:48,_9:57,A:65,F:70,a:97,f:102};function xn(t){if(t>=tt._0&&t<=tt._9)return t-tt._0;if(t>=tt.A&&t<=tt.F)return t-(tt.A-10);if(t>=tt.a&&t<=tt.f)return t-(tt.a-10)}function Nt(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(Pn)return Uint8Array.fromHex(t);const e=t.length,r=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(r);for(let s=0,o=0;s<r;s++,o+=2){const i=xn(t.charCodeAt(o)),c=xn(t.charCodeAt(o+1));if(i===void 0||c===void 0){const l=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}n[s]=i*16+c}return n}function ke(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function an(t){return typeof t=="string"&&(t=ke(t)),_t(t),t}function X(...t){let e=0;for(let n=0;n<t.length;n++){const s=t[n];_t(s),e+=s.length}const r=new Uint8Array(e);for(let n=0,s=0;n<t.length;n++){const o=t[n];r.set(o,s),s+=o.length}return r}class Kn{}function Ur(t){const e=n=>t().update(an(n)).digest(),r=t();return e.outputLen=r.outputLen,e.blockLen=r.blockLen,e.create=()=>t(),e}function Re(t=32){if(kt&&typeof kt.getRandomValues=="function")return kt.getRandomValues(new Uint8Array(t));if(kt&&typeof kt.randomBytes=="function")return Uint8Array.from(kt.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function qr(t,e,r,n){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,r,n);const s=BigInt(32),o=BigInt(4294967295),i=Number(r>>s&o),c=Number(r&o),l=n?4:0,f=n?0:4;t.setUint32(e+l,i,n),t.setUint32(e+f,c,n)}function Pr(t,e,r){return t&e^~t&r}function Kr(t,e,r){return t&e^t&r^e&r}class zr extends Kn{constructor(e,r,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=r,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Ue(this.buffer)}update(e){he(this),e=an(e),_t(e);const{view:r,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){const c=Math.min(s-this.pos,o-i);if(c===s){const l=Ue(e);for(;s<=o-i;i+=s)this.process(l,i);continue}n.set(e.subarray(i,i+c),this.pos),this.pos+=c,i+=c,this.pos===s&&(this.process(r,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){he(this),Mr(e,this),this.finished=!0;const{buffer:r,view:n,blockLen:s,isLE:o}=this;let{pos:i}=this;r[i++]=128,ge(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let h=i;h<s;h++)r[h]=0;qr(n,s-8,BigInt(this.length*8),o),this.process(n,0);const c=Ue(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const f=l/4,g=this.get();if(f>g.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<f;h++)c.setUint32(4*h,g[h],o)}digest(){const{buffer:e,outputLen:r}=this;this.digestInto(e);const n=e.slice(0,r);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:r,buffer:n,length:s,finished:o,destroyed:i,pos:c}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=c,s%r&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const ct=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Zr=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),at=new Uint32Array(64);class Vr extends zr{constructor(e=32){super(64,e,8,!1),this.A=ct[0]|0,this.B=ct[1]|0,this.C=ct[2]|0,this.D=ct[3]|0,this.E=ct[4]|0,this.F=ct[5]|0,this.G=ct[6]|0,this.H=ct[7]|0}get(){const{A:e,B:r,C:n,D:s,E:o,F:i,G:c,H:l}=this;return[e,r,n,s,o,i,c,l]}set(e,r,n,s,o,i,c,l){this.A=e|0,this.B=r|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=c|0,this.H=l|0}process(e,r){for(let h=0;h<16;h++,r+=4)at[h]=e.getUint32(r,!1);for(let h=16;h<64;h++){const u=at[h-15],d=at[h-2],b=J(u,7)^J(u,18)^u>>>3,_=J(d,17)^J(d,19)^d>>>10;at[h]=_+at[h-7]+b+at[h-16]|0}let{A:n,B:s,C:o,D:i,E:c,F:l,G:f,H:g}=this;for(let h=0;h<64;h++){const u=J(c,6)^J(c,11)^J(c,25),d=g+u+Pr(c,l,f)+Zr[h]+at[h]|0,_=(J(n,2)^J(n,13)^J(n,22))+Kr(n,s,o)|0;g=f,f=l,l=c,c=i+d|0,i=o,o=s,s=n,n=d+_|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,c=c+this.E|0,l=l+this.F|0,f=f+this.G|0,g=g+this.H|0,this.set(n,s,o,i,c,l,f,g)}roundClean(){ge(at)}destroy(){this.set(0,0,0,0,0,0,0,0),ge(this.buffer)}}const pe=Ur(()=>new Vr),zn=pe;class Zn extends Kn{constructor(e,r){super(),this.finished=!1,this.destroyed=!1,qn(e);const n=an(r);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),ge(o)}update(e){return he(this),this.iHash.update(e),this}digestInto(e){he(this),_t(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:r,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:c}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=c,e.oHash=r._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Vn=(t,e,r)=>new Zn(t,e).update(r).digest();Vn.create=(t,e)=>new Zn(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ln=BigInt(0),tn=BigInt(1);function ye(t,e=""){if(typeof t!="boolean"){const r=e&&`"${e}"`;throw new Error(r+"expected boolean, got type="+typeof t)}return t}function yt(t,e,r=""){const n=Be(t),s=t==null?void 0:t.length,o=e!==void 0;if(!n||o&&s!==e){const i=r&&`"${r}" `,c=o?` of length ${e}`:"",l=n?`length=${s}`:`type=${typeof t}`;throw new Error(i+"expected Uint8Array"+c+", got "+l)}return t}function le(t){const e=t.toString(16);return e.length&1?"0"+e:e}function jn(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?ln:BigInt("0x"+t)}function Ot(t){return jn(W(t))}function Dn(t){return _t(t),jn(W(Uint8Array.from(t).reverse()))}function Ie(t,e){return Nt(t.toString(16).padStart(e*2,"0"))}function Yn(t,e){return Ie(t,e).reverse()}function P(t,e,r){let n;if(typeof e=="string")try{n=Nt(e)}catch(o){throw new Error(t+" must be hex string or Uint8Array, cause: "+o)}else if(Be(e))n=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const s=n.length;if(typeof r=="number"&&s!==r)throw new Error(t+" of length "+r+" expected, got "+s);return n}const qe=t=>typeof t=="bigint"&&ln<=t;function en(t,e,r){return qe(t)&&qe(e)&&qe(r)&&e<=t&&t<r}function jr(t,e,r,n){if(!en(e,r,n))throw new Error("expected valid "+t+": "+r+" <= n < "+n+", got "+e)}function Fn(t){let e;for(e=0;t>ln;t>>=tn,e+=1);return e}const re=t=>(tn<<BigInt(t))-tn;function Dr(t,e,r){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof r!="function")throw new Error("hmacFn must be a function");const n=d=>new Uint8Array(d),s=d=>Uint8Array.of(d);let o=n(t),i=n(t),c=0;const l=()=>{o.fill(1),i.fill(0),c=0},f=(...d)=>r(i,o,...d),g=(d=n(0))=>{i=f(s(0),d),o=f(),d.length!==0&&(i=f(s(1),d),o=f())},h=()=>{if(c++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const b=[];for(;d<e;){o=f();const _=o.slice();b.push(_),d+=o.length}return X(...b)};return(d,b)=>{l(),g(d);let _;for(;!(_=b(h()));)g();return l(),_}}function un(t,e,r={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function n(s,o,i){const c=t[s];if(i&&c===void 0)return;const l=typeof c;if(l!==o||c===null)throw new Error(`param "${s}" is invalid: expected ${o}, got ${l}`)}Object.entries(e).forEach(([s,o])=>n(s,o,!1)),Object.entries(r).forEach(([s,o])=>n(s,o,!0))}function _n(t){const e=new WeakMap;return(r,...n)=>{const s=e.get(r);if(s!==void 0)return s;const o=t(r,...n);return e.set(r,o),o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const V=BigInt(0),z=BigInt(1),wt=BigInt(2),Gn=BigInt(3),Wn=BigInt(4),Jn=BigInt(5),Yr=BigInt(7),Xn=BigInt(8),Fr=BigInt(9),Qn=BigInt(16);function F(t,e){const r=t%e;return r>=V?r:e+r}function Y(t,e,r){let n=t;for(;e-- >V;)n*=n,n%=r;return n}function Sn(t,e){if(t===V)throw new Error("invert: expected non-zero number");if(e<=V)throw new Error("invert: expected positive modulus, got "+e);let r=F(t,e),n=e,s=V,o=z;for(;r!==V;){const c=n/r,l=n%r,f=s-o*c;n=r,r=l,s=o,o=f}if(n!==z)throw new Error("invert: does not exist");return F(s,e)}function fn(t,e,r){if(!t.eql(t.sqr(e),r))throw new Error("Cannot find square root")}function tr(t,e){const r=(t.ORDER+z)/Wn,n=t.pow(e,r);return fn(t,n,e),n}function Gr(t,e){const r=(t.ORDER-Jn)/Xn,n=t.mul(e,wt),s=t.pow(n,r),o=t.mul(e,s),i=t.mul(t.mul(o,wt),s),c=t.mul(o,t.sub(i,t.ONE));return fn(t,c,e),c}function Wr(t){const e=se(t),r=er(t),n=r(e,e.neg(e.ONE)),s=r(e,n),o=r(e,e.neg(n)),i=(t+Yr)/Qn;return(c,l)=>{let f=c.pow(l,i),g=c.mul(f,n);const h=c.mul(f,s),u=c.mul(f,o),d=c.eql(c.sqr(g),l),b=c.eql(c.sqr(h),l);f=c.cmov(f,g,d),g=c.cmov(u,h,b);const _=c.eql(c.sqr(g),l),C=c.cmov(f,g,_);return fn(c,C,l),C}}function er(t){if(t<Gn)throw new Error("sqrt is not defined for small field");let e=t-z,r=0;for(;e%wt===V;)e/=wt,r++;let n=wt;const s=se(t);for(;Bn(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(r===1)return tr;let o=s.pow(n,e);const i=(e+z)/wt;return function(l,f){if(l.is0(f))return f;if(Bn(l,f)!==1)throw new Error("Cannot find square root");let g=r,h=l.mul(l.ONE,o),u=l.pow(f,e),d=l.pow(f,i);for(;!l.eql(u,l.ONE);){if(l.is0(u))return l.ZERO;let b=1,_=l.sqr(u);for(;!l.eql(_,l.ONE);)if(b++,_=l.sqr(_),b===g)throw new Error("Cannot find square root");const C=z<<BigInt(g-b-1),O=l.pow(h,C);g=b,h=l.sqr(O),u=l.mul(u,h),d=l.mul(d,O)}return d}}function Jr(t){return t%Wn===Gn?tr:t%Xn===Jn?Gr:t%Qn===Fr?Wr(t):er(t)}const Xr=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Qr(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},r=Xr.reduce((n,s)=>(n[s]="function",n),e);return un(t,r),t}function ts(t,e,r){if(r<V)throw new Error("invalid exponent, negatives unsupported");if(r===V)return t.ONE;if(r===z)return e;let n=t.ONE,s=e;for(;r>V;)r&z&&(n=t.mul(n,s)),s=t.sqr(s),r>>=z;return n}function nr(t,e,r=!1){const n=new Array(e.length).fill(r?t.ZERO:void 0),s=e.reduce((i,c,l)=>t.is0(c)?i:(n[l]=i,t.mul(i,c)),t.ONE),o=t.inv(s);return e.reduceRight((i,c,l)=>t.is0(c)?i:(n[l]=t.mul(i,n[l]),t.mul(i,c)),o),n}function Bn(t,e){const r=(t.ORDER-z)/wt,n=t.pow(e,r),s=t.eql(n,t.ONE),o=t.eql(n,t.ZERO),i=t.eql(n,t.neg(t.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function rr(t,e){e!==void 0&&Qe(e);const r=e!==void 0?e:t.toString(2).length,n=Math.ceil(r/8);return{nBitLength:r,nByteLength:n}}function se(t,e,r=!1,n={}){if(t<=V)throw new Error("invalid field: expected ORDER > 0, got "+t);let s,o,i=!1,c;if(typeof e=="object"&&e!=null){if(n.sqrt||r)throw new Error("cannot specify opts in two arguments");const u=e;u.BITS&&(s=u.BITS),u.sqrt&&(o=u.sqrt),typeof u.isLE=="boolean"&&(r=u.isLE),typeof u.modFromBytes=="boolean"&&(i=u.modFromBytes),c=u.allowedLengths}else typeof e=="number"&&(s=e),n.sqrt&&(o=n.sqrt);const{nBitLength:l,nByteLength:f}=rr(t,s);if(f>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let g;const h=Object.freeze({ORDER:t,isLE:r,BITS:l,BYTES:f,MASK:re(l),ZERO:V,ONE:z,allowedLengths:c,create:u=>F(u,t),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return V<=u&&u<t},is0:u=>u===V,isValidNot0:u=>!h.is0(u)&&h.isValid(u),isOdd:u=>(u&z)===z,neg:u=>F(-u,t),eql:(u,d)=>u===d,sqr:u=>F(u*u,t),add:(u,d)=>F(u+d,t),sub:(u,d)=>F(u-d,t),mul:(u,d)=>F(u*d,t),pow:(u,d)=>ts(h,u,d),div:(u,d)=>F(u*Sn(d,t),t),sqrN:u=>u*u,addN:(u,d)=>u+d,subN:(u,d)=>u-d,mulN:(u,d)=>u*d,inv:u=>Sn(u,t),sqrt:o||(u=>(g||(g=Jr(t)),g(h,u))),toBytes:u=>r?Yn(u,f):Ie(u,f),fromBytes:(u,d=!0)=>{if(c){if(!c.includes(u.length)||u.length>f)throw new Error("Field.fromBytes: expected "+c+" bytes, got "+u.length);const _=new Uint8Array(f);_.set(u,r?0:_.length-u.length),u=_}if(u.length!==f)throw new Error("Field.fromBytes: expected "+f+" bytes, got "+u.length);let b=r?Dn(u):Ot(u);if(i&&(b=F(b,t)),!d&&!h.isValid(b))throw new Error("invalid field element: outside of range 0..ORDER");return b},invertBatch:u=>nr(h,u),cmov:(u,d,b)=>b?d:u});return Object.freeze(h)}function sr(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function or(t){const e=sr(t);return e+Math.ceil(e/2)}function ir(t,e,r=!1){const n=t.length,s=sr(e),o=or(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);const i=r?Dn(t):Ot(t),c=F(i,e-z)+z;return r?Yn(c,s):Ie(c,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const At=BigInt(0),bt=BigInt(1);function we(t,e){const r=e.negate();return t?r:e}function Pe(t,e){const r=nr(t.Fp,e.map(n=>n.Z));return e.map((n,s)=>t.fromAffine(n.toAffine(r[s])))}function cr(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function Ke(t,e){cr(t,e);const r=Math.ceil(e/t)+1,n=2**(t-1),s=2**t,o=re(t),i=BigInt(t);return{windows:r,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function kn(t,e,r){const{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=r;let c=Number(t&s),l=t>>i;c>n&&(c-=o,l+=bt);const f=e*n,g=f+Math.abs(c)-1,h=c===0,u=c<0,d=e%2!==0;return{nextN:l,offset:g,isZero:h,isNeg:u,isNegF:d,offsetF:f}}function es(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((r,n)=>{if(!(r instanceof e))throw new Error("invalid point at index "+n)})}function ns(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((r,n)=>{if(!e.isValid(r))throw new Error("invalid scalar at index "+n)})}const ze=new WeakMap,ar=new WeakMap;function Ze(t){return ar.get(t)||1}function Rn(t){if(t!==At)throw new Error("invalid wNAF")}class rs{constructor(e,r){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=r}_unsafeLadder(e,r,n=this.ZERO){let s=e;for(;r>At;)r&bt&&(n=n.add(s)),s=s.double(),r>>=bt;return n}precomputeWindow(e,r){const{windows:n,windowSize:s}=Ke(r,this.bits),o=[];let i=e,c=i;for(let l=0;l<n;l++){c=i,o.push(c);for(let f=1;f<s;f++)c=c.add(i),o.push(c);i=c.double()}return o}wNAF(e,r,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE;const i=Ke(e,this.bits);for(let c=0;c<i.windows;c++){const{nextN:l,offset:f,isZero:g,isNeg:h,isNegF:u,offsetF:d}=kn(n,c,i);n=l,g?o=o.add(we(u,r[d])):s=s.add(we(h,r[f]))}return Rn(n),{p:s,f:o}}wNAFUnsafe(e,r,n,s=this.ZERO){const o=Ke(e,this.bits);for(let i=0;i<o.windows&&n!==At;i++){const{nextN:c,offset:l,isZero:f,isNeg:g}=kn(n,i,o);if(n=c,!f){const h=r[l];s=s.add(g?h.negate():h)}}return Rn(n),s}getPrecomputes(e,r,n){let s=ze.get(r);return s||(s=this.precomputeWindow(r,e),e!==1&&(typeof n=="function"&&(s=n(s)),ze.set(r,s))),s}cached(e,r,n){const s=Ze(e);return this.wNAF(s,this.getPrecomputes(s,e,n),r)}unsafe(e,r,n,s){const o=Ze(e);return o===1?this._unsafeLadder(e,r,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),r,s)}createCache(e,r){cr(r,this.bits),ar.set(e,r),ze.delete(e)}hasCache(e){return Ze(e)!==1}}function ss(t,e,r,n){let s=e,o=t.ZERO,i=t.ZERO;for(;r>At||n>At;)r&bt&&(o=o.add(s)),n&bt&&(i=i.add(s)),s=s.double(),r>>=bt,n>>=bt;return{p1:o,p2:i}}function os(t,e,r,n){es(r,t),ns(n,e);const s=r.length,o=n.length;if(s!==o)throw new Error("arrays of points and scalars must have equal length");const i=t.ZERO,c=Fn(BigInt(s));let l=1;c>12?l=c-3:c>4?l=c-2:c>0&&(l=2);const f=re(l),g=new Array(Number(f)+1).fill(i),h=Math.floor((e.BITS-1)/l)*l;let u=i;for(let d=h;d>=0;d-=l){g.fill(i);for(let _=0;_<o;_++){const C=n[_],O=Number(C>>BigInt(d)&f);g[O]=g[O].add(r[_])}let b=i;for(let _=g.length-1,C=i;_>0;_--)C=C.add(g[_]),b=b.add(C);if(u=u.add(b),d!==0)for(let _=0;_<l;_++)u=u.double()}return u}function In(t,e,r){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Qr(e),e}else return se(t,{isLE:r})}function is(t,e,r={},n){if(n===void 0&&(n=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const l of["p","n","h"]){const f=e[l];if(!(typeof f=="bigint"&&f>At))throw new Error(`CURVE.${l} must be positive bigint`)}const s=In(e.p,r.Fp,n),o=In(e.n,r.Fn,n),c=["Gx","Gy","a","b"];for(const l of c)if(!s.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Nn=(t,e)=>(t+(t>=0?e:-e)/lr)/e;function cs(t,e,r){const[[n,s],[o,i]]=e,c=Nn(i*t,r),l=Nn(-s*t,r);let f=t-c*n-l*o,g=-c*s-l*i;const h=f<rt,u=g<rt;h&&(f=-f),u&&(g=-g);const d=re(Math.ceil(Fn(r)/2))+Rt;if(f<rt||f>=d||g<rt||g>=d)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:h,k1:f,k2neg:u,k2:g}}function nn(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function Ve(t,e){const r={};for(let n of Object.keys(e))r[n]=t[n]===void 0?e[n]:t[n];return ye(r.lowS,"lowS"),ye(r.prehash,"prehash"),r.format!==void 0&&nn(r.format),r}class as extends Error{constructor(e=""){super(e)}}const et={Err:as,_tlv:{encode:(t,e)=>{const{Err:r}=et;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length&1)throw new r("tlv.encode: unpadded data");const n=e.length/2,s=le(n);if(s.length/2&128)throw new r("tlv.encode: long form length too big");const o=n>127?le(s.length/2|128):"";return le(t)+o+s+e},decode(t,e){const{Err:r}=et;let n=0;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new r("tlv.decode: wrong tlv");const s=e[n++],o=!!(s&128);let i=0;if(!o)i=s;else{const l=s&127;if(!l)throw new r("tlv.decode(long): indefinite length not supported");if(l>4)throw new r("tlv.decode(long): byte length is too big");const f=e.subarray(n,n+l);if(f.length!==l)throw new r("tlv.decode: length bytes not complete");if(f[0]===0)throw new r("tlv.decode(long): zero leftmost byte");for(const g of f)i=i<<8|g;if(n+=l,i<128)throw new r("tlv.decode(long): not minimal encoding")}const c=e.subarray(n,n+i);if(c.length!==i)throw new r("tlv.decode: wrong value length");return{v:c,l:e.subarray(n+i)}}},_int:{encode(t){const{Err:e}=et;if(t<rt)throw new e("integer: negative integers are not allowed");let r=le(t);if(Number.parseInt(r[0],16)&8&&(r="00"+r),r.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return r},decode(t){const{Err:e}=et;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Ot(t)}},toSig(t){const{Err:e,_int:r,_tlv:n}=et,s=P("signature",t),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");const{v:c,l}=n.decode(2,o),{v:f,l:g}=n.decode(2,l);if(g.length)throw new e("invalid signature: left bytes after parsing");return{r:r.decode(c),s:r.decode(f)}},hexFromSig(t){const{_tlv:e,_int:r}=et,n=e.encode(2,r.encode(t.r)),s=e.encode(2,r.encode(t.s)),o=n+s;return e.encode(48,o)}},rt=BigInt(0),Rt=BigInt(1),lr=BigInt(2),ue=BigInt(3),ls=BigInt(4);function Et(t,e){const{BYTES:r}=t;let n;if(typeof e=="bigint")n=e;else{let s=P("private key",e);try{n=t.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${r}, got ${typeof e}`)}}if(!t.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function us(t,e={}){const r=is("weierstrass",t,e),{Fp:n,Fn:s}=r;let o=r.CURVE;const{h:i,n:c}=o;un(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!n.is0(o.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const f=fr(n,s);function g(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function h(A,y,p){const{x:m,y:w}=y.toAffine(),E=n.toBytes(m);if(ye(p,"isCompressed"),p){g();const B=!n.isOdd(w);return X(ur(B),E)}else return X(Uint8Array.of(4),E,n.toBytes(w))}function u(A){yt(A,void 0,"Point");const{publicKey:y,publicKeyUncompressed:p}=f,m=A.length,w=A[0],E=A.subarray(1);if(m===y&&(w===2||w===3)){const B=n.fromBytes(E);if(!n.isValid(B))throw new Error("bad point: is not on curve, wrong x");const S=_(B);let x;try{x=n.sqrt(S)}catch(U){const L=U instanceof Error?": "+U.message:"";throw new Error("bad point: is not on curve, sqrt error"+L)}g();const k=n.isOdd(x);return(w&1)===1!==k&&(x=n.neg(x)),{x:B,y:x}}else if(m===p&&w===4){const B=n.BYTES,S=n.fromBytes(E.subarray(0,B)),x=n.fromBytes(E.subarray(B,B*2));if(!C(S,x))throw new Error("bad point: is not on curve");return{x:S,y:x}}else throw new Error(`bad point: got length ${m}, expected compressed=${y} or uncompressed=${p}`)}const d=e.toBytes||h,b=e.fromBytes||u;function _(A){const y=n.sqr(A),p=n.mul(y,A);return n.add(n.add(p,n.mul(A,o.a)),o.b)}function C(A,y){const p=n.sqr(y),m=_(A);return n.eql(p,m)}if(!C(o.Gx,o.Gy))throw new Error("bad curve params: generator point");const O=n.mul(n.pow(o.a,ue),ls),Mt=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(O,Mt)))throw new Error("bad curve params: a or b");function H(A,y,p=!1){if(!n.isValid(y)||p&&n.is0(y))throw new Error(`bad point coordinate ${A}`);return y}function dt(A){if(!(A instanceof I))throw new Error("ProjectivePoint expected")}function it(A){if(!l||!l.basises)throw new Error("no endo");return cs(A,l.basises,s.ORDER)}const St=_n((A,y)=>{const{X:p,Y:m,Z:w}=A;if(n.eql(w,n.ONE))return{x:p,y:m};const E=A.is0();y==null&&(y=E?n.ONE:n.inv(w));const B=n.mul(p,y),S=n.mul(m,y),x=n.mul(w,y);if(E)return{x:n.ZERO,y:n.ZERO};if(!n.eql(x,n.ONE))throw new Error("invZ was invalid");return{x:B,y:S}}),ie=_n(A=>{if(A.is0()){if(e.allowInfinityPoint&&!n.is0(A.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:p}=A.toAffine();if(!n.isValid(y)||!n.isValid(p))throw new Error("bad point: x or y not field elements");if(!C(y,p))throw new Error("bad point: equation left != right");if(!A.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function Bt(A,y,p,m,w){return p=new I(n.mul(p.X,A),p.Y,p.Z),y=we(m,y),p=we(w,p),y.add(p)}class I{constructor(y,p,m){this.X=H("x",y),this.Y=H("y",p,!0),this.Z=H("z",m),Object.freeze(this)}static CURVE(){return o}static fromAffine(y){const{x:p,y:m}=y||{};if(!y||!n.isValid(p)||!n.isValid(m))throw new Error("invalid affine point");if(y instanceof I)throw new Error("projective point not allowed");return n.is0(p)&&n.is0(m)?I.ZERO:new I(p,m,n.ONE)}static fromBytes(y){const p=I.fromAffine(b(yt(y,void 0,"point")));return p.assertValidity(),p}static fromHex(y){return I.fromBytes(P("pointHex",y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,p=!0){return mt.createCache(this,y),p||this.multiply(ue),this}assertValidity(){ie(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){dt(y);const{X:p,Y:m,Z:w}=this,{X:E,Y:B,Z:S}=y,x=n.eql(n.mul(p,S),n.mul(E,w)),k=n.eql(n.mul(m,S),n.mul(B,w));return x&&k}negate(){return new I(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b:p}=o,m=n.mul(p,ue),{X:w,Y:E,Z:B}=this;let S=n.ZERO,x=n.ZERO,k=n.ZERO,R=n.mul(w,w),U=n.mul(E,E),L=n.mul(B,B),N=n.mul(w,E);return N=n.add(N,N),k=n.mul(w,B),k=n.add(k,k),S=n.mul(y,k),x=n.mul(m,L),x=n.add(S,x),S=n.sub(U,x),x=n.add(U,x),x=n.mul(S,x),S=n.mul(N,S),k=n.mul(m,k),L=n.mul(y,L),N=n.sub(R,L),N=n.mul(y,N),N=n.add(N,k),k=n.add(R,R),R=n.add(k,R),R=n.add(R,L),R=n.mul(R,N),x=n.add(x,R),L=n.mul(E,B),L=n.add(L,L),R=n.mul(L,N),S=n.sub(S,R),k=n.mul(L,U),k=n.add(k,k),k=n.add(k,k),new I(S,x,k)}add(y){dt(y);const{X:p,Y:m,Z:w}=this,{X:E,Y:B,Z:S}=y;let x=n.ZERO,k=n.ZERO,R=n.ZERO;const U=o.a,L=n.mul(o.b,ue);let N=n.mul(p,E),$=n.mul(m,B),q=n.mul(w,S),Z=n.add(p,m),T=n.add(E,B);Z=n.mul(Z,T),T=n.add(N,$),Z=n.sub(Z,T),T=n.add(p,w);let K=n.add(E,S);return T=n.mul(T,K),K=n.add(N,q),T=n.sub(T,K),K=n.add(m,w),x=n.add(B,S),K=n.mul(K,x),x=n.add($,q),K=n.sub(K,x),R=n.mul(U,T),x=n.mul(L,q),R=n.add(x,R),x=n.sub($,R),R=n.add($,R),k=n.mul(x,R),$=n.add(N,N),$=n.add($,N),q=n.mul(U,q),T=n.mul(L,T),$=n.add($,q),q=n.sub(N,q),q=n.mul(U,q),T=n.add(T,q),N=n.mul($,T),k=n.add(k,N),N=n.mul(K,T),x=n.mul(Z,x),x=n.sub(x,N),N=n.mul(Z,$),R=n.mul(K,R),R=n.add(R,N),new I(x,k,R)}subtract(y){return this.add(y.negate())}is0(){return this.equals(I.ZERO)}multiply(y){const{endo:p}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let m,w;const E=B=>mt.cached(this,B,S=>Pe(I,S));if(p){const{k1neg:B,k1:S,k2neg:x,k2:k}=it(y),{p:R,f:U}=E(S),{p:L,f:N}=E(k);w=U.add(N),m=Bt(p.beta,R,L,B,x)}else{const{p:B,f:S}=E(y);m=B,w=S}return Pe(I,[m,w])[0]}multiplyUnsafe(y){const{endo:p}=e,m=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===rt||m.is0())return I.ZERO;if(y===Rt)return m;if(mt.hasCache(this))return this.multiply(y);if(p){const{k1neg:w,k1:E,k2neg:B,k2:S}=it(y),{p1:x,p2:k}=ss(I,m,E,S);return Bt(p.beta,x,k,w,B)}else return mt.unsafe(m,y)}multiplyAndAddUnsafe(y,p,m){const w=this.multiplyUnsafe(p).add(y.multiplyUnsafe(m));return w.is0()?void 0:w}toAffine(y){return St(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return i===Rt?!0:y?y(I,this):mt.unsafe(this,c).is0()}clearCofactor(){const{clearCofactor:y}=e;return i===Rt?this:y?y(I,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(y=!0){return ye(y,"isCompressed"),this.assertValidity(),d(I,this,y)}toHex(y=!0){return W(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(y=!0){return this.toBytes(y)}_setWindowSize(y){this.precompute(y)}static normalizeZ(y){return Pe(I,y)}static msm(y,p){return os(I,s,y,p)}static fromPrivateKey(y){return I.BASE.multiply(Et(s,y))}}I.BASE=new I(o.Gx,o.Gy,n.ONE),I.ZERO=new I(n.ZERO,n.ONE,n.ZERO),I.Fp=n,I.Fn=s;const ce=s.BITS,mt=new rs(I,e.endo?Math.ceil(ce/2):ce);return I.BASE.precompute(8),I}function ur(t){return Uint8Array.of(t?2:3)}function fr(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function fs(t,e={}){const{Fn:r}=t,n=e.randomBytes||Re,s=Object.assign(fr(t.Fp,r),{seed:or(r.ORDER)});function o(d){try{return!!Et(r,d)}catch{return!1}}function i(d,b){const{publicKey:_,publicKeyUncompressed:C}=s;try{const O=d.length;return b===!0&&O!==_||b===!1&&O!==C?!1:!!t.fromBytes(d)}catch{return!1}}function c(d=n(s.seed)){return ir(yt(d,s.seed,"seed"),r.ORDER)}function l(d,b=!0){return t.BASE.multiply(Et(r,d)).toBytes(b)}function f(d){const b=c(d);return{secretKey:b,publicKey:l(b)}}function g(d){if(typeof d=="bigint")return!1;if(d instanceof t)return!0;const{secretKey:b,publicKey:_,publicKeyUncompressed:C}=s;if(r.allowedLengths||b===_)return;const O=P("key",d).length;return O===_||O===C}function h(d,b,_=!0){if(g(d)===!0)throw new Error("first arg must be private key");if(g(b)===!1)throw new Error("second arg must be public key");const C=Et(r,d);return t.fromHex(b).multiply(C).toBytes(_)}return Object.freeze({getPublicKey:l,getSharedSecret:h,keygen:f,Point:t,utils:{isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:c,isValidPrivateKey:o,randomPrivateKey:c,normPrivateKeyToScalar:d=>Et(r,d),precompute(d=8,b=t.BASE){return b.precompute(d,!1)}},lengths:s})}function ds(t,e,r={}){qn(e),un(r,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=r.randomBytes||Re,s=r.hmac||((p,...m)=>Vn(e,p,X(...m))),{Fp:o,Fn:i}=t,{ORDER:c,BITS:l}=i,{keygen:f,getPublicKey:g,getSharedSecret:h,utils:u,lengths:d}=fs(t,r),b={prehash:!1,lowS:typeof r.lowS=="boolean"?r.lowS:!1,format:void 0,extraEntropy:!1},_="compact";function C(p){const m=c>>Rt;return p>m}function O(p,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${p}: out of range 1..Point.Fn.ORDER`);return m}function Mt(p,m){nn(m);const w=d.signature,E=m==="compact"?w:m==="recovered"?w+1:void 0;return yt(p,E,`${m} signature`)}class H{constructor(m,w,E){this.r=O("r",m),this.s=O("s",w),E!=null&&(this.recovery=E),Object.freeze(this)}static fromBytes(m,w=_){Mt(m,w);let E;if(w==="der"){const{r:k,s:R}=et.toSig(yt(m));return new H(k,R)}w==="recovered"&&(E=m[0],w="compact",m=m.subarray(1));const B=i.BYTES,S=m.subarray(0,B),x=m.subarray(B,B*2);return new H(i.fromBytes(S),i.fromBytes(x),E)}static fromHex(m,w){return this.fromBytes(Nt(m),w)}addRecoveryBit(m){return new H(this.r,this.s,m)}recoverPublicKey(m){const w=o.ORDER,{r:E,s:B,recovery:S}=this;if(S==null||![0,1,2,3].includes(S))throw new Error("recovery id invalid");if(c*lr<w&&S>1)throw new Error("recovery id is ambiguous for h>1 curve");const k=S===2||S===3?E+c:E;if(!o.isValid(k))throw new Error("recovery id 2 or 3 invalid");const R=o.toBytes(k),U=t.fromBytes(X(ur((S&1)===0),R)),L=i.inv(k),N=it(P("msgHash",m)),$=i.create(-N*L),q=i.create(B*L),Z=t.BASE.multiplyUnsafe($).add(U.multiplyUnsafe(q));if(Z.is0())throw new Error("point at infinify");return Z.assertValidity(),Z}hasHighS(){return C(this.s)}toBytes(m=_){if(nn(m),m==="der")return Nt(et.hexFromSig(this));const w=i.toBytes(this.r),E=i.toBytes(this.s);if(m==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return X(Uint8Array.of(this.recovery),w,E)}return X(w,E)}toHex(m){return W(this.toBytes(m))}assertValidity(){}static fromCompact(m){return H.fromBytes(P("sig",m),"compact")}static fromDER(m){return H.fromBytes(P("sig",m),"der")}normalizeS(){return this.hasHighS()?new H(this.r,i.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return W(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return W(this.toBytes("compact"))}}const dt=r.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");const w=Ot(m),E=m.length*8-l;return E>0?w>>BigInt(E):w},it=r.bits2int_modN||function(m){return i.create(dt(m))},St=re(l);function ie(p){return jr("num < 2^"+l,p,rt,St),i.toBytes(p)}function Bt(p,m){return yt(p,void 0,"message"),m?yt(e(p),void 0,"prehashed message"):p}function I(p,m,w){if(["recovered","canonical"].some($=>$ in w))throw new Error("sign() legacy options not supported");const{lowS:E,prehash:B,extraEntropy:S}=Ve(w,b);p=Bt(p,B);const x=it(p),k=Et(i,m),R=[ie(k),ie(x)];if(S!=null&&S!==!1){const $=S===!0?n(d.secretKey):S;R.push(P("extraEntropy",$))}const U=X(...R),L=x;function N($){const q=dt($);if(!i.isValidNot0(q))return;const Z=i.inv(q),T=t.BASE.multiply(q).toAffine(),K=i.create(T.x);if(K===rt)return;const ae=i.create(Z*i.create(L+K*k));if(ae===rt)return;let En=(T.x===K?0:2)|Number(T.y&Rt),vn=ae;return E&&C(ae)&&(vn=i.neg(ae),En^=1),new H(K,vn,En)}return{seed:U,k2sig:N}}function ce(p,m,w={}){p=P("message",p);const{seed:E,k2sig:B}=I(p,m,w);return Dr(e.outputLen,i.BYTES,s)(E,B)}function mt(p){let m;const w=typeof p=="string"||Be(p),E=!w&&p!==null&&typeof p=="object"&&typeof p.r=="bigint"&&typeof p.s=="bigint";if(!w&&!E)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(E)m=new H(p.r,p.s);else if(w){try{m=H.fromBytes(P("sig",p),"der")}catch(B){if(!(B instanceof et.Err))throw B}if(!m)try{m=H.fromBytes(P("sig",p),"compact")}catch{return!1}}return m||!1}function A(p,m,w,E={}){const{lowS:B,prehash:S,format:x}=Ve(E,b);if(w=P("publicKey",w),m=Bt(P("message",m),S),"strict"in E)throw new Error("options.strict was renamed to lowS");const k=x===void 0?mt(p):H.fromBytes(P("sig",p),x);if(k===!1)return!1;try{const R=t.fromBytes(w);if(B&&k.hasHighS())return!1;const{r:U,s:L}=k,N=it(m),$=i.inv(L),q=i.create(N*$),Z=i.create(U*$),T=t.BASE.multiplyUnsafe(q).add(R.multiplyUnsafe(Z));return T.is0()?!1:i.create(T.x)===U}catch{return!1}}function y(p,m,w={}){const{prehash:E}=Ve(w,b);return m=Bt(m,E),H.fromBytes(p,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:f,getPublicKey:g,getSharedSecret:h,utils:u,lengths:d,Point:t,sign:ce,verify:A,recoverPublicKey:y,Signature:H,hash:e})}function ms(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},r=t.Fp;let n=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(i=>Math.ceil(i/2)))):void 0;const s=se(e.n,{BITS:t.nBitLength,allowedLengths:n,modFromBytes:t.wrapPrivateKey}),o={Fp:r,Fn:s,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:o}}function hs(t){const{CURVE:e,curveOpts:r}=ms(t),n={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:r,hash:t.hash,ecdsaOpts:n}}function gs(t,e){const r=e.Point;return Object.assign({},e,{ProjectivePoint:r,CURVE:Object.assign({},t,rr(r.Fn.ORDER,r.Fn.BITS))})}function ps(t){const{CURVE:e,curveOpts:r,hash:n,ecdsaOpts:s}=hs(t),o=us(e,r),i=ds(o,n,s);return gs(t,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function ys(t,e){const r=n=>ps({...t,hash:n});return{...r(e),create:r}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ct={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},ws={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},bs=BigInt(0),An=BigInt(1),rn=BigInt(2);function Es(t){const e=Ct.p,r=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),c=BigInt(44),l=BigInt(88),f=t*t*t%e,g=f*f*t%e,h=Y(g,r,e)*g%e,u=Y(h,r,e)*g%e,d=Y(u,rn,e)*f%e,b=Y(d,s,e)*d%e,_=Y(b,o,e)*b%e,C=Y(_,c,e)*_%e,O=Y(C,l,e)*C%e,Mt=Y(O,c,e)*_%e,H=Y(Mt,r,e)*g%e,dt=Y(H,i,e)*b%e,it=Y(dt,n,e)*f%e,St=Y(it,rn,e);if(!be.eql(be.sqr(St),t))throw new Error("Cannot find square root");return St}const be=se(Ct.p,{sqrt:Es}),dn=ys({...Ct,Fp:be,lowS:!0,endo:ws},pe),Cn={};function Ee(t,...e){let r=Cn[t];if(r===void 0){const n=pe(ke(t));r=X(n,n),Cn[t]=r}return pe(X(r,...e))}const mn=t=>t.toBytes(!0).slice(1),$t=dn.Point,hn=t=>t%rn===bs;function sn(t){const{Fn:e,BASE:r}=$t,n=Et(e,t),s=r.multiply(n);return{scalar:hn(s.y)?n:e.neg(n),bytes:mn(s)}}function dr(t){const e=be;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x â‰¥ p");const r=e.create(t*t),n=e.create(r*t+BigInt(7));let s=e.sqrt(n);hn(s)||(s=e.neg(s));const o=$t.fromAffine({x:t,y:s});return o.assertValidity(),o}const qt=Ot;function mr(...t){return $t.Fn.create(qt(Ee("BIP0340/challenge",...t)))}function Ln(t){return sn(t).bytes}function vs(t,e,r=Re(32)){const{Fn:n}=$t,s=P("message",t),{bytes:o,scalar:i}=sn(e),c=P("auxRand",r,32),l=n.toBytes(i^qt(Ee("BIP0340/aux",c))),f=Ee("BIP0340/nonce",l,o,s),{bytes:g,scalar:h}=sn(f),u=mr(g,o,s),d=new Uint8Array(64);if(d.set(g,0),d.set(n.toBytes(n.create(h+u*i)),32),!hr(d,s,o))throw new Error("sign: Invalid signature produced");return d}function hr(t,e,r){const{Fn:n,BASE:s}=$t,o=P("signature",t,64),i=P("message",e),c=P("publicKey",r,32);try{const l=dr(qt(c)),f=qt(o.subarray(0,32));if(!en(f,An,Ct.p))return!1;const g=qt(o.subarray(32,64));if(!en(g,An,Ct.n))return!1;const h=mr(n.toBytes(f),mn(l),i),u=s.multiplyUnsafe(g).add(l.multiplyUnsafe(n.neg(h))),{x:d,y:b}=u.toAffine();return!(u.is0()||!hn(b)||d!==f)}catch{return!1}}const gr=(()=>{const r=(s=Re(48))=>ir(s,Ct.n);dn.utils.randomSecretKey;function n(s){const o=r(s);return{secretKey:o,publicKey:Ln(o)}}return{keygen:n,getPublicKey:Ln,sign:vs,verify:hr,Point:$t,utils:{randomSecretKey:r,randomPrivateKey:r,taggedHash:Ee,lift_x:dr,pointToBytes:mn,numberToBytesBE:Ie,bytesToNumberBE:Ot,mod:F},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),v=t=>document.getElementById(t),a={settings:null,currentRoom:"#test",rooms:[],roomCounts:{},attachments:[],maxImageKB:300,maxPayloadKB:450,peers:new Map,sessions:new Map,pendingOffers:new Map,lastRelayNotice:"",lastRelayDetail:"",pendingRelayDetail:!1,relayPollId:null,relayItems:[],messagePollId:null,lastMessageId:new Map},st=new Map,ve=new Map,On=new Set;let Ne="echochan-web";const Ut=new Map,gn=async(t,e)=>(Ut.has(t)||Ut.set(t,new Set),Ut.get(t).add(e),()=>{var r;return(r=Ut.get(t))==null?void 0:r.delete(e)});function on(t,e){const r=Ut.get(t);r&&r.forEach(n=>n({payload:e}))}const j=async(t,e={})=>{switch(t){case"get_state":return Ks();case"save_settings":return zs(e.settings);case"add_room":return Zs(e.room);case"remove_room":return Vs(e.room);case"get_room_messages":return js(e.room);case"connect_relays":return Ds();case"send_message":return Ys(e.message);case"send_signal":return Fs(e.signal);case"check_tor":throw new Error("Tor is not supported in the web build.");default:throw new Error(`Unknown command: ${t}`)}},$n=v("room-list"),je=v("command-input"),Q=v("message-input"),xt=v("messages"),Tn=v("inline-previews"),xs=v("relay-status"),te=v("current-room"),_s=v("connect-btn"),Ss=v("send-btn"),Bs=v("attach-btn"),De=v("p2p-btn"),ks=v("settings-btn"),lt=v("settings-modal"),fe=lt==null?void 0:lt.querySelector(".modal-content"),Rs=v("settings-close"),Is=v("settings-save"),Ye=v("relay-test"),Fe=v("relay-defaults"),Ge=v("tor-check"),We=v("relay-prune"),de=v("relay-status-list"),ee=v("confirm-modal"),Ns=v("confirm-title"),As=v("confirm-body"),pr=v("confirm-ok"),Cs=v("confirm-cancel"),It=v("nick-input"),G=v("relay-input"),Pt=v("stun-input"),Kt=v("turn-input"),zt=v("turn-username"),Zt=v("turn-password"),ht=v("max-image-kb"),gt=v("max-payload-kb"),Vt=v("supabase-upload-toggle"),jt=v("supabase-url"),Dt=v("supabase-anon-key"),Yt=v("supabase-bucket"),Ft=v("tor-toggle"),Gt=v("proxy-input"),Wt=v("max-p2p-mb"),Jt=v("p2p-timeout"),Xt=v("p2p-recent-min"),Qt=v("p2p-max-sessions"),cn=v("file-input"),vt=v("p2p-file-input"),ot=v("target-select");v("p2p-inbox");const Ht=v("relay-errors"),Ls=v("toast-stack"),Ae=v("image-viewer"),yr=v("viewer-image"),Je=v("sidebar-toggle"),Xe=v("sidebar-overlay"),Mn=16*1024,Os=44;let me=null;const wr=["wss://relay.damus.io","wss://nos.lol","wss://relay.nostr.net","wss://relay.nos.social","wss://www.nostr.ltd"];function pt(t,e="info",r=6e3){if(!t)return;const n=document.createElement("div");n.className=`toast ${e==="error"?"error":""}`.trim(),n.textContent=t,Ls.appendChild(n),setTimeout(()=>{n.remove()},r)}function Ce(t){const e=[];for(const r of t){const n=String(r||"").trim();if(!n)continue;const o=n.split(/\s+/)[0].replace(/[;,]+$/,"");o.startsWith("wss://")&&e.push(o)}return e}function D(t){const e=String(t||"").trim();return e?e.startsWith("#")?e:`#${e}`:""}function pn(t){const e=[],r=new Set;for(const n of t||[]){const s=D(n);s&&!r.has(s)&&(r.add(s),e.push(s))}return e}function Hn(){return{nick:"Anonymous",relays:[...wr],rooms:["#echo"],max_image_kb:40,max_payload_kb:80,supabase_upload:!1,supabase_url:"",supabase_anon_key:"",supabase_bucket:"echochan-images",stun_urls:["stun:stun.l.google.com:19302"],turn_urls:[],turn_username:"",turn_password:"",max_p2p_mb:5,p2p_timeout_sec:15,p2p_recent_minutes:10,p2p_max_sessions:2,nostr_pubkey:"",nostr_privkey:"",client_id:"",use_tor:!1,proxy_url:""}}function $s(){const t=dn.utils.randomPrivateKey(),e=gr.getPublicKey(t);return{priv:W(t),pub:W(e)}}function br(t){if(!t.nostr_privkey||!t.nostr_pubkey){const e=$s();t.nostr_privkey=e.priv,t.nostr_pubkey=e.pub}t.client_id=t.nostr_pubkey}function Ts(){const t=localStorage.getItem("echochan_settings");let e=Hn();if(t)try{e={...e,...JSON.parse(t)}}catch{e=Hn()}return e.relays=Ce(e.relays||[]),e.rooms=pn(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),br(e),e}function Le(t){localStorage.setItem("echochan_settings",JSON.stringify(t))}function Er(t){return`echochan-${(t||"").slice(0,8)||"web"}`}function Ms(t){const e=JSON.stringify(t.attachments||[]),r=`${t.room}${t.nick}${t.ts}${t.text}${e}`,n=zn(ke(r));return W(n)}function Hs(t,e,r,n,s){const o=JSON.stringify([0,t,e,r,n,s]),i=zn(ke(o));return W(i)}async function vr(t,e,r,n,s){const o=t.nostr_pubkey,i=Hs(o,s,e,r,n),c=await gr.sign(Nt(i),Nt(t.nostr_privkey)),l=W(c);return{id:i,pubkey:o,created_at:s,kind:e,tags:r,content:n,sig:l}}function yn(t){return t.trim().replace(/^#/,"")}function xr(){const e=(a.settings.rooms||[]).map(n=>yn(n));return e.length?JSON.stringify(["REQ",Ne,{kinds:[1,42],"#t":e}]):null}function Us(){return JSON.stringify(["CLOSE",Ne])}function nt(){const t=Array.from(st.values()).map(s=>({url:s.url,state:s.status,last_error:s.lastError||null})),e=t.filter(s=>s.state==="connected").length,r=t.filter(s=>s.state==="error").length,n={total:t.length,connected:e,errors:r,items:t};return on("relay-status",n),n}function qs(){var r;const t=Ce(a.settings.relays||[]),e=new Set(t);for(const[n,s]of st.entries())e.has(n)||((r=s.ws)==null||r.close(),st.delete(n));for(const n of t)st.has(n)||st.set(n,{url:n,status:"connecting",lastError:null,backoff:1e3,ws:null,timer:null}),_r(n);return nt()}function _r(t){const e=st.get(t);if(e&&!(e.ws&&(e.ws.readyState===WebSocket.OPEN||e.ws.readyState===WebSocket.CONNECTING))){e.status="connecting",e.lastError=null,nt();try{const r=new WebSocket(t);e.ws=r,r.onopen=()=>{e.status="connected",e.lastError=null,e.backoff=1e3;const n=xr();n&&r.send(n),nt()},r.onmessage=n=>{typeof n.data=="string"&&Ps(n.data,t)},r.onerror=()=>{e.status="error",e.lastError=e.lastError||"WebSocket error",nt()},r.onclose=()=>{e.status="reconnecting",nt();const n=Math.min(e.backoff,3e4);e.backoff=Math.min(e.backoff*2,3e4),clearTimeout(e.timer),e.timer=setTimeout(()=>_r(t),n)}}catch(r){e.status="error",e.lastError=String(r),nt()}}}function xe(t){st.forEach(e=>{e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(t)})}function wn(){const t=Us();xe(t);const e=xr();e&&xe(e)}function Ps(t,e){let r;try{r=JSON.parse(t)}catch{return}if(!Array.isArray(r)||!r.length)return;const n=r[0];if(n==="NOTICE"){const l=r[1]||"",f=st.get(e);f&&(f.lastError=l||"NOTICE",f.status=f.status==="connected"?"connected":"error",nt());return}if(n==="OK"){if(!(r[2]!==!1)){const f=r[3]||"event rejected",g=st.get(e);g&&(g.lastError=f,nt())}return}if(n!=="EVENT"||r.length<3)return;const s=r[2];if(!s||s.kind!==1&&s.kind!==42)return;let o;try{o=JSON.parse(s.content)}catch{return}if(!o||typeof o!="object")return;if(o.type==="signal"){const l={type:"signal",room:D(o.room||"")||Un(s.tags),from:o.from||s.pubkey,to:o.to||null,sid:o.sid,kind:o.kind,sdp:o.sdp||null,candidate:o.candidate||null,ts:o.ts||s.created_at*1e3};on("signal-message",l);return}if(o.type!=="message")return;const i=D(o.room||"")||Un(s.tags);if(!i)return;const c={type:"message",room:i,nick:o.nick||`npub:${(s.pubkey||"").slice(0,8)}`,client_id:o.client_id||s.pubkey,ts:Number(s.created_at||0)*1e3||Date.now(),text:o.text||"",attachments:Array.isArray(o.attachments)?o.attachments:[],id:o.id||s.id,action:!!o.action};Sr(c)&&on("new-message",c)}function Un(t=[]){for(const e of t)if(e&&e[0]==="t"&&e[1])return D(e[1]);return""}function Sr(t){if(!t||!t.id||On.has(t.id))return!1;On.add(t.id);const e=ve.get(t.room)||[];return e.push(t),e.length>500&&e.shift(),ve.set(t.room,e),!0}async function Ks(){const t={};return ve.forEach((e,r)=>{t[r]=e.length}),{settings:a.settings,counts:t,relay_summary:nt()}}async function zs(t){const e={...a.settings,...t};e.relays=Ce(e.relays||[]),e.rooms=pn(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),br(e),a.settings=e,Ne=Er(e.nostr_pubkey),Le(e),wn()}async function Zs(t){const e=D(t);e&&(a.settings.rooms.includes(e)||(a.settings.rooms.push(e),Le(a.settings),wn()))}async function Vs(t){const e=D(t);if(e){if(a.settings.rooms.length<=1)throw new Error("At least one room must remain.");a.settings.rooms=a.settings.rooms.filter(r=>r!==e),Le(a.settings),wn()}}async function js(t){const e=D(t);return ve.get(e)||[]}async function Ds(){return qs()}async function Ys(t){var c;if(((c=t.attachments)==null?void 0:c.length)>2)throw new Error("Only 2 inline images allowed.");const e=D(t.room),r={room:e,type:"message",nick:t.nick||"Anonymous",client_id:a.settings.nostr_pubkey,ts:Date.now(),text:t.text||"",attachments:t.attachments||[],id:"",action:!!t.action};r.id=Ms(r);const n=JSON.stringify(r),s=[["t",yn(e)]],o=await vr(a.settings,1,s,n,Math.floor(r.ts/1e3)),i=JSON.stringify(["EVENT",o]);if(i.length>(a.settings.max_payload_kb||450)*1024)throw new Error("Payload exceeds max_payload_kb limit.");return Sr(r)&&xe(i),r}async function Fs(t){const e={type:"signal",room:D(t.room),from:t.from||a.settings.nostr_pubkey,to:t.to||null,sid:t.sid,kind:t.kind,sdp:t.sdp||null,candidate:t.candidate||null,ts:Date.now()},r=JSON.stringify(e),n=[["t",yn(e.room)]],s=await vr(a.settings,1,n,r,Math.floor(e.ts/1e3)),o=JSON.stringify(["EVENT",s]);xe(o)}function Oe(){return Date.now()}function M(t){xs.textContent=t}function Br({title:t,body:e,okText:r}){return new Promise(n=>{me=n,Ns.textContent=t||"Confirm",As.textContent=e||"Are you sure?",pr.textContent=r||"OK",ee.classList.remove("hidden")})}function $e(t){me&&(me(t),me=null),ee.classList.add("hidden")}function _e(){Q.style.height="auto";const t=Math.max(Q.scrollHeight,Os);Q.style.height=`${t}px`}function Gs(t){const e=new Date(t);return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}function Ws(t){if(!t)return"";const e=[/(?:https?:\/\/)?(?:www\.)?youtu\.be\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/i];for(const r of e){const n=t.match(r);if(n&&n[1])return n[1]}return""}function Js(t){if(!t)return null;const e=/(?:https?:\/\/)?open\.spotify\.com\/(track|album|playlist|episode|show)\/([A-Za-z0-9]+)(?:\?[^ \n]*)?/i,r=t.match(e);return r?{type:r[1],id:r[2]}:null}function Xs(t){if(!t)return"";const e=t.match(/https?:\/\/music\.yandex\.ru\/iframe\/#([A-Za-z0-9/_-]+)/i);if(e&&e[1])return`https://music.yandex.ru/iframe/#${e[1]}`;const r=t.match(/https?:\/\/music\.yandex\.ru\/album\/(\d+)\/track\/(\d+)/i);if(r){const s=r[1];return`https://music.yandex.ru/iframe/#track/${r[2]}/${s}`}const n=t.match(/https?:\/\/music\.yandex\.ru\/track\/(\d+)/i);return n?`https://music.yandex.ru/iframe/#track/${n[1]}`:""}function Qs(){const t=new Uint8Array(12);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}function ft(){$n.innerHTML="",a.rooms.forEach(t=>{const e=document.createElement("div");e.className="room"+(t===a.currentRoom?" active":"");const r=document.createElement("span");r.textContent=t;const n=document.createElement("span");n.className="count",n.textContent=a.roomCounts[t]||0;const s=document.createElement("button");s.className="room-remove",s.textContent="Ã—",s.title="Remove room",s.addEventListener("click",async o=>{if(o.stopPropagation(),a.rooms.length<=1){M("At least one room must remain.");return}await Br({title:"Remove room",body:`Remove room ${t}?`,okText:"Remove"})&&(await j("remove_room",{room:t}),a.rooms=a.rooms.filter(c=>c!==t),a.currentRoom===t&&(a.currentRoom=a.rooms[0],te.textContent=a.currentRoom,await ne(a.currentRoom)),ft(),ut(`Left ${t}.`))}),e.append(r,n,s),e.addEventListener("click",async()=>{document.body.classList.remove("sidebar-open"),a.currentRoom=t,te.textContent=t,ft(),await ne(t)}),$n.appendChild(e)})}function kr(){if(!ot)return;ot.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="All",ot.appendChild(t);const e=Array.from(a.peers.values()).sort((r,n)=>r.nick.localeCompare(n.nick));for(const r of e){const n=document.createElement("option");n.value=r.id,n.textContent=`${r.nick} Â· ${r.id.slice(0,8)}`,ot.appendChild(n)}}function to(t){if(xt.innerHTML="",!t.length){const r=document.createElement("div");r.className="empty-state",r.textContent="No messages yet. Try /join #room or type a message.",xt.appendChild(r)}const e=[...t].sort((r,n)=>{const s=Number((r==null?void 0:r.ts)||0),o=Number((n==null?void 0:n.ts)||0);if(s!==o)return s-o;const i=String((r==null?void 0:r.id)||""),c=String((n==null?void 0:n.id)||"");return i.localeCompare(c)});if(e.forEach(r=>oe(r)),Tt(),e.length){const r=e[e.length-1];r&&r.id&&a.lastMessageId.set(a.currentRoom,r.id)}}function Tt(){requestAnimationFrame(()=>{xt.scrollTop=xt.scrollHeight})}function ut(t){const e={nick:"system",ts:Oe(),text:t,action:!1,attachments:[],system:!0};oe(e),Tt()}function oe(t){const e=document.createElement("div");e.className=t.system?"message system":"message";const r=xt.querySelector(".empty-state");r&&r.remove();const n=document.createElement("div");n.className=t.attachments&&t.attachments.length?"message-body has-media":"message-body";const s=document.createElement("div");s.className="meta",s.textContent=`${t.nick} Â· ${Gs(t.ts)}`;const o=document.createElement("div");o.className="text",o.textContent=t.action?`* ${t.nick} ${t.text}`:t.text;const i=document.createElement("div");i.className="message-content",i.append(s,o),n.appendChild(i);const c=Ws(t.text);if(c){const g=document.createElement("div");g.className="youtube-embed";const h=document.createElement("iframe");h.src=`https://www.youtube-nocookie.com/embed/${c}`,h.title="YouTube video",h.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",h.referrerPolicy="origin-when-cross-origin",h.allowFullscreen=!0,g.appendChild(h),n.appendChild(g)}const l=Js(t.text);if(l){const g=document.createElement("div");g.className="spotify-embed";const h=document.createElement("iframe");h.src=`https://open.spotify.com/embed/${l.type}/${l.id}`,h.title="Spotify",h.allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture",h.loading="lazy",h.referrerPolicy="origin-when-cross-origin",g.appendChild(h),n.appendChild(g)}const f=Xs(t.text);if(f){const g=document.createElement("div");g.className="yandex-embed";const h=document.createElement("iframe");h.src=f,h.title="Yandex Music",h.allow="autoplay; clipboard-write; encrypted-media",h.loading="lazy",h.referrerPolicy="origin-when-cross-origin",g.appendChild(h),n.appendChild(g)}if(t.attachments&&t.attachments.length){const g=document.createElement("div");g.className="attachments",t.attachments.forEach(h=>{const u=document.createElement("img");u.src=h.data,u.alt="attachment",u.addEventListener("click",()=>eo(h.data)),g.appendChild(u)}),n.insertBefore(g,i)}e.appendChild(n),xt.appendChild(e),t&&t.id&&a.lastMessageId.set(t.room||a.currentRoom,t.id)}function eo(t){t&&(yr.src=t,Ae.classList.remove("hidden"))}function Rr(){Ae.classList.add("hidden"),yr.src=""}function Ir(){Tn.innerHTML="",a.attachments.forEach(t=>{const e=document.createElement("img");e.src=t.data,Tn.appendChild(e)})}function no(t){const e=JSON.stringify(t);return new TextEncoder().encode(e).length/1024}async function ro(){var r,n;a.settings=Ts(),a.settings.nick==="Echidna"&&(a.settings.nick="Anonymous",Le(a.settings)),Ne=Er(a.settings.nostr_pubkey);const t=await j("get_state",{});a.settings=t.settings;const e=pn(t.settings.rooms);a.rooms=e,a.roomCounts=t.counts||{},a.currentRoom=a.rooms[0]||"#test",a.maxImageKB=t.settings.max_image_kb,a.maxPayloadKB=t.settings.max_payload_kb,It&&(It.value=t.settings.nick),G&&(G.value=t.settings.relays.join(`
`)),ht&&(ht.value=t.settings.max_image_kb),gt&&(gt.value=t.settings.max_payload_kb),Vt&&(Vt.checked=!!t.settings.supabase_upload),jt&&(jt.value=t.settings.supabase_url||""),Dt&&(Dt.value=t.settings.supabase_anon_key||""),Yt&&(Yt.value=t.settings.supabase_bucket||"echochan-images"),Pt&&(Pt.value=((r=t.settings.stun_urls)==null?void 0:r.join(`
`))||""),Ft&&(Ft.checked=t.settings.use_tor||!1),Gt&&(Gt.value=t.settings.proxy_url||""),Kt&&(Kt.value=((n=t.settings.turn_urls)==null?void 0:n.join(`
`))||""),zt&&(zt.value=t.settings.turn_username||""),Zt&&(Zt.value=t.settings.turn_password||""),Wt&&(Wt.value=t.settings.max_p2p_mb||5),Jt&&(Jt.value=t.settings.p2p_timeout_sec||15),Xt&&(Xt.value=t.settings.p2p_recent_minutes||10),Qt&&(Qt.value=t.settings.p2p_max_sessions||2),te.textContent=a.currentRoom,ft(),ot&&kr(),await ne(a.currentRoom),Te(t.relay_summary),JSON.stringify(e)!==JSON.stringify(t.settings.rooms)&&(a.settings.rooms=e,await j("save_settings",{settings:a.settings})),ut(`Relays configured: ${a.settings.relays.length}`),so()}function so(){a.relayPollId||(a.relayPollId=setInterval(async()=>{try{const t=await j("get_state",{});t&&t.relay_summary&&Te(t.relay_summary)}catch{}},4e3))}function Te(t){if(!t)return;const e=t.total??(t.items?t.items.length:0),r=t.connected??0,n=t.errors??0;a.relayItems=t.items||[],e>0&&r===0&&n===0?M(`Connecting to ${e} relays...`):r>0?M(`Connected to ${r}/${e} relays, ${n} errors`):M(`Connected to 0 relays, ${n} errors`),co(t.items||[]),ao(t.items||[]),oo(t),a.pendingRelayDetail&&io(t)}function oo(t){const e=[];t.total===0?e.push("No relays configured. Open Settings and add wss:// relays."):t.connected===0&&e.push("No relay connections yet. Check relay errors in Settings.");const r=(t.items||[]).filter(s=>s.last_error);if(r.length)for(const s of r)s.last_error?e.push(`${s.url} error: ${s.last_error}`):e.push(`${s.url} error`);if(!e.length)return;const n=e.join(" ");n!==a.lastRelayNotice&&(a.lastRelayNotice=n,pt(n,"error"))}function io(t){const e=t.items||[];if(!e.length)return;const n=`Relay status: ${e.map(s=>s.last_error?`${s.state}: ${s.url} (${s.last_error})`:`${s.state}: ${s.url}`).join(" | ")}`;n!==a.lastRelayDetail&&(a.lastRelayDetail=n,pt(n,"info",5e3),a.pendingRelayDetail=!1)}function co(t){const e=fe&&!lt.classList.contains("hidden"),r=e?fe.scrollTop:0;if(de){if(de.innerHTML="",!t.length){const n=document.createElement("div");n.textContent="No relay status yet. Click Test relays.",de.appendChild(n),e&&(fe.scrollTop=r);return}t.forEach(n=>{const s=document.createElement("div");s.className="relay-status-item";const o=document.createElement("div");o.textContent=n.url;const i=document.createElement("div");i.className=`state ${n.state}`,i.textContent=n.state;const c=document.createElement("button");if(c.textContent="Remove",c.addEventListener("click",async()=>{const l=a.settings.relays.filter(f=>f!==n.url);if(!l.length){M("At least one relay must remain.");return}G.value=l.join(`
`),await He({close:!1})}),s.append(o,i,c),n.last_error){const l=document.createElement("div");l.className="error",l.textContent=n.last_error,s.appendChild(l)}de.appendChild(s)}),e&&(fe.scrollTop=r)}}function ao(t){const e=t.filter(n=>n.last_error);if(Ht.innerHTML="",!e.length){Ht.classList.add("hidden");return}Ht.classList.remove("hidden");const r=document.createElement("div");r.className="title",r.textContent="Relay errors",Ht.appendChild(r),e.forEach(n=>{const s=document.createElement("div");s.className="item",s.textContent=n.last_error?`${n.url} â€” ${n.last_error}`:`${n.url} â€” error`,Ht.appendChild(s)})}async function ne(t){const e=await j("get_room_messages",{room:t});a.roomCounts[t]=e.length,to(e),$r(e),ft()}async function Me(){var t;if(M("Connecting..."),pt("Connecting to relays...","info",3e3),(t=a.settings)!=null&&t.use_tor){const e=a.settings.proxy_url||"socks5://127.0.0.1:9150";pt(`Using SOCKS5 proxy: ${e}`,"info",4e3)}a.pendingRelayDetail=!0;try{const e=await j("connect_relays",{});Te(e);const r=e.total??(e.items?e.items.length:0),n=e.connected??0,s=e.errors??0;r>0&&n===0&&s===0?pt("Connecting to chat...","info",3e3):pt("Connected to chat.","info",3e3)}catch(e){M(String(e)),pt(String(e),"error",5e3)}}async function Nr(t){const e=t.trim();if(e){if(e.startsWith("/join ")){const r=D(e.replace("/join","").trim());if(!r)return;a.rooms.includes(r)||(a.rooms.push(r),ft(),await j("add_room",{room:r})),a.currentRoom=r,te.textContent=r,ut(`Joined ${r}.`),await ne(r);return}if(e.startsWith("/leave ")){const r=D(e.replace("/leave","").trim());if(!r)return;if(a.rooms.length<=1){M("At least one room must remain.");return}if(!a.rooms.includes(r)){M("Room not found.");return}await j("remove_room",{room:r}),a.rooms=a.rooms.filter(n=>n!==r),a.currentRoom===r&&(a.currentRoom=a.rooms[0],te.textContent=a.currentRoom,await ne(a.currentRoom)),ft(),ut(`Left ${r}.`);return}if(e.startsWith("/nick ")){const r=e.replace("/nick","").trim();if(!r)return;a.settings.nick=r,It.value=r,await j("save_settings",{settings:a.settings}),ut(`Nick changed to ${r}.`);return}}}async function Ar(t){const e=t.trim();if(!e)return;if(e.startsWith("/join ")||e.startsWith("/nick ")||e.startsWith("/leave ")){await Nr(e),Q.value="",_e();return}let r=!1,n=e;e.startsWith("/me ")&&(r=!0,n=e.replace("/me","").trim());const s={type:"message",room:D(a.currentRoom),nick:a.settings.nick,ts:Date.now(),text:n,attachments:a.attachments,id:"0".repeat(64),action:r};if(no(s)>a.maxPayloadKB){M(`Payload exceeds ${a.maxPayloadKB}KB limit.`);return}try{const o=await j("send_message",{message:{room:D(a.currentRoom),nick:a.settings.nick,text:n,attachments:a.attachments,action:r}});a.attachments=[],Ir(),Q.value="",_e(),a.roomCounts[a.currentRoom]=(a.roomCounts[a.currentRoom]||0)+1,oe(o),ft(),Tt()}catch(o){M(String(o))}}async function lo(t,e,r){const n=await createImageBitmap(t),s=Math.max(n.width,n.height),o=Math.min(1,e/s),i=[1,.9,.8,.7,.6],c=[.75,.6,.45,.3],l=document.createElement("canvas"),f=l.getContext("2d");for(const g of i){const h=o*g,u=Math.max(1,Math.round(n.width*h)),d=Math.max(1,Math.round(n.height*h));l.width=u,l.height=d,f.clearRect(0,0,u,d),f.drawImage(n,0,0,u,d);for(const b of c){const _=l.toDataURL("image/webp",b),C=_.split(",")[1]||"",O=Math.floor(C.length*.75);if(O<=r*1024)return{kind:"inline",mime:"image/webp",data:_,w:u,h:d,size:O}}}throw new Error("Image too large after compression.")}async function uo(t,e){const r=a.settings.supabase_url,n=a.settings.supabase_anon_key,s=a.settings.supabase_bucket;if(!r||!n||!s)throw new Error("Supabase upload is enabled but credentials are missing.");const o=(t.split(",")[1]||"").trim();if(!o)throw new Error("Invalid image data.");const i=Uint8Array.from(atob(o),h=>h.charCodeAt(0)),c=String(e).replace(/[^\w.-]+/g,"_"),l=`uploads/${Date.now()}_${Math.random().toString(16).slice(2)}_${c}.webp`,f=`${r}/storage/v1/object/${s}/${l}`,g=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${n}`,apikey:n,"Content-Type":"image/webp","x-upsert":"true"},body:i});if(!g.ok){const h=await g.text();throw new Error(`Supabase upload failed: ${g.status} ${h}`)}return`${r}/storage/v1/object/public/${s}/${l}`}async function Cr(t){for(const e of t){if(a.attachments.length>=2){M("Only 2 inline images allowed.");break}try{const r=await lo(e,1280,a.maxImageKB);if(a.settings.supabase_upload){M("Uploading image...");const n=await uo(r.data,e.name||"image");a.attachments.push({kind:"link",mime:r.mime,data:n,w:r.w,h:r.h,size:r.size}),M("Image uploaded.")}else a.attachments.push(r);Ir()}catch(r){M(String(r))}}}function fo(){lt.classList.remove("hidden")}function bn(){lt.classList.add("hidden")}async function He({close:t=!0}={}){const e=Ce(((G==null?void 0:G.value)||"").split(`
`)),r=((Pt==null?void 0:Pt.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length),n=((Kt==null?void 0:Kt.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length);a.settings.nick=(It==null?void 0:It.value.trim())||a.settings.nick,a.settings.relays=e,G&&(G.value=e.join(`
`));const s=Number(ht==null?void 0:ht.value)||a.maxImageKB,o=Number(gt==null?void 0:gt.value)||a.maxPayloadKB;a.settings.max_image_kb=Math.max(20,Math.min(80,s)),a.settings.max_payload_kb=Math.max(60,Math.min(200,o)),a.settings.supabase_upload=!!(Vt!=null&&Vt.checked),a.settings.supabase_url=(jt==null?void 0:jt.value.trim())||"",a.settings.supabase_anon_key=(Dt==null?void 0:Dt.value.trim())||"",a.settings.supabase_bucket=(Yt==null?void 0:Yt.value.trim())||"echochan-images",ht&&(ht.value=String(a.settings.max_image_kb)),gt&&(gt.value=String(a.settings.max_payload_kb)),a.settings.stun_urls=r,a.settings.use_tor=(Ft==null?void 0:Ft.checked)||!1,a.settings.proxy_url=(Gt==null?void 0:Gt.value.trim())||"",a.settings.turn_urls=n,a.settings.turn_username=(zt==null?void 0:zt.value)||"",a.settings.turn_password=(Zt==null?void 0:Zt.value)||"",a.settings.max_p2p_mb=Number(Wt==null?void 0:Wt.value)||5,a.settings.p2p_timeout_sec=Number(Jt==null?void 0:Jt.value)||15,a.settings.p2p_recent_minutes=Number(Xt==null?void 0:Xt.value)||10,a.settings.p2p_max_sessions=Number(Qt==null?void 0:Qt.value)||2,a.maxImageKB=a.settings.max_image_kb,a.maxPayloadKB=a.settings.max_payload_kb,await j("save_settings",{settings:a.settings}),t&&bn(),await Me()}function Lr(){const t=[];return a.settings.stun_urls&&a.settings.stun_urls.length&&t.push({urls:a.settings.stun_urls}),a.settings.turn_urls&&a.settings.turn_urls.length&&t.push({urls:a.settings.turn_urls,username:a.settings.turn_username||void 0,credential:a.settings.turn_password||void 0}),{iceServers:t}}function Or(){return a.sessions.size}function mo(t){const e=a.peers.get(t);return e?Oe()-e.lastSeen<=(a.settings.p2p_recent_minutes||10)*60*1e3:!1}function $r(t){if(ot){for(const e of t){if(!e.client_id)continue;const r=e.client_id,n=a.peers.get(r),s=e.nick||r.slice(0,8),o=e.ts||Oe();(!n||n.lastSeen<o)&&a.peers.set(r,{id:r,nick:s,lastSeen:o})}kr()}}function Tr(t,e){const r=a.settings.p2p_timeout_sec||15,n={sid:t,mode:e,pc:null,dc:null,meta:null,receivedChunks:[],receivedBytes:0,expectedSize:0,timeout:null};return n.timeout=setTimeout(()=>{Lt(t,"P2P failed (timeout). Use inline instead.")},r*1e3),a.sessions.set(t,n),n}function Lt(t,e){const r=a.sessions.get(t);r&&(clearTimeout(r.timeout),r.dc&&r.dc.close(),r.pc&&r.pc.close(),a.sessions.delete(t),e&&M(e))}async function Se(t,e){const r={room:a.currentRoom,from:a.settings.nostr_pubkey||"",to:e.to||null,sid:e.sid,kind:t,sdp:e.sdp||null,candidate:e.candidate||null};await j("send_signal",{signal:r})}async function ho(t){if(Or()>=(a.settings.p2p_max_sessions||2)){M("P2P session limit reached.");return}if(t.size>(a.settings.max_p2p_mb||5)*1024*1024){M("P2P file too large.");return}const e=Qs(),r=Tr(e,"send"),n=new RTCPeerConnection(Lr());r.pc=n;const s=n.createDataChannel("file");r.dc=s,s.binaryType="arraybuffer",s.onopen=async()=>{const c=await t.arrayBuffer(),l={kind:"file_meta",sid:e,name:t.name,mime:t.type||"application/octet-stream",size:t.size};s.send(JSON.stringify(l));let f=0;const g=new Uint8Array(c);for(;f<g.length;){const h=g.slice(f,f+Mn);s.send(h),f+=Mn}},s.onmessage=c=>{if(typeof c.data=="string")try{const l=JSON.parse(c.data);l.kind==="file_ack"&&l.sid===e&&Lt(e,"P2P transfer completed.")}catch{return}};const o=(ot==null?void 0:ot.value)||null;n.onicecandidate=async c=>{c.candidate&&await Se("ice",{sid:e,to:o,candidate:{candidate:c.candidate.candidate,sdpMid:c.candidate.sdpMid,sdpMLineIndex:c.candidate.sdpMLineIndex}})};const i=await n.createOffer();await n.setLocalDescription(i),await Se("offer",{sid:e,to:o,sdp:i.sdp})}function go(t){const e=document.createElement("div");e.className="p2p-card";const r=document.createElement("div");r.textContent=`Incoming P2P image from ${t.from.slice(0,8)}`;const n=document.createElement("div");n.className="actions";const s=document.createElement("button");s.textContent="Accept";const o=document.createElement("button");o.textContent="Decline",n.append(s,o),e.append(r,n);const i=document.createElement("div");i.className="message system";const c=document.createElement("div");c.className="message-body",c.appendChild(e),i.appendChild(c),xt.appendChild(i),Tt(),s.addEventListener("click",async()=>{i.remove(),await po(t)}),o.addEventListener("click",()=>{i.remove(),Lt(t.sid,"P2P declined.")})}async function po(t){if(Or()>=(a.settings.p2p_max_sessions||2)){M("P2P session limit reached.");return}if(!mo(t.from)&&!await Br({title:"Unverified sender",body:"Sender has not spoken recently in this room. Accept anyway?",okText:"Accept"})){Lt(t.sid,"P2P declined.");return}const e=t.sid,r=Tr(e,"recv"),n=new RTCPeerConnection(Lr());r.pc=n,n.ondatachannel=o=>{const i=o.channel;r.dc=i,i.binaryType="arraybuffer",i.onmessage=c=>yo(r,t.from,c.data)},n.onicecandidate=async o=>{o.candidate&&await Se("ice",{sid:e,to:t.from,candidate:{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex}})},await n.setRemoteDescription({type:"offer",sdp:t.sdp});const s=await n.createAnswer();await n.setLocalDescription(s),await Se("answer",{sid:e,to:t.from,sdp:s.sdp})}function yo(t,e,r){if(typeof r=="string"){try{const s=JSON.parse(r);s.kind==="file_meta"&&s.sid===t.sid&&(t.meta=s,t.expectedSize=s.size,s.size>(a.settings.max_p2p_mb||5)*1024*1024&&Lt(t.sid,"P2P file too large."))}catch{return}return}if(!t.meta)return;const n=new Uint8Array(r);if(t.receivedChunks.push(n),t.receivedBytes+=n.byteLength,t.receivedBytes>=t.expectedSize){const s=new Blob(t.receivedChunks,{type:t.meta.mime}),o=URL.createObjectURL(s),i={nick:e.slice(0,8),ts:Oe(),text:"[P2P image]",action:!1,attachments:[{data:o}]};oe(i),Tt(),t.dc&&t.dc.send(JSON.stringify({kind:"file_ack",sid:t.sid,ok:!0})),Lt(t.sid,null)}}async function wo(t){if(t.room!==a.currentRoom)return;if(t.kind==="offer"){if(a.pendingOffers.has(t.sid))return;a.pendingOffers.set(t.sid,t),go(t);return}const e=a.sessions.get(t.sid);if(e){if(t.kind==="answer"&&e.pc){await e.pc.setRemoteDescription({type:"answer",sdp:t.sdp});return}if(t.kind==="ice"&&e.pc&&t.candidate)try{await e.pc.addIceCandidate(t.candidate)}catch{return}}}_s.addEventListener("click",Me);ks.addEventListener("click",fo);Rs.addEventListener("click",bn);Is.addEventListener("click",He);lt.addEventListener("click",t=>{t.target===lt&&bn()});Ye==null||Ye.addEventListener("click",async()=>{await Me()});Fe==null||Fe.addEventListener("click",async()=>{G&&(G.value=wr.join(`
`)),await He({close:!1})});Ge==null||Ge.addEventListener("click",async()=>{try{const t=await j("check_tor",{});ut(t?"Tor proxy is reachable.":"Tor is disabled. Enable Use Tor to test.")}catch(t){ut(`Tor check failed: ${String(t)}`)}});We==null||We.addEventListener("click",async()=>{const t=new Set(a.relayItems.filter(r=>r.state==="error").map(r=>r.url));if(!t.size){M("No failing relays to remove.");return}const e=a.settings.relays.filter(r=>!t.has(r));if(!e.length){M("All relays would be removed.");return}G.value=e.join(`
`),await He({close:!1})});pr.addEventListener("click",()=>$e(!0));Cs.addEventListener("click",()=>$e(!1));ee.addEventListener("click",t=>{t.target===ee&&$e(!1)});Ae.addEventListener("click",()=>{Rr()});Je==null||Je.addEventListener("click",()=>{document.body.classList.toggle("sidebar-open")});Xe==null||Xe.addEventListener("click",()=>{document.body.classList.remove("sidebar-open")});Bs.addEventListener("click",()=>cn.click());De==null||De.addEventListener("click",()=>{vt==null||vt.click()});vt==null||vt.addEventListener("change",async t=>{var r;const e=(r=t.target.files)==null?void 0:r[0];e&&await ho(e),vt.value=""});cn.addEventListener("change",async t=>{const e=Array.from(t.target.files||[]);await Cr(e),cn.value=""});je.addEventListener("keydown",async t=>{t.key==="Enter"&&(await Nr(je.value),je.value="")});Ss.addEventListener("click",async()=>Ar(Q.value));Q.addEventListener("keydown",async t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),await Ar(Q.value))});Q.addEventListener("paste",async t=>{var n;const e=(n=t.clipboardData)==null?void 0:n.items;if(!e)return;const r=[];for(const s of e)if(s.kind==="file"&&s.type.startsWith("image/")){const o=s.getAsFile();o&&r.push(o)}r.length&&(t.preventDefault(),await Cr(r))});Q.addEventListener("input",_e);document.addEventListener("keydown",t=>{t.key==="Escape"&&!ee.classList.contains("hidden")&&$e(!1),t.key==="Escape"&&!Ae.classList.contains("hidden")&&Rr()});gn("new-message",t=>{const e=t.payload;!e||!e.room||(a.roomCounts[e.room]||(a.roomCounts[e.room]=0),a.roomCounts[e.room]+=1,e.room===a.currentRoom&&(oe(e),Tt(),$r([e])),ft())});gn("relay-status",t=>{Te(t.payload)});gn("signal-message",t=>{wo(t.payload).catch(()=>{})});ro().then(Me).catch(t=>M(String(t)));_e();
