(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function s(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(r){if(r.ep)return;r.ep=!0;const o=s(r);fetch(r.href,o)}})();const Rt=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Be(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function Je(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function St(t,...e){if(!Be(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function Pn(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");Je(t.outputLen),Je(t.blockLen)}function he(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function Hs(t,e){St(t);const s=e.outputLen;if(t.length<s)throw new Error("digestInto() expects output buffer of length at least "+s)}function ge(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function He(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function X(t,e){return t<<32-e|t>>>e}const Kn=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",Us=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function J(t){if(St(t),Kn)return t.toHex();let e="";for(let s=0;s<t.length;s++)e+=Us[t[s]];return e}const et={_0:48,_9:57,A:65,F:70,a:97,f:102};function _n(t){if(t>=et._0&&t<=et._9)return t-et._0;if(t>=et.A&&t<=et.F)return t-(et.A-10);if(t>=et.a&&t<=et.f)return t-(et.a-10)}function Nt(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(Kn)return Uint8Array.fromHex(t);const e=t.length,s=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(s);for(let r=0,o=0;r<s;r++,o+=2){const i=_n(t.charCodeAt(o)),a=_n(t.charCodeAt(o+1));if(i===void 0||a===void 0){const l=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}n[r]=i*16+a}return n}function ke(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function cn(t){return typeof t=="string"&&(t=ke(t)),St(t),t}function Q(...t){let e=0;for(let n=0;n<t.length;n++){const r=t[n];St(r),e+=r.length}const s=new Uint8Array(e);for(let n=0,r=0;n<t.length;n++){const o=t[n];s.set(o,r),r+=o.length}return s}class zn{}function qs(t){const e=n=>t().update(cn(n)).digest(),s=t();return e.outputLen=s.outputLen,e.blockLen=s.blockLen,e.create=()=>t(),e}function Re(t=32){if(Rt&&typeof Rt.getRandomValues=="function")return Rt.getRandomValues(new Uint8Array(t));if(Rt&&typeof Rt.randomBytes=="function")return Uint8Array.from(Rt.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function Ps(t,e,s,n){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,s,n);const r=BigInt(32),o=BigInt(4294967295),i=Number(s>>r&o),a=Number(s&o),l=n?4:0,f=n?0:4;t.setUint32(e+l,i,n),t.setUint32(e+f,a,n)}function Ks(t,e,s){return t&e^~t&s}function zs(t,e,s){return t&e^t&s^e&s}class Zs extends zn{constructor(e,s,n,r){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=s,this.padOffset=n,this.isLE=r,this.buffer=new Uint8Array(e),this.view=He(this.buffer)}update(e){he(this),e=cn(e),St(e);const{view:s,buffer:n,blockLen:r}=this,o=e.length;for(let i=0;i<o;){const a=Math.min(r-this.pos,o-i);if(a===r){const l=He(e);for(;r<=o-i;i+=r)this.process(l,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===r&&(this.process(s,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){he(this),Hs(e,this),this.finished=!0;const{buffer:s,view:n,blockLen:r,isLE:o}=this;let{pos:i}=this;s[i++]=128,ge(this.buffer.subarray(i)),this.padOffset>r-i&&(this.process(n,0),i=0);for(let y=i;y<r;y++)s[y]=0;Ps(n,r-8,BigInt(this.length*8),o),this.process(n,0);const a=He(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const f=l/4,p=this.get();if(f>p.length)throw new Error("_sha2: outputLen bigger than state");for(let y=0;y<f;y++)a.setUint32(4*y,p[y],o)}digest(){const{buffer:e,outputLen:s}=this;this.digestInto(e);const n=e.slice(0,s);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:s,buffer:n,length:r,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=r,e.pos=a,r%s&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const ut=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Vs=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ft=new Uint32Array(64);class js extends Zs{constructor(e=32){super(64,e,8,!1),this.A=ut[0]|0,this.B=ut[1]|0,this.C=ut[2]|0,this.D=ut[3]|0,this.E=ut[4]|0,this.F=ut[5]|0,this.G=ut[6]|0,this.H=ut[7]|0}get(){const{A:e,B:s,C:n,D:r,E:o,F:i,G:a,H:l}=this;return[e,s,n,r,o,i,a,l]}set(e,s,n,r,o,i,a,l){this.A=e|0,this.B=s|0,this.C=n|0,this.D=r|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=l|0}process(e,s){for(let y=0;y<16;y++,s+=4)ft[y]=e.getUint32(s,!1);for(let y=16;y<64;y++){const u=ft[y-15],d=ft[y-2],b=X(u,7)^X(u,18)^u>>>3,v=X(d,17)^X(d,19)^d>>>10;ft[y]=v+ft[y-7]+b+ft[y-16]|0}let{A:n,B:r,C:o,D:i,E:a,F:l,G:f,H:p}=this;for(let y=0;y<64;y++){const u=X(a,6)^X(a,11)^X(a,25),d=p+u+Ks(a,l,f)+Vs[y]+ft[y]|0,v=(X(n,2)^X(n,13)^X(n,22))+zs(n,r,o)|0;p=f,f=l,l=a,a=i+d|0,i=o,o=r,r=n,n=d+v|0}n=n+this.A|0,r=r+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,l=l+this.F|0,f=f+this.G|0,p=p+this.H|0,this.set(n,r,o,i,a,l,f,p)}roundClean(){ge(ft)}destroy(){this.set(0,0,0,0,0,0,0,0),ge(this.buffer)}}const pe=qs(()=>new js),Zn=pe;class Vn extends zn{constructor(e,s){super(),this.finished=!1,this.destroyed=!1,Pn(e);const n=cn(s);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const r=this.blockLen,o=new Uint8Array(r);o.set(n.length>r?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),ge(o)}update(e){return he(this),this.iHash.update(e),this}digestInto(e){he(this),St(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:s,iHash:n,finished:r,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=r,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=s._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const jn=(t,e,s)=>new Vn(t,e).update(s).digest();jn.create=(t,e)=>new Vn(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const an=BigInt(0),Xe=BigInt(1);function ye(t,e=""){if(typeof t!="boolean"){const s=e&&`"${e}"`;throw new Error(s+"expected boolean, got type="+typeof t)}return t}function wt(t,e,s=""){const n=Be(t),r=t==null?void 0:t.length,o=e!==void 0;if(!n||o&&r!==e){const i=s&&`"${s}" `,a=o?` of length ${e}`:"",l=n?`length=${r}`:`type=${typeof t}`;throw new Error(i+"expected Uint8Array"+a+", got "+l)}return t}function le(t){const e=t.toString(16);return e.length&1?"0"+e:e}function Dn(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?an:BigInt("0x"+t)}function Tt(t){return Dn(J(t))}function Yn(t){return St(t),Dn(J(Uint8Array.from(t).reverse()))}function Ae(t,e){return Nt(t.toString(16).padStart(e*2,"0"))}function Fn(t,e){return Ae(t,e).reverse()}function P(t,e,s){let n;if(typeof e=="string")try{n=Nt(e)}catch(o){throw new Error(t+" must be hex string or Uint8Array, cause: "+o)}else if(Be(e))n=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const r=n.length;if(typeof s=="number"&&r!==s)throw new Error(t+" of length "+s+" expected, got "+r);return n}const Ue=t=>typeof t=="bigint"&&an<=t;function Qe(t,e,s){return Ue(t)&&Ue(e)&&Ue(s)&&e<=t&&t<s}function Ds(t,e,s,n){if(!Qe(e,s,n))throw new Error("expected valid "+t+": "+s+" <= n < "+n+", got "+e)}function Gn(t){let e;for(e=0;t>an;t>>=Xe,e+=1);return e}const se=t=>(Xe<<BigInt(t))-Xe;function Ys(t,e,s){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof s!="function")throw new Error("hmacFn must be a function");const n=d=>new Uint8Array(d),r=d=>Uint8Array.of(d);let o=n(t),i=n(t),a=0;const l=()=>{o.fill(1),i.fill(0),a=0},f=(...d)=>s(i,o,...d),p=(d=n(0))=>{i=f(r(0),d),o=f(),d.length!==0&&(i=f(r(1),d),o=f())},y=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const b=[];for(;d<e;){o=f();const v=o.slice();b.push(v),d+=o.length}return Q(...b)};return(d,b)=>{l(),p(d);let v;for(;!(v=b(y()));)p();return l(),v}}function ln(t,e,s={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function n(r,o,i){const a=t[r];if(i&&a===void 0)return;const l=typeof a;if(l!==o||a===null)throw new Error(`param "${r}" is invalid: expected ${o}, got ${l}`)}Object.entries(e).forEach(([r,o])=>n(r,o,!1)),Object.entries(s).forEach(([r,o])=>n(r,o,!0))}function Sn(t){const e=new WeakMap;return(s,...n)=>{const r=e.get(s);if(r!==void 0)return r;const o=t(s,...n);return e.set(s,o),o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const j=BigInt(0),z=BigInt(1),bt=BigInt(2),Wn=BigInt(3),Jn=BigInt(4),Xn=BigInt(5),Fs=BigInt(7),Qn=BigInt(8),Gs=BigInt(9),ts=BigInt(16);function G(t,e){const s=t%e;return s>=j?s:e+s}function F(t,e,s){let n=t;for(;e-- >j;)n*=n,n%=s;return n}function Bn(t,e){if(t===j)throw new Error("invert: expected non-zero number");if(e<=j)throw new Error("invert: expected positive modulus, got "+e);let s=G(t,e),n=e,r=j,o=z;for(;s!==j;){const a=n/s,l=n%s,f=r-o*a;n=s,s=l,r=o,o=f}if(n!==z)throw new Error("invert: does not exist");return G(r,e)}function un(t,e,s){if(!t.eql(t.sqr(e),s))throw new Error("Cannot find square root")}function es(t,e){const s=(t.ORDER+z)/Jn,n=t.pow(e,s);return un(t,n,e),n}function Ws(t,e){const s=(t.ORDER-Xn)/Qn,n=t.mul(e,bt),r=t.pow(n,s),o=t.mul(e,r),i=t.mul(t.mul(o,bt),r),a=t.mul(o,t.sub(i,t.ONE));return un(t,a,e),a}function Js(t){const e=re(t),s=ns(t),n=s(e,e.neg(e.ONE)),r=s(e,n),o=s(e,e.neg(n)),i=(t+Fs)/ts;return(a,l)=>{let f=a.pow(l,i),p=a.mul(f,n);const y=a.mul(f,r),u=a.mul(f,o),d=a.eql(a.sqr(p),l),b=a.eql(a.sqr(y),l);f=a.cmov(f,p,d),p=a.cmov(u,y,b);const v=a.eql(a.sqr(p),l),A=a.cmov(f,p,v);return un(a,A,l),A}}function ns(t){if(t<Wn)throw new Error("sqrt is not defined for small field");let e=t-z,s=0;for(;e%bt===j;)e/=bt,s++;let n=bt;const r=re(t);for(;kn(r,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(s===1)return es;let o=r.pow(n,e);const i=(e+z)/bt;return function(l,f){if(l.is0(f))return f;if(kn(l,f)!==1)throw new Error("Cannot find square root");let p=s,y=l.mul(l.ONE,o),u=l.pow(f,e),d=l.pow(f,i);for(;!l.eql(u,l.ONE);){if(l.is0(u))return l.ZERO;let b=1,v=l.sqr(u);for(;!l.eql(v,l.ONE);)if(b++,v=l.sqr(v),b===p)throw new Error("Cannot find square root");const A=z<<BigInt(p-b-1),S=l.pow(y,A);p=b,y=l.sqr(S),u=l.mul(u,y),d=l.mul(d,S)}return d}}function Xs(t){return t%Jn===Wn?es:t%Qn===Xn?Ws:t%ts===Gs?Js(t):ns(t)}const Qs=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function tr(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},s=Qs.reduce((n,r)=>(n[r]="function",n),e);return ln(t,s),t}function er(t,e,s){if(s<j)throw new Error("invalid exponent, negatives unsupported");if(s===j)return t.ONE;if(s===z)return e;let n=t.ONE,r=e;for(;s>j;)s&z&&(n=t.mul(n,r)),r=t.sqr(r),s>>=z;return n}function ss(t,e,s=!1){const n=new Array(e.length).fill(s?t.ZERO:void 0),r=e.reduce((i,a,l)=>t.is0(a)?i:(n[l]=i,t.mul(i,a)),t.ONE),o=t.inv(r);return e.reduceRight((i,a,l)=>t.is0(a)?i:(n[l]=t.mul(i,n[l]),t.mul(i,a)),o),n}function kn(t,e){const s=(t.ORDER-z)/bt,n=t.pow(e,s),r=t.eql(n,t.ONE),o=t.eql(n,t.ZERO),i=t.eql(n,t.neg(t.ONE));if(!r&&!o&&!i)throw new Error("invalid Legendre symbol result");return r?1:o?0:-1}function rs(t,e){e!==void 0&&Je(e);const s=e!==void 0?e:t.toString(2).length,n=Math.ceil(s/8);return{nBitLength:s,nByteLength:n}}function re(t,e,s=!1,n={}){if(t<=j)throw new Error("invalid field: expected ORDER > 0, got "+t);let r,o,i=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||s)throw new Error("cannot specify opts in two arguments");const u=e;u.BITS&&(r=u.BITS),u.sqrt&&(o=u.sqrt),typeof u.isLE=="boolean"&&(s=u.isLE),typeof u.modFromBytes=="boolean"&&(i=u.modFromBytes),a=u.allowedLengths}else typeof e=="number"&&(r=e),n.sqrt&&(o=n.sqrt);const{nBitLength:l,nByteLength:f}=rs(t,r);if(f>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let p;const y=Object.freeze({ORDER:t,isLE:s,BITS:l,BYTES:f,MASK:se(l),ZERO:j,ONE:z,allowedLengths:a,create:u=>G(u,t),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return j<=u&&u<t},is0:u=>u===j,isValidNot0:u=>!y.is0(u)&&y.isValid(u),isOdd:u=>(u&z)===z,neg:u=>G(-u,t),eql:(u,d)=>u===d,sqr:u=>G(u*u,t),add:(u,d)=>G(u+d,t),sub:(u,d)=>G(u-d,t),mul:(u,d)=>G(u*d,t),pow:(u,d)=>er(y,u,d),div:(u,d)=>G(u*Bn(d,t),t),sqrN:u=>u*u,addN:(u,d)=>u+d,subN:(u,d)=>u-d,mulN:(u,d)=>u*d,inv:u=>Bn(u,t),sqrt:o||(u=>(p||(p=Xs(t)),p(y,u))),toBytes:u=>s?Fn(u,f):Ae(u,f),fromBytes:(u,d=!0)=>{if(a){if(!a.includes(u.length)||u.length>f)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+u.length);const v=new Uint8Array(f);v.set(u,s?0:v.length-u.length),u=v}if(u.length!==f)throw new Error("Field.fromBytes: expected "+f+" bytes, got "+u.length);let b=s?Yn(u):Tt(u);if(i&&(b=G(b,t)),!d&&!y.isValid(b))throw new Error("invalid field element: outside of range 0..ORDER");return b},invertBatch:u=>ss(y,u),cmov:(u,d,b)=>b?d:u});return Object.freeze(y)}function os(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function is(t){const e=os(t);return e+Math.ceil(e/2)}function cs(t,e,s=!1){const n=t.length,r=os(e),o=is(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);const i=s?Yn(t):Tt(t),a=G(i,e-z)+z;return s?Fn(a,r):Ae(a,r)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const It=BigInt(0),Et=BigInt(1);function we(t,e){const s=e.negate();return t?s:e}function qe(t,e){const s=ss(t.Fp,e.map(n=>n.Z));return e.map((n,r)=>t.fromAffine(n.toAffine(s[r])))}function as(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function Pe(t,e){as(t,e);const s=Math.ceil(e/t)+1,n=2**(t-1),r=2**t,o=se(t),i=BigInt(t);return{windows:s,windowSize:n,mask:o,maxNumber:r,shiftBy:i}}function Rn(t,e,s){const{windowSize:n,mask:r,maxNumber:o,shiftBy:i}=s;let a=Number(t&r),l=t>>i;a>n&&(a-=o,l+=Et);const f=e*n,p=f+Math.abs(a)-1,y=a===0,u=a<0,d=e%2!==0;return{nextN:l,offset:p,isZero:y,isNeg:u,isNegF:d,offsetF:f}}function nr(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((s,n)=>{if(!(s instanceof e))throw new Error("invalid point at index "+n)})}function sr(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((s,n)=>{if(!e.isValid(s))throw new Error("invalid scalar at index "+n)})}const Ke=new WeakMap,ls=new WeakMap;function ze(t){return ls.get(t)||1}function An(t){if(t!==It)throw new Error("invalid wNAF")}class rr{constructor(e,s){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=s}_unsafeLadder(e,s,n=this.ZERO){let r=e;for(;s>It;)s&Et&&(n=n.add(r)),r=r.double(),s>>=Et;return n}precomputeWindow(e,s){const{windows:n,windowSize:r}=Pe(s,this.bits),o=[];let i=e,a=i;for(let l=0;l<n;l++){a=i,o.push(a);for(let f=1;f<r;f++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,s,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let r=this.ZERO,o=this.BASE;const i=Pe(e,this.bits);for(let a=0;a<i.windows;a++){const{nextN:l,offset:f,isZero:p,isNeg:y,isNegF:u,offsetF:d}=Rn(n,a,i);n=l,p?o=o.add(we(u,s[d])):r=r.add(we(y,s[f]))}return An(n),{p:r,f:o}}wNAFUnsafe(e,s,n,r=this.ZERO){const o=Pe(e,this.bits);for(let i=0;i<o.windows&&n!==It;i++){const{nextN:a,offset:l,isZero:f,isNeg:p}=Rn(n,i,o);if(n=a,!f){const y=s[l];r=r.add(p?y.negate():y)}}return An(n),r}getPrecomputes(e,s,n){let r=Ke.get(s);return r||(r=this.precomputeWindow(s,e),e!==1&&(typeof n=="function"&&(r=n(r)),Ke.set(s,r))),r}cached(e,s,n){const r=ze(e);return this.wNAF(r,this.getPrecomputes(r,e,n),s)}unsafe(e,s,n,r){const o=ze(e);return o===1?this._unsafeLadder(e,s,r):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),s,r)}createCache(e,s){as(s,this.bits),ls.set(e,s),Ke.delete(e)}hasCache(e){return ze(e)!==1}}function or(t,e,s,n){let r=e,o=t.ZERO,i=t.ZERO;for(;s>It||n>It;)s&Et&&(o=o.add(r)),n&Et&&(i=i.add(r)),r=r.double(),s>>=Et,n>>=Et;return{p1:o,p2:i}}function ir(t,e,s,n){nr(s,t),sr(n,e);const r=s.length,o=n.length;if(r!==o)throw new Error("arrays of points and scalars must have equal length");const i=t.ZERO,a=Gn(BigInt(r));let l=1;a>12?l=a-3:a>4?l=a-2:a>0&&(l=2);const f=se(l),p=new Array(Number(f)+1).fill(i),y=Math.floor((e.BITS-1)/l)*l;let u=i;for(let d=y;d>=0;d-=l){p.fill(i);for(let v=0;v<o;v++){const A=n[v],S=Number(A>>BigInt(d)&f);p[S]=p[S].add(s[v])}let b=i;for(let v=p.length-1,A=i;v>0;v--)A=A.add(p[v]),b=b.add(A);if(u=u.add(b),d!==0)for(let v=0;v<l;v++)u=u.double()}return u}function Nn(t,e,s){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return tr(e),e}else return re(t,{isLE:s})}function cr(t,e,s={},n){if(n===void 0&&(n=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const l of["p","n","h"]){const f=e[l];if(!(typeof f=="bigint"&&f>It))throw new Error(`CURVE.${l} must be positive bigint`)}const r=Nn(e.p,s.Fp,n),o=Nn(e.n,s.Fn,n),a=["Gx","Gy","a","b"];for(const l of a)if(!r.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:r,Fn:o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const In=(t,e)=>(t+(t>=0?e:-e)/us)/e;function ar(t,e,s){const[[n,r],[o,i]]=e,a=In(i*t,s),l=In(-r*t,s);let f=t-a*n-l*o,p=-a*r-l*i;const y=f<rt,u=p<rt;y&&(f=-f),u&&(p=-p);const d=se(Math.ceil(Gn(s)/2))+At;if(f<rt||f>=d||p<rt||p>=d)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:y,k1:f,k2neg:u,k2:p}}function tn(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function Ze(t,e){const s={};for(let n of Object.keys(e))s[n]=t[n]===void 0?e[n]:t[n];return ye(s.lowS,"lowS"),ye(s.prehash,"prehash"),s.format!==void 0&&tn(s.format),s}class lr extends Error{constructor(e=""){super(e)}}const nt={Err:lr,_tlv:{encode:(t,e)=>{const{Err:s}=nt;if(t<0||t>256)throw new s("tlv.encode: wrong tag");if(e.length&1)throw new s("tlv.encode: unpadded data");const n=e.length/2,r=le(n);if(r.length/2&128)throw new s("tlv.encode: long form length too big");const o=n>127?le(r.length/2|128):"";return le(t)+o+r+e},decode(t,e){const{Err:s}=nt;let n=0;if(t<0||t>256)throw new s("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new s("tlv.decode: wrong tlv");const r=e[n++],o=!!(r&128);let i=0;if(!o)i=r;else{const l=r&127;if(!l)throw new s("tlv.decode(long): indefinite length not supported");if(l>4)throw new s("tlv.decode(long): byte length is too big");const f=e.subarray(n,n+l);if(f.length!==l)throw new s("tlv.decode: length bytes not complete");if(f[0]===0)throw new s("tlv.decode(long): zero leftmost byte");for(const p of f)i=i<<8|p;if(n+=l,i<128)throw new s("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+i);if(a.length!==i)throw new s("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(t){const{Err:e}=nt;if(t<rt)throw new e("integer: negative integers are not allowed");let s=le(t);if(Number.parseInt(s[0],16)&8&&(s="00"+s),s.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return s},decode(t){const{Err:e}=nt;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Tt(t)}},toSig(t){const{Err:e,_int:s,_tlv:n}=nt,r=P("signature",t),{v:o,l:i}=n.decode(48,r);if(i.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l}=n.decode(2,o),{v:f,l:p}=n.decode(2,l);if(p.length)throw new e("invalid signature: left bytes after parsing");return{r:s.decode(a),s:s.decode(f)}},hexFromSig(t){const{_tlv:e,_int:s}=nt,n=e.encode(2,s.encode(t.r)),r=e.encode(2,s.encode(t.s)),o=n+r;return e.encode(48,o)}},rt=BigInt(0),At=BigInt(1),us=BigInt(2),ue=BigInt(3),ur=BigInt(4);function vt(t,e){const{BYTES:s}=t;let n;if(typeof e=="bigint")n=e;else{let r=P("private key",e);try{n=t.fromBytes(r)}catch{throw new Error(`invalid private key: expected ui8a of size ${s}, got ${typeof e}`)}}if(!t.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function fr(t,e={}){const s=cr("weierstrass",t,e),{Fp:n,Fn:r}=s;let o=s.CURVE;const{h:i,n:a}=o;ln(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!n.is0(o.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const f=ds(n,r);function p(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function y(L,g,h){const{x:m,y:w}=g.toAffine(),E=n.toBytes(m);if(ye(h,"isCompressed"),h){p();const k=!n.isOdd(w);return Q(fs(k),E)}else return Q(Uint8Array.of(4),E,n.toBytes(w))}function u(L){wt(L,void 0,"Point");const{publicKey:g,publicKeyUncompressed:h}=f,m=L.length,w=L[0],E=L.subarray(1);if(m===g&&(w===2||w===3)){const k=n.fromBytes(E);if(!n.isValid(k))throw new Error("bad point: is not on curve, wrong x");const B=v(k);let _;try{_=n.sqrt(B)}catch(U){const O=U instanceof Error?": "+U.message:"";throw new Error("bad point: is not on curve, sqrt error"+O)}p();const R=n.isOdd(_);return(w&1)===1!==R&&(_=n.neg(_)),{x:k,y:_}}else if(m===h&&w===4){const k=n.BYTES,B=n.fromBytes(E.subarray(0,k)),_=n.fromBytes(E.subarray(k,k*2));if(!A(B,_))throw new Error("bad point: is not on curve");return{x:B,y:_}}else throw new Error(`bad point: got length ${m}, expected compressed=${g} or uncompressed=${h}`)}const d=e.toBytes||y,b=e.fromBytes||u;function v(L){const g=n.sqr(L),h=n.mul(g,L);return n.add(n.add(h,n.mul(L,o.a)),o.b)}function A(L,g){const h=n.sqr(g),m=v(L);return n.eql(h,m)}if(!A(o.Gx,o.Gy))throw new Error("bad curve params: generator point");const S=n.mul(n.pow(o.a,ue),ur),Ut=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(S,Ut)))throw new Error("bad curve params: a or b");function H(L,g,h=!1){if(!n.isValid(g)||h&&n.is0(g))throw new Error(`bad point coordinate ${L}`);return g}function mt(L){if(!(L instanceof I))throw new Error("ProjectivePoint expected")}function lt(L){if(!l||!l.basises)throw new Error("no endo");return ar(L,l.basises,r.ORDER)}const Bt=Sn((L,g)=>{const{X:h,Y:m,Z:w}=L;if(n.eql(w,n.ONE))return{x:h,y:m};const E=L.is0();g==null&&(g=E?n.ONE:n.inv(w));const k=n.mul(h,g),B=n.mul(m,g),_=n.mul(w,g);if(E)return{x:n.ZERO,y:n.ZERO};if(!n.eql(_,n.ONE))throw new Error("invZ was invalid");return{x:k,y:B}}),ie=Sn(L=>{if(L.is0()){if(e.allowInfinityPoint&&!n.is0(L.Y))return;throw new Error("bad point: ZERO")}const{x:g,y:h}=L.toAffine();if(!n.isValid(g)||!n.isValid(h))throw new Error("bad point: x or y not field elements");if(!A(g,h))throw new Error("bad point: equation left != right");if(!L.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function kt(L,g,h,m,w){return h=new I(n.mul(h.X,L),h.Y,h.Z),g=we(m,g),h=we(w,h),g.add(h)}class I{constructor(g,h,m){this.X=H("x",g),this.Y=H("y",h,!0),this.Z=H("z",m),Object.freeze(this)}static CURVE(){return o}static fromAffine(g){const{x:h,y:m}=g||{};if(!g||!n.isValid(h)||!n.isValid(m))throw new Error("invalid affine point");if(g instanceof I)throw new Error("projective point not allowed");return n.is0(h)&&n.is0(m)?I.ZERO:new I(h,m,n.ONE)}static fromBytes(g){const h=I.fromAffine(b(wt(g,void 0,"point")));return h.assertValidity(),h}static fromHex(g){return I.fromBytes(P("pointHex",g))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(g=8,h=!0){return ht.createCache(this,g),h||this.multiply(ue),this}assertValidity(){ie(this)}hasEvenY(){const{y:g}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(g)}equals(g){mt(g);const{X:h,Y:m,Z:w}=this,{X:E,Y:k,Z:B}=g,_=n.eql(n.mul(h,B),n.mul(E,w)),R=n.eql(n.mul(m,B),n.mul(k,w));return _&&R}negate(){return new I(this.X,n.neg(this.Y),this.Z)}double(){const{a:g,b:h}=o,m=n.mul(h,ue),{X:w,Y:E,Z:k}=this;let B=n.ZERO,_=n.ZERO,R=n.ZERO,N=n.mul(w,w),U=n.mul(E,E),O=n.mul(k,k),C=n.mul(w,E);return C=n.add(C,C),R=n.mul(w,k),R=n.add(R,R),B=n.mul(g,R),_=n.mul(m,O),_=n.add(B,_),B=n.sub(U,_),_=n.add(U,_),_=n.mul(B,_),B=n.mul(C,B),R=n.mul(m,R),O=n.mul(g,O),C=n.sub(N,O),C=n.mul(g,C),C=n.add(C,R),R=n.add(N,N),N=n.add(R,N),N=n.add(N,O),N=n.mul(N,C),_=n.add(_,N),O=n.mul(E,k),O=n.add(O,O),N=n.mul(O,C),B=n.sub(B,N),R=n.mul(O,U),R=n.add(R,R),R=n.add(R,R),new I(B,_,R)}add(g){mt(g);const{X:h,Y:m,Z:w}=this,{X:E,Y:k,Z:B}=g;let _=n.ZERO,R=n.ZERO,N=n.ZERO;const U=o.a,O=n.mul(o.b,ue);let C=n.mul(h,E),$=n.mul(m,k),q=n.mul(w,B),V=n.add(h,m),T=n.add(E,k);V=n.mul(V,T),T=n.add(C,$),V=n.sub(V,T),T=n.add(h,w);let K=n.add(E,B);return T=n.mul(T,K),K=n.add(C,q),T=n.sub(T,K),K=n.add(m,w),_=n.add(k,B),K=n.mul(K,_),_=n.add($,q),K=n.sub(K,_),N=n.mul(U,T),_=n.mul(O,q),N=n.add(_,N),_=n.sub($,N),N=n.add($,N),R=n.mul(_,N),$=n.add(C,C),$=n.add($,C),q=n.mul(U,q),T=n.mul(O,T),$=n.add($,q),q=n.sub(C,q),q=n.mul(U,q),T=n.add(T,q),C=n.mul($,T),R=n.add(R,C),C=n.mul(K,T),_=n.mul(V,_),_=n.sub(_,C),C=n.mul(V,$),N=n.mul(K,N),N=n.add(N,C),new I(_,R,N)}subtract(g){return this.add(g.negate())}is0(){return this.equals(I.ZERO)}multiply(g){const{endo:h}=e;if(!r.isValidNot0(g))throw new Error("invalid scalar: out of range");let m,w;const E=k=>ht.cached(this,k,B=>qe(I,B));if(h){const{k1neg:k,k1:B,k2neg:_,k2:R}=lt(g),{p:N,f:U}=E(B),{p:O,f:C}=E(R);w=U.add(C),m=kt(h.beta,N,O,k,_)}else{const{p:k,f:B}=E(g);m=k,w=B}return qe(I,[m,w])[0]}multiplyUnsafe(g){const{endo:h}=e,m=this;if(!r.isValid(g))throw new Error("invalid scalar: out of range");if(g===rt||m.is0())return I.ZERO;if(g===At)return m;if(ht.hasCache(this))return this.multiply(g);if(h){const{k1neg:w,k1:E,k2neg:k,k2:B}=lt(g),{p1:_,p2:R}=or(I,m,E,B);return kt(h.beta,_,R,w,k)}else return ht.unsafe(m,g)}multiplyAndAddUnsafe(g,h,m){const w=this.multiplyUnsafe(h).add(g.multiplyUnsafe(m));return w.is0()?void 0:w}toAffine(g){return Bt(this,g)}isTorsionFree(){const{isTorsionFree:g}=e;return i===At?!0:g?g(I,this):ht.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:g}=e;return i===At?this:g?g(I,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(g=!0){return ye(g,"isCompressed"),this.assertValidity(),d(I,this,g)}toHex(g=!0){return J(this.toBytes(g))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(g=!0){return this.toBytes(g)}_setWindowSize(g){this.precompute(g)}static normalizeZ(g){return qe(I,g)}static msm(g,h){return ir(I,r,g,h)}static fromPrivateKey(g){return I.BASE.multiply(vt(r,g))}}I.BASE=new I(o.Gx,o.Gy,n.ONE),I.ZERO=new I(n.ZERO,n.ONE,n.ZERO),I.Fp=n,I.Fn=r;const ce=r.BITS,ht=new rr(I,e.endo?Math.ceil(ce/2):ce);return I.BASE.precompute(8),I}function fs(t){return Uint8Array.of(t?2:3)}function ds(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function dr(t,e={}){const{Fn:s}=t,n=e.randomBytes||Re,r=Object.assign(ds(t.Fp,s),{seed:is(s.ORDER)});function o(d){try{return!!vt(s,d)}catch{return!1}}function i(d,b){const{publicKey:v,publicKeyUncompressed:A}=r;try{const S=d.length;return b===!0&&S!==v||b===!1&&S!==A?!1:!!t.fromBytes(d)}catch{return!1}}function a(d=n(r.seed)){return cs(wt(d,r.seed,"seed"),s.ORDER)}function l(d,b=!0){return t.BASE.multiply(vt(s,d)).toBytes(b)}function f(d){const b=a(d);return{secretKey:b,publicKey:l(b)}}function p(d){if(typeof d=="bigint")return!1;if(d instanceof t)return!0;const{secretKey:b,publicKey:v,publicKeyUncompressed:A}=r;if(s.allowedLengths||b===v)return;const S=P("key",d).length;return S===v||S===A}function y(d,b,v=!0){if(p(d)===!0)throw new Error("first arg must be private key");if(p(b)===!1)throw new Error("second arg must be public key");const A=vt(s,d);return t.fromHex(b).multiply(A).toBytes(v)}return Object.freeze({getPublicKey:l,getSharedSecret:y,keygen:f,Point:t,utils:{isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a,isValidPrivateKey:o,randomPrivateKey:a,normPrivateKeyToScalar:d=>vt(s,d),precompute(d=8,b=t.BASE){return b.precompute(d,!1)}},lengths:r})}function mr(t,e,s={}){Pn(e),ln(s,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=s.randomBytes||Re,r=s.hmac||((h,...m)=>jn(e,h,Q(...m))),{Fp:o,Fn:i}=t,{ORDER:a,BITS:l}=i,{keygen:f,getPublicKey:p,getSharedSecret:y,utils:u,lengths:d}=dr(t,s),b={prehash:!1,lowS:typeof s.lowS=="boolean"?s.lowS:!1,format:void 0,extraEntropy:!1},v="compact";function A(h){const m=a>>At;return h>m}function S(h,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${h}: out of range 1..Point.Fn.ORDER`);return m}function Ut(h,m){tn(m);const w=d.signature,E=m==="compact"?w:m==="recovered"?w+1:void 0;return wt(h,E,`${m} signature`)}class H{constructor(m,w,E){this.r=S("r",m),this.s=S("s",w),E!=null&&(this.recovery=E),Object.freeze(this)}static fromBytes(m,w=v){Ut(m,w);let E;if(w==="der"){const{r:R,s:N}=nt.toSig(wt(m));return new H(R,N)}w==="recovered"&&(E=m[0],w="compact",m=m.subarray(1));const k=i.BYTES,B=m.subarray(0,k),_=m.subarray(k,k*2);return new H(i.fromBytes(B),i.fromBytes(_),E)}static fromHex(m,w){return this.fromBytes(Nt(m),w)}addRecoveryBit(m){return new H(this.r,this.s,m)}recoverPublicKey(m){const w=o.ORDER,{r:E,s:k,recovery:B}=this;if(B==null||![0,1,2,3].includes(B))throw new Error("recovery id invalid");if(a*us<w&&B>1)throw new Error("recovery id is ambiguous for h>1 curve");const R=B===2||B===3?E+a:E;if(!o.isValid(R))throw new Error("recovery id 2 or 3 invalid");const N=o.toBytes(R),U=t.fromBytes(Q(fs((B&1)===0),N)),O=i.inv(R),C=lt(P("msgHash",m)),$=i.create(-C*O),q=i.create(k*O),V=t.BASE.multiplyUnsafe($).add(U.multiplyUnsafe(q));if(V.is0())throw new Error("point at infinify");return V.assertValidity(),V}hasHighS(){return A(this.s)}toBytes(m=v){if(tn(m),m==="der")return Nt(nt.hexFromSig(this));const w=i.toBytes(this.r),E=i.toBytes(this.s);if(m==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return Q(Uint8Array.of(this.recovery),w,E)}return Q(w,E)}toHex(m){return J(this.toBytes(m))}assertValidity(){}static fromCompact(m){return H.fromBytes(P("sig",m),"compact")}static fromDER(m){return H.fromBytes(P("sig",m),"der")}normalizeS(){return this.hasHighS()?new H(this.r,i.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return J(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return J(this.toBytes("compact"))}}const mt=s.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");const w=Tt(m),E=m.length*8-l;return E>0?w>>BigInt(E):w},lt=s.bits2int_modN||function(m){return i.create(mt(m))},Bt=se(l);function ie(h){return Ds("num < 2^"+l,h,rt,Bt),i.toBytes(h)}function kt(h,m){return wt(h,void 0,"message"),m?wt(e(h),void 0,"prehashed message"):h}function I(h,m,w){if(["recovered","canonical"].some($=>$ in w))throw new Error("sign() legacy options not supported");const{lowS:E,prehash:k,extraEntropy:B}=Ze(w,b);h=kt(h,k);const _=lt(h),R=vt(i,m),N=[ie(R),ie(_)];if(B!=null&&B!==!1){const $=B===!0?n(d.secretKey):B;N.push(P("extraEntropy",$))}const U=Q(...N),O=_;function C($){const q=mt($);if(!i.isValidNot0(q))return;const V=i.inv(q),T=t.BASE.multiply(q).toAffine(),K=i.create(T.x);if(K===rt)return;const ae=i.create(V*i.create(O+K*R));if(ae===rt)return;let vn=(T.x===K?0:2)|Number(T.y&At),xn=ae;return E&&A(ae)&&(xn=i.neg(ae),vn^=1),new H(K,xn,vn)}return{seed:U,k2sig:C}}function ce(h,m,w={}){h=P("message",h);const{seed:E,k2sig:k}=I(h,m,w);return Ys(e.outputLen,i.BYTES,r)(E,k)}function ht(h){let m;const w=typeof h=="string"||Be(h),E=!w&&h!==null&&typeof h=="object"&&typeof h.r=="bigint"&&typeof h.s=="bigint";if(!w&&!E)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(E)m=new H(h.r,h.s);else if(w){try{m=H.fromBytes(P("sig",h),"der")}catch(k){if(!(k instanceof nt.Err))throw k}if(!m)try{m=H.fromBytes(P("sig",h),"compact")}catch{return!1}}return m||!1}function L(h,m,w,E={}){const{lowS:k,prehash:B,format:_}=Ze(E,b);if(w=P("publicKey",w),m=kt(P("message",m),B),"strict"in E)throw new Error("options.strict was renamed to lowS");const R=_===void 0?ht(h):H.fromBytes(P("sig",h),_);if(R===!1)return!1;try{const N=t.fromBytes(w);if(k&&R.hasHighS())return!1;const{r:U,s:O}=R,C=lt(m),$=i.inv(O),q=i.create(C*$),V=i.create(U*$),T=t.BASE.multiplyUnsafe(q).add(N.multiplyUnsafe(V));return T.is0()?!1:i.create(T.x)===U}catch{return!1}}function g(h,m,w={}){const{prehash:E}=Ze(w,b);return m=kt(m,E),H.fromBytes(h,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:f,getPublicKey:p,getSharedSecret:y,utils:u,lengths:d,Point:t,sign:ce,verify:L,recoverPublicKey:g,Signature:H,hash:e})}function hr(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},s=t.Fp;let n=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(i=>Math.ceil(i/2)))):void 0;const r=re(e.n,{BITS:t.nBitLength,allowedLengths:n,modFromBytes:t.wrapPrivateKey}),o={Fp:s,Fn:r,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:o}}function gr(t){const{CURVE:e,curveOpts:s}=hr(t),n={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:s,hash:t.hash,ecdsaOpts:n}}function pr(t,e){const s=e.Point;return Object.assign({},e,{ProjectivePoint:s,CURVE:Object.assign({},t,rs(s.Fn.ORDER,s.Fn.BITS))})}function yr(t){const{CURVE:e,curveOpts:s,hash:n,ecdsaOpts:r}=gr(t),o=fr(e,s),i=mr(o,n,r);return pr(t,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function wr(t,e){const s=n=>yr({...t,hash:n});return{...s(e),create:s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ct={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},br={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Er=BigInt(0),Cn=BigInt(1),en=BigInt(2);function vr(t){const e=Ct.p,s=BigInt(3),n=BigInt(6),r=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),l=BigInt(88),f=t*t*t%e,p=f*f*t%e,y=F(p,s,e)*p%e,u=F(y,s,e)*p%e,d=F(u,en,e)*f%e,b=F(d,r,e)*d%e,v=F(b,o,e)*b%e,A=F(v,a,e)*v%e,S=F(A,l,e)*A%e,Ut=F(S,a,e)*v%e,H=F(Ut,s,e)*p%e,mt=F(H,i,e)*b%e,lt=F(mt,n,e)*f%e,Bt=F(lt,en,e);if(!be.eql(be.sqr(Bt),t))throw new Error("Cannot find square root");return Bt}const be=re(Ct.p,{sqrt:vr}),fn=wr({...Ct,Fp:be,lowS:!0,endo:br},pe),Ln={};function Ee(t,...e){let s=Ln[t];if(s===void 0){const n=pe(ke(t));s=Q(n,n),Ln[t]=s}return pe(Q(s,...e))}const dn=t=>t.toBytes(!0).slice(1),Mt=fn.Point,mn=t=>t%en===Er;function nn(t){const{Fn:e,BASE:s}=Mt,n=vt(e,t),r=s.multiply(n);return{scalar:mn(r.y)?n:e.neg(n),bytes:dn(r)}}function ms(t){const e=be;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x â‰¥ p");const s=e.create(t*t),n=e.create(s*t+BigInt(7));let r=e.sqrt(n);mn(r)||(r=e.neg(r));const o=Mt.fromAffine({x:t,y:r});return o.assertValidity(),o}const Kt=Tt;function hs(...t){return Mt.Fn.create(Kt(Ee("BIP0340/challenge",...t)))}function On(t){return nn(t).bytes}function xr(t,e,s=Re(32)){const{Fn:n}=Mt,r=P("message",t),{bytes:o,scalar:i}=nn(e),a=P("auxRand",s,32),l=n.toBytes(i^Kt(Ee("BIP0340/aux",a))),f=Ee("BIP0340/nonce",l,o,r),{bytes:p,scalar:y}=nn(f),u=hs(p,o,r),d=new Uint8Array(64);if(d.set(p,0),d.set(n.toBytes(n.create(y+u*i)),32),!gs(d,r,o))throw new Error("sign: Invalid signature produced");return d}function gs(t,e,s){const{Fn:n,BASE:r}=Mt,o=P("signature",t,64),i=P("message",e),a=P("publicKey",s,32);try{const l=ms(Kt(a)),f=Kt(o.subarray(0,32));if(!Qe(f,Cn,Ct.p))return!1;const p=Kt(o.subarray(32,64));if(!Qe(p,Cn,Ct.n))return!1;const y=hs(n.toBytes(f),dn(l),i),u=r.multiplyUnsafe(p).add(l.multiplyUnsafe(n.neg(y))),{x:d,y:b}=u.toAffine();return!(u.is0()||!mn(b)||d!==f)}catch{return!1}}const ps=(()=>{const s=(r=Re(48))=>cs(r,Ct.n);fn.utils.randomSecretKey;function n(r){const o=s(r);return{secretKey:o,publicKey:On(o)}}return{keygen:n,getPublicKey:On,sign:xr,verify:gs,Point:Mt,utils:{randomSecretKey:s,randomPrivateKey:s,taggedHash:Ee,lift_x:ms,pointToBytes:dn,numberToBytesBE:Ae,bytesToNumberBE:Tt,mod:G},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),x=t=>document.getElementById(t),c={settings:null,currentRoom:"#test",rooms:[],roomCounts:{},attachments:[],maxImageKB:300,maxPayloadKB:450,peers:new Map,sessions:new Map,pendingOffers:new Map,lastRelayNotice:"",lastRelayDetail:"",pendingRelayDetail:!1,relayPollId:null,relayItems:[],messagePollId:null,lastMessageId:new Map},ot=new Map,ve=new Map,$n=new Set;let Ne="echochan-web";const Pt=new Map,hn=async(t,e)=>(Pt.has(t)||Pt.set(t,new Set),Pt.get(t).add(e),()=>{var s;return(s=Pt.get(t))==null?void 0:s.delete(e)});function sn(t,e){const s=Pt.get(t);s&&s.forEach(n=>n({payload:e}))}const Z=async(t,e={})=>{switch(t){case"get_state":return Kr();case"save_settings":return zr(e.settings);case"add_room":return Zr(e.room);case"remove_room":return Vr(e.room);case"get_room_messages":return jr(e.room);case"connect_relays":return Dr();case"send_message":return Yr(e.message);case"send_signal":return Fr(e.signal);case"check_tor":throw new Error("Tor is not supported in the web build.");default:throw new Error(`Unknown command: ${t}`)}},Tn=x("room-list"),rn=x("command-input"),tt=x("message-input"),_t=x("messages"),Mn=x("inline-previews"),_r=x("relay-status"),Lt=x("current-room"),ys=x("connect-btn"),Sr=x("send-btn"),Br=x("attach-btn"),Ve=x("p2p-btn"),kr=x("settings-btn"),dt=x("settings-modal"),fe=dt==null?void 0:dt.querySelector(".modal-content"),Rr=x("settings-close"),Ar=x("settings-save"),je=x("relay-test"),De=x("relay-defaults"),Ye=x("tor-check"),Fe=x("relay-prune"),de=x("relay-status-list"),ne=x("confirm-modal"),Nr=x("confirm-title"),Ir=x("confirm-body"),ws=x("confirm-ok"),Cr=x("confirm-cancel"),D=x("nick-input"),W=x("relay-input"),zt=x("stun-input"),Zt=x("turn-input"),Vt=x("turn-username"),jt=x("turn-password"),gt=x("max-image-kb"),pt=x("max-payload-kb"),Dt=x("supabase-upload-toggle"),Yt=x("supabase-url"),Ft=x("supabase-anon-key"),Gt=x("supabase-bucket"),Wt=x("tor-toggle"),Jt=x("proxy-input"),Xt=x("max-p2p-mb"),Qt=x("p2p-timeout"),te=x("p2p-recent-min"),ee=x("p2p-max-sessions"),on=x("file-input"),xt=x("p2p-file-input"),it=x("target-select");x("p2p-inbox");const qt=x("relay-errors"),Lr=x("toast-stack"),Ie=x("image-viewer"),bs=x("viewer-image"),Ge=x("sidebar-toggle"),We=x("sidebar-overlay"),Hn=16*1024,Or=44;let me=null;const Es=["wss://relay.damus.io","wss://nos.lol","wss://relay.nostr.net","wss://relay.nos.social","wss://www.nostr.ltd"];function yt(t,e="info",s=6e3){if(!t)return;const n=document.createElement("div");n.className=`toast ${e==="error"?"error":""}`.trim(),n.textContent=t,Lr.appendChild(n),setTimeout(()=>{n.remove()},s)}function Ce(t){const e=[];for(const s of t){const n=String(s||"").trim();if(!n)continue;const o=n.split(/\s+/)[0].replace(/[;,]+$/,"");o.startsWith("wss://")&&e.push(o)}return e}function Y(t){const e=String(t||"").trim();return e?e.startsWith("#")?e:`#${e}`:""}function gn(t){const e=[],s=new Set;for(const n of t||[]){const r=Y(n);r&&!s.has(r)&&(s.add(r),e.push(r))}return e}function Un(){return{nick:"Anonymous",relays:[...Es],rooms:["#echo"],max_image_kb:40,max_payload_kb:80,supabase_upload:!1,supabase_url:"",supabase_anon_key:"",supabase_bucket:"echochan-images",stun_urls:["stun:stun.l.google.com:19302"],turn_urls:[],turn_username:"",turn_password:"",max_p2p_mb:5,p2p_timeout_sec:15,p2p_recent_minutes:10,p2p_max_sessions:2,nostr_pubkey:"",nostr_privkey:"",client_id:"",use_tor:!1,proxy_url:""}}function $r(){const t=fn.utils.randomPrivateKey(),e=ps.getPublicKey(t);return{priv:J(t),pub:J(e)}}function vs(t){if(!t.nostr_privkey||!t.nostr_pubkey){const e=$r();t.nostr_privkey=e.priv,t.nostr_pubkey=e.pub}t.client_id=t.nostr_pubkey}function Tr(){const t=localStorage.getItem("echochan_settings");let e=Un();if(t)try{e={...e,...JSON.parse(t)}}catch{e=Un()}return e.relays=Ce(e.relays||[]),e.rooms=gn(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),vs(e),e}function Le(t){localStorage.setItem("echochan_settings",JSON.stringify(t))}function xs(t){return`echochan-${(t||"").slice(0,8)||"web"}`}function Mr(t){const e=JSON.stringify(t.attachments||[]),s=`${t.room}${t.nick}${t.ts}${t.text}${e}`,n=Zn(ke(s));return J(n)}function Hr(t,e,s,n,r){const o=JSON.stringify([0,t,e,s,n,r]),i=Zn(ke(o));return J(i)}async function _s(t,e,s,n,r){const o=t.nostr_pubkey,i=Hr(o,r,e,s,n),a=await ps.sign(Nt(i),Nt(t.nostr_privkey)),l=J(a);return{id:i,pubkey:o,created_at:r,kind:e,tags:s,content:n,sig:l}}function pn(t){return t.trim().replace(/^#/,"")}function Ss(){const e=(c.settings.rooms||[]).map(n=>pn(n));return e.length?JSON.stringify(["REQ",Ne,{kinds:[1,42],"#t":e}]):null}function Ur(){return JSON.stringify(["CLOSE",Ne])}function st(){const t=Array.from(ot.values()).map(r=>({url:r.url,state:r.status,last_error:r.lastError||null})),e=t.filter(r=>r.state==="connected").length,s=t.filter(r=>r.state==="error").length,n={total:t.length,connected:e,errors:s,items:t};return sn("relay-status",n),n}function qr(){var s;const t=Ce(c.settings.relays||[]),e=new Set(t);for(const[n,r]of ot.entries())e.has(n)||((s=r.ws)==null||s.close(),ot.delete(n));for(const n of t)ot.has(n)||ot.set(n,{url:n,status:"connecting",lastError:null,backoff:1e3,ws:null,timer:null}),Bs(n);return st()}function Bs(t){const e=ot.get(t);if(e&&!(e.ws&&(e.ws.readyState===WebSocket.OPEN||e.ws.readyState===WebSocket.CONNECTING))){e.status="connecting",e.lastError=null,st();try{const s=new WebSocket(t);e.ws=s,s.onopen=()=>{e.status="connected",e.lastError=null,e.backoff=1e3;const n=Ss();n&&s.send(n),st()},s.onmessage=n=>{typeof n.data=="string"&&Pr(n.data,t)},s.onerror=()=>{e.status="error",e.lastError=e.lastError||"WebSocket error",st()},s.onclose=()=>{e.status="reconnecting",st();const n=Math.min(e.backoff,3e4);e.backoff=Math.min(e.backoff*2,3e4),clearTimeout(e.timer),e.timer=setTimeout(()=>Bs(t),n)}}catch(s){e.status="error",e.lastError=String(s),st()}}}function xe(t){ot.forEach(e=>{e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(t)})}function yn(){const t=Ur();xe(t);const e=Ss();e&&xe(e)}function Pr(t,e){let s;try{s=JSON.parse(t)}catch{return}if(!Array.isArray(s)||!s.length)return;const n=s[0];if(n==="NOTICE"){const l=s[1]||"",f=ot.get(e);f&&(f.lastError=l||"NOTICE",f.status=f.status==="connected"?"connected":"error",st());return}if(n==="OK"){if(!(s[2]!==!1)){const f=s[3]||"event rejected",p=ot.get(e);p&&(p.lastError=f,st())}return}if(n!=="EVENT"||s.length<3)return;const r=s[2];if(!r||r.kind!==1&&r.kind!==42)return;let o;try{o=JSON.parse(r.content)}catch{return}if(!o||typeof o!="object")return;if(o.type==="signal"){const l={type:"signal",room:Y(o.room||"")||qn(r.tags),from:o.from||r.pubkey,to:o.to||null,sid:o.sid,kind:o.kind,sdp:o.sdp||null,candidate:o.candidate||null,ts:o.ts||r.created_at*1e3};sn("signal-message",l);return}if(o.type!=="message")return;const i=Y(o.room||"")||qn(r.tags);if(!i)return;const a={type:"message",room:i,nick:o.nick||`npub:${(r.pubkey||"").slice(0,8)}`,client_id:o.client_id||r.pubkey,ts:Number(r.created_at||0)*1e3||Date.now(),text:o.text||"",attachments:Array.isArray(o.attachments)?o.attachments:[],id:o.id||r.id,action:!!o.action};ks(a)&&sn("new-message",a)}function qn(t=[]){for(const e of t)if(e&&e[0]==="t"&&e[1])return Y(e[1]);return""}function ks(t){if(!t||!t.id||$n.has(t.id))return!1;$n.add(t.id);const e=ve.get(t.room)||[];return e.push(t),e.length>500&&e.shift(),ve.set(t.room,e),!0}async function Kr(){const t={};return ve.forEach((e,s)=>{t[s]=e.length}),{settings:c.settings,counts:t,relay_summary:st()}}async function zr(t){const e={...c.settings,...t};e.relays=Ce(e.relays||[]),e.rooms=gn(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),vs(e),c.settings=e,Ne=xs(e.nostr_pubkey),Le(e),yn()}async function Zr(t){const e=Y(t);e&&(c.settings.rooms.includes(e)||(c.settings.rooms.push(e),Le(c.settings),yn()))}async function Vr(t){const e=Y(t);if(e){if(c.settings.rooms.length<=1)throw new Error("At least one room must remain.");c.settings.rooms=c.settings.rooms.filter(s=>s!==e),Le(c.settings),yn()}}async function jr(t){const e=Y(t);return ve.get(e)||[]}async function Dr(){return qr()}async function Yr(t){var a;if(((a=t.attachments)==null?void 0:a.length)>2)throw new Error("Only 2 inline images allowed.");const e=Y(t.room),s={room:e,type:"message",nick:t.nick||"Anonymous",client_id:c.settings.nostr_pubkey,ts:Date.now(),text:t.text||"",attachments:t.attachments||[],id:"",action:!!t.action};s.id=Mr(s);const n=JSON.stringify(s),r=[["t",pn(e)]],o=await _s(c.settings,1,r,n,Math.floor(s.ts/1e3)),i=JSON.stringify(["EVENT",o]);if(i.length>(c.settings.max_payload_kb||450)*1024)throw new Error("Payload exceeds max_payload_kb limit.");return ks(s)&&xe(i),s}async function Fr(t){const e={type:"signal",room:Y(t.room),from:t.from||c.settings.nostr_pubkey,to:t.to||null,sid:t.sid,kind:t.kind,sdp:t.sdp||null,candidate:t.candidate||null,ts:Date.now()},s=JSON.stringify(e),n=[["t",pn(e.room)]],r=await _s(c.settings,1,n,s,Math.floor(e.ts/1e3)),o=JSON.stringify(["EVENT",r]);xe(o)}function Oe(){return Date.now()}function M(t){_r.textContent=t}function Rs({title:t,body:e,okText:s}){return new Promise(n=>{me=n,Nr.textContent=t||"Confirm",Ir.textContent=e||"Are you sure?",ws.textContent=s||"OK",ne.classList.remove("hidden")})}function $e(t){me&&(me(t),me=null),ne.classList.add("hidden")}function _e(){tt.style.height="auto";const t=Math.max(tt.scrollHeight,Or);tt.style.height=`${t}px`}function Gr(t){const e=new Date(t);return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}function Wr(t){if(!t)return"";const e=[/(?:https?:\/\/)?(?:www\.)?youtu\.be\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/i];for(const s of e){const n=t.match(s);if(n&&n[1])return n[1]}return""}function Jr(t){if(!t)return null;const e=/(?:https?:\/\/)?open\.spotify\.com\/(track|album|playlist|episode|show)\/([A-Za-z0-9]+)(?:\?[^ \n]*)?/i,s=t.match(e);return s?{type:s[1],id:s[2]}:null}function Xr(t){if(!t)return"";const e=t.match(/https?:\/\/music\.yandex\.ru\/iframe\/#([A-Za-z0-9/_-]+)/i);if(e&&e[1])return`https://music.yandex.ru/iframe/#${e[1]}`;const s=t.match(/https?:\/\/music\.yandex\.ru\/album\/(\d+)\/track\/(\d+)/i);if(s){const r=s[1];return`https://music.yandex.ru/iframe/#track/${s[2]}/${r}`}const n=t.match(/https?:\/\/music\.yandex\.ru\/track\/(\d+)/i);return n?`https://music.yandex.ru/iframe/#track/${n[1]}`:""}function Qr(t){if(!t)return"";let e=t;const s=[/https?:\/\/(?:www\.)?youtu\.be\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/watch\?v=[A-Za-z0-9_-]+(?:\&[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/shorts\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/embed\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/open\.spotify\.com\/(track|album|playlist|episode|show)\/[A-Za-z0-9]+(?:\?[^ \n]*)?/gi,/https?:\/\/music\.yandex\.ru\/iframe\/#[A-Za-z0-9/_-]+/gi,/https?:\/\/music\.yandex\.ru\/album\/\d+\/track\/\d+/gi,/https?:\/\/music\.yandex\.ru\/track\/\d+/gi];for(const n of s)e=e.replace(n,"");return e.replace(/\n{3,}/g,`

`).trim()}function to(){const t=new Uint8Array(12);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}function at(){Tn.innerHTML="",c.rooms.forEach(t=>{const e=document.createElement("div");e.className="room"+(t===c.currentRoom?" active":"");const s=document.createElement("span");s.textContent=t;const n=document.createElement("span");n.className="count",n.textContent=c.roomCounts[t]||0;const r=document.createElement("button");r.className="room-remove",r.textContent="Ã—",r.title="Remove room",r.addEventListener("click",async o=>{if(o.stopPropagation(),c.rooms.length<=1){M("At least one room must remain.");return}await Rs({title:"Remove room",body:`Remove room ${t}?`,okText:"Remove"})&&(await Z("remove_room",{room:t}),c.rooms=c.rooms.filter(a=>a!==t),c.currentRoom===t&&(c.currentRoom=c.rooms[0],Lt.textContent=c.currentRoom,await Ot(c.currentRoom)),at(),ct(`Left ${t}.`))}),e.append(s,n,r),e.addEventListener("click",async()=>{document.body.classList.remove("sidebar-open"),c.currentRoom=t,Lt.textContent=t,at(),await Ot(t)}),Tn.appendChild(e)})}function As(){if(!it)return;it.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="All",it.appendChild(t);const e=Array.from(c.peers.values()).sort((s,n)=>s.nick.localeCompare(n.nick));for(const s of e){const n=document.createElement("option");n.value=s.id,n.textContent=`${s.nick} Â· ${s.id.slice(0,8)}`,it.appendChild(n)}}function eo(t){if(_t.innerHTML="",!t.length){const s=document.createElement("div");s.className="empty-state",s.textContent="No messages yet. Try /join #room or type a message.",_t.appendChild(s)}const e=[...t].sort((s,n)=>{const r=Number((s==null?void 0:s.ts)||0),o=Number((n==null?void 0:n.ts)||0);if(r!==o)return r-o;const i=String((s==null?void 0:s.id)||""),a=String((n==null?void 0:n.id)||"");return i.localeCompare(a)});if(e.forEach(s=>oe(s)),Ht(),e.length){const s=e[e.length-1];s&&s.id&&c.lastMessageId.set(c.currentRoom,s.id)}}function Ht(){requestAnimationFrame(()=>{_t.scrollTop=_t.scrollHeight})}function ct(t){const e={nick:"system",ts:Oe(),text:t,action:!1,attachments:[],system:!0};oe(e),Ht()}function oe(t){const e=document.createElement("div");e.className=t.system?"message system":"message";const s=_t.querySelector(".empty-state");s&&s.remove();const n=document.createElement("div"),r=Wr(t.text),o=Jr(t.text),i=Xr(t.text),a=t.attachments&&t.attachments.length||r||o||i;n.className=a?"message-body has-media":"message-body";const l=document.createElement("div");l.className="meta",l.textContent=`${t.nick} Â· ${Gr(t.ts)}`;const f=document.createElement("div");f.className="text";const p=t.action?`* ${t.nick} ${t.text}`:Qr(t.text);f.textContent=p;const y=document.createElement("div");y.className="message-content",p&&y.appendChild(f),n.appendChild(y),e.appendChild(l);const u=document.createElement("div");u.className="attachments";const d=r?(()=>{const A=document.createElement("div");A.className="youtube-embed";const S=document.createElement("iframe");return S.src=`https://www.youtube-nocookie.com/embed/${r}`,S.title="YouTube video",S.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",S.referrerPolicy="origin-when-cross-origin",S.allowFullscreen=!0,A.appendChild(S),A})():null,b=o?(()=>{const A=document.createElement("div");A.className="spotify-embed";const S=document.createElement("iframe");return S.src=`https://open.spotify.com/embed/${o.type}/${o.id}`,S.title="Spotify",S.allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture",S.loading="lazy",S.referrerPolicy="origin-when-cross-origin",A.appendChild(S),A})():null,v=i?(()=>{const A=document.createElement("div");A.className="yandex-embed";const S=document.createElement("iframe");return S.src=i,S.title="Yandex Music",S.allow="autoplay; clipboard-write; encrypted-media",S.loading="lazy",S.referrerPolicy="origin-when-cross-origin",A.appendChild(S),A})():null;t.attachments&&t.attachments.length&&t.attachments.forEach(A=>{const S=document.createElement("img");S.src=A.data,S.alt="attachment",S.addEventListener("click",()=>no(A.data)),u.appendChild(S)}),d&&u.appendChild(d),b&&u.appendChild(b),v&&u.appendChild(v),a&&n.insertBefore(u,y),e.appendChild(n),_t.appendChild(e),t&&t.id&&c.lastMessageId.set(t.room||c.currentRoom,t.id)}function no(t){t&&(bs.src=t,Ie.classList.remove("hidden"))}function Ns(){Ie.classList.add("hidden"),bs.src=""}function Is(){Mn.innerHTML="",c.attachments.forEach(t=>{const e=document.createElement("img");e.src=t.data,Mn.appendChild(e)})}function so(t){const e=JSON.stringify(t);return new TextEncoder().encode(e).length/1024}async function ro(){var s,n;c.settings=Tr(),c.settings.nick==="Echidna"&&(c.settings.nick="Anonymous",Le(c.settings)),Ne=xs(c.settings.nostr_pubkey);const t=await Z("get_state",{});c.settings=t.settings;const e=gn(t.settings.rooms);c.rooms=e,c.roomCounts=t.counts||{},c.currentRoom=c.rooms[0]||"#test",c.maxImageKB=t.settings.max_image_kb,c.maxPayloadKB=t.settings.max_payload_kb,D&&(D.value=t.settings.nick),W&&(W.value=t.settings.relays.join(`
`)),gt&&(gt.value=t.settings.max_image_kb),pt&&(pt.value=t.settings.max_payload_kb),Dt&&(Dt.checked=!!t.settings.supabase_upload),Yt&&(Yt.value=t.settings.supabase_url||""),Ft&&(Ft.value=t.settings.supabase_anon_key||""),Gt&&(Gt.value=t.settings.supabase_bucket||"echochan-images"),zt&&(zt.value=((s=t.settings.stun_urls)==null?void 0:s.join(`
`))||""),Wt&&(Wt.checked=t.settings.use_tor||!1),Jt&&(Jt.value=t.settings.proxy_url||""),Zt&&(Zt.value=((n=t.settings.turn_urls)==null?void 0:n.join(`
`))||""),Vt&&(Vt.value=t.settings.turn_username||""),jt&&(jt.value=t.settings.turn_password||""),Xt&&(Xt.value=t.settings.max_p2p_mb||5),Qt&&(Qt.value=t.settings.p2p_timeout_sec||15),te&&(te.value=t.settings.p2p_recent_minutes||10),ee&&(ee.value=t.settings.p2p_max_sessions||2),Lt.textContent=c.currentRoom,at(),it&&As(),await Ot(c.currentRoom),Te(t.relay_summary),JSON.stringify(e)!==JSON.stringify(t.settings.rooms)&&(c.settings.rooms=e,await Z("save_settings",{settings:c.settings})),ct(`Relays configured: ${c.settings.relays.length}`),oo()}function oo(){c.relayPollId||(c.relayPollId=setInterval(async()=>{try{const t=await Z("get_state",{});t&&t.relay_summary&&Te(t.relay_summary)}catch{}},4e3))}function Te(t){if(!t)return;const e=t.total??(t.items?t.items.length:0),s=t.connected??0,n=t.errors??0;c.relayItems=t.items||[],e>0&&s===0&&n===0?M(`Connecting to ${e} relays...`):s>0?M(`Connected to ${s}/${e} relays, ${n} errors`):M(`Connected to 0 relays, ${n} errors`),ao(t.items||[]),lo(t.items||[]),io(t),c.pendingRelayDetail&&co(t)}function io(t){const e=[];t.total===0?e.push("No relays configured. Open Settings and add wss:// relays."):t.connected===0&&e.push("No relay connections yet. Check relay errors in Settings.");const s=(t.items||[]).filter(r=>r.last_error);if(s.length)for(const r of s)r.last_error?e.push(`${r.url} error: ${r.last_error}`):e.push(`${r.url} error`);if(!e.length)return;const n=e.join(" ");n!==c.lastRelayNotice&&(c.lastRelayNotice=n,yt(n,"error"))}function co(t){const e=t.items||[];if(!e.length)return;const n=`Relay status: ${e.map(r=>r.last_error?`${r.state}: ${r.url} (${r.last_error})`:`${r.state}: ${r.url}`).join(" | ")}`;n!==c.lastRelayDetail&&(c.lastRelayDetail=n,yt(n,"info",5e3),c.pendingRelayDetail=!1)}function ao(t){const e=fe&&!dt.classList.contains("hidden"),s=e?fe.scrollTop:0;if(de){if(de.innerHTML="",!t.length){const n=document.createElement("div");n.textContent="No relay status yet. Click Test relays.",de.appendChild(n),e&&(fe.scrollTop=s);return}t.forEach(n=>{const r=document.createElement("div");r.className="relay-status-item";const o=document.createElement("div");o.textContent=n.url;const i=document.createElement("div");i.className=`state ${n.state}`,i.textContent=n.state;const a=document.createElement("button");if(a.textContent="Remove",a.addEventListener("click",async()=>{const l=c.settings.relays.filter(f=>f!==n.url);if(!l.length){M("At least one relay must remain.");return}W.value=l.join(`
`),await Me({close:!1})}),r.append(o,i,a),n.last_error){const l=document.createElement("div");l.className="error",l.textContent=n.last_error,r.appendChild(l)}de.appendChild(r)}),e&&(fe.scrollTop=s)}}function lo(t){const e=t.filter(n=>n.last_error);if(qt.innerHTML="",!e.length){qt.classList.add("hidden");return}qt.classList.remove("hidden");const s=document.createElement("div");s.className="title",s.textContent="Relay errors",qt.appendChild(s),e.forEach(n=>{const r=document.createElement("div");r.className="item",r.textContent=n.last_error?`${n.url} â€” ${n.last_error}`:`${n.url} â€” error`,qt.appendChild(r)})}async function Ot(t){const e=await Z("get_room_messages",{room:t});c.roomCounts[t]=e.length,eo(e),Ts(e),at()}async function wn(){var t;if(M("Connecting..."),yt("Connecting to relays...","info",3e3),(t=c.settings)!=null&&t.use_tor){const e=c.settings.proxy_url||"socks5://127.0.0.1:9150";yt(`Using SOCKS5 proxy: ${e}`,"info",4e3)}c.pendingRelayDetail=!0;try{const e=await Z("connect_relays",{});Te(e);const s=e.total??(e.items?e.items.length:0),n=e.connected??0,r=e.errors??0;s>0&&n===0&&r===0?yt("Connecting to chat...","info",3e3):yt("Connected to chat.","info",3e3)}catch(e){M(String(e)),yt(String(e),"error",5e3)}}async function uo(t){const e=t.trim();if(e){if(e.startsWith("/join ")){const s=Y(e.replace("/join","").trim());if(!s)return;c.rooms.includes(s)||(c.rooms.push(s),at(),await Z("add_room",{room:s})),c.currentRoom=s,Lt.textContent=s,ct(`Joined ${s}.`),await Ot(s);return}if(e.startsWith("/leave ")){const s=Y(e.replace("/leave","").trim());if(!s)return;if(c.rooms.length<=1){M("At least one room must remain.");return}if(!c.rooms.includes(s)){M("Room not found.");return}await Z("remove_room",{room:s}),c.rooms=c.rooms.filter(n=>n!==s),c.currentRoom===s&&(c.currentRoom=c.rooms[0],Lt.textContent=c.currentRoom,await Ot(c.currentRoom)),at(),ct(`Left ${s}.`);return}if(e.startsWith("/nick ")){const s=e.replace("/nick","").trim();if(!s)return;c.settings.nick=s,D.value=s,await Z("save_settings",{settings:c.settings}),ct(`Nick changed to ${s}.`);return}}}async function Cs(t){const e=t.trim();if(!e)return;if(e.startsWith("/join ")||e.startsWith("/nick ")||e.startsWith("/leave ")){await uo(e),tt.value="",_e();return}let s=!1,n=e;e.startsWith("/me ")&&(s=!0,n=e.replace("/me","").trim());const r={type:"message",room:Y(c.currentRoom),nick:c.settings.nick,ts:Date.now(),text:n,attachments:c.attachments,id:"0".repeat(64),action:s};if(so(r)>c.maxPayloadKB){M(`Payload exceeds ${c.maxPayloadKB}KB limit.`);return}try{const o=await Z("send_message",{message:{room:Y(c.currentRoom),nick:c.settings.nick,text:n,attachments:c.attachments,action:s}});c.attachments=[],Is(),tt.value="",_e(),c.roomCounts[c.currentRoom]=(c.roomCounts[c.currentRoom]||0)+1,oe(o),at(),Ht()}catch(o){M(String(o))}}async function fo(t,e,s){const n=await createImageBitmap(t),r=Math.max(n.width,n.height),o=Math.min(1,e/r),i=[1,.9,.8,.7,.6],a=[.75,.6,.45,.3],l=document.createElement("canvas"),f=l.getContext("2d");for(const p of i){const y=o*p,u=Math.max(1,Math.round(n.width*y)),d=Math.max(1,Math.round(n.height*y));l.width=u,l.height=d,f.clearRect(0,0,u,d),f.drawImage(n,0,0,u,d);for(const b of a){const v=l.toDataURL("image/webp",b),A=v.split(",")[1]||"",S=Math.floor(A.length*.75);if(S<=s*1024)return{kind:"inline",mime:"image/webp",data:v,w:u,h:d,size:S}}}throw new Error("Image too large after compression.")}async function mo(t,e){const s=c.settings.supabase_url,n=c.settings.supabase_anon_key,r=c.settings.supabase_bucket;if(!s||!n||!r)throw new Error("Supabase upload is enabled but credentials are missing.");const o=(t.split(",")[1]||"").trim();if(!o)throw new Error("Invalid image data.");const i=Uint8Array.from(atob(o),y=>y.charCodeAt(0)),a=String(e).replace(/[^\w.-]+/g,"_"),l=`uploads/${Date.now()}_${Math.random().toString(16).slice(2)}_${a}.webp`,f=`${s}/storage/v1/object/${r}/${l}`,p=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${n}`,apikey:n,"Content-Type":"image/webp","x-upsert":"true"},body:i});if(!p.ok){const y=await p.text();throw new Error(`Supabase upload failed: ${p.status} ${y}`)}return`${s}/storage/v1/object/public/${r}/${l}`}async function Ls(t){for(const e of t){if(c.attachments.length>=2){M("Only 2 inline images allowed.");break}try{const s=await fo(e,1280,c.maxImageKB);if(c.settings.supabase_upload){M("Uploading image...");const n=await mo(s.data,e.name||"image");c.attachments.push({kind:"link",mime:s.mime,data:n,w:s.w,h:s.h,size:s.size}),M("Image uploaded.")}else c.attachments.push(s);Is()}catch(s){M(String(s))}}}function ho(){dt.classList.remove("hidden")}function bn(){dt.classList.add("hidden"),En()}async function Me({close:t=!0}={}){const e=Ce(((W==null?void 0:W.value)||"").split(`
`)),s=((zt==null?void 0:zt.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length),n=((Zt==null?void 0:Zt.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length);c.settings.nick=(D==null?void 0:D.value.trim())||c.settings.nick,c.settings.relays=e,W&&(W.value=e.join(`
`));const r=Number(gt==null?void 0:gt.value)||c.maxImageKB,o=Number(pt==null?void 0:pt.value)||c.maxPayloadKB;c.settings.max_image_kb=Math.max(20,Math.min(80,r)),c.settings.max_payload_kb=Math.max(60,Math.min(200,o)),c.settings.supabase_upload=!!(Dt!=null&&Dt.checked),c.settings.supabase_url=(Yt==null?void 0:Yt.value.trim())||"",c.settings.supabase_anon_key=(Ft==null?void 0:Ft.value.trim())||"",c.settings.supabase_bucket=(Gt==null?void 0:Gt.value.trim())||"echochan-images",gt&&(gt.value=String(c.settings.max_image_kb)),pt&&(pt.value=String(c.settings.max_payload_kb)),c.settings.stun_urls=s,c.settings.use_tor=(Wt==null?void 0:Wt.checked)||!1,c.settings.proxy_url=(Jt==null?void 0:Jt.value.trim())||"",c.settings.turn_urls=n,c.settings.turn_username=(Vt==null?void 0:Vt.value)||"",c.settings.turn_password=(jt==null?void 0:jt.value)||"",c.settings.max_p2p_mb=Number(Xt==null?void 0:Xt.value)||5,c.settings.p2p_timeout_sec=Number(Qt==null?void 0:Qt.value)||15,c.settings.p2p_recent_minutes=Number(te==null?void 0:te.value)||10,c.settings.p2p_max_sessions=Number(ee==null?void 0:ee.value)||2,c.maxImageKB=c.settings.max_image_kb,c.maxPayloadKB=c.settings.max_payload_kb,await Z("save_settings",{settings:c.settings}),t&&bn(),await wn()}async function En(){if(!D)return;const t=D.value.trim()||"Anonymous";t!==c.settings.nick&&(c.settings.nick=t,await Z("save_settings",{settings:c.settings}))}function Os(){const t=[];return c.settings.stun_urls&&c.settings.stun_urls.length&&t.push({urls:c.settings.stun_urls}),c.settings.turn_urls&&c.settings.turn_urls.length&&t.push({urls:c.settings.turn_urls,username:c.settings.turn_username||void 0,credential:c.settings.turn_password||void 0}),{iceServers:t}}function $s(){return c.sessions.size}function go(t){const e=c.peers.get(t);return e?Oe()-e.lastSeen<=(c.settings.p2p_recent_minutes||10)*60*1e3:!1}function Ts(t){if(it){for(const e of t){if(!e.client_id)continue;const s=e.client_id,n=c.peers.get(s),r=e.nick||s.slice(0,8),o=e.ts||Oe();(!n||n.lastSeen<o)&&c.peers.set(s,{id:s,nick:r,lastSeen:o})}As()}}function Ms(t,e){const s=c.settings.p2p_timeout_sec||15,n={sid:t,mode:e,pc:null,dc:null,meta:null,receivedChunks:[],receivedBytes:0,expectedSize:0,timeout:null};return n.timeout=setTimeout(()=>{$t(t,"P2P failed (timeout). Use inline instead.")},s*1e3),c.sessions.set(t,n),n}function $t(t,e){const s=c.sessions.get(t);s&&(clearTimeout(s.timeout),s.dc&&s.dc.close(),s.pc&&s.pc.close(),c.sessions.delete(t),e&&M(e))}async function Se(t,e){const s={room:c.currentRoom,from:c.settings.nostr_pubkey||"",to:e.to||null,sid:e.sid,kind:t,sdp:e.sdp||null,candidate:e.candidate||null};await Z("send_signal",{signal:s})}async function po(t){if($s()>=(c.settings.p2p_max_sessions||2)){M("P2P session limit reached.");return}if(t.size>(c.settings.max_p2p_mb||5)*1024*1024){M("P2P file too large.");return}const e=to(),s=Ms(e,"send"),n=new RTCPeerConnection(Os());s.pc=n;const r=n.createDataChannel("file");s.dc=r,r.binaryType="arraybuffer",r.onopen=async()=>{const a=await t.arrayBuffer(),l={kind:"file_meta",sid:e,name:t.name,mime:t.type||"application/octet-stream",size:t.size};r.send(JSON.stringify(l));let f=0;const p=new Uint8Array(a);for(;f<p.length;){const y=p.slice(f,f+Hn);r.send(y),f+=Hn}},r.onmessage=a=>{if(typeof a.data=="string")try{const l=JSON.parse(a.data);l.kind==="file_ack"&&l.sid===e&&$t(e,"P2P transfer completed.")}catch{return}};const o=(it==null?void 0:it.value)||null;n.onicecandidate=async a=>{a.candidate&&await Se("ice",{sid:e,to:o,candidate:{candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex}})};const i=await n.createOffer();await n.setLocalDescription(i),await Se("offer",{sid:e,to:o,sdp:i.sdp})}function yo(t){const e=document.createElement("div");e.className="p2p-card";const s=document.createElement("div");s.textContent=`Incoming P2P image from ${t.from.slice(0,8)}`;const n=document.createElement("div");n.className="actions";const r=document.createElement("button");r.textContent="Accept";const o=document.createElement("button");o.textContent="Decline",n.append(r,o),e.append(s,n);const i=document.createElement("div");i.className="message system";const a=document.createElement("div");a.className="message-body",a.appendChild(e),i.appendChild(a),_t.appendChild(i),Ht(),r.addEventListener("click",async()=>{i.remove(),await wo(t)}),o.addEventListener("click",()=>{i.remove(),$t(t.sid,"P2P declined.")})}async function wo(t){if($s()>=(c.settings.p2p_max_sessions||2)){M("P2P session limit reached.");return}if(!go(t.from)&&!await Rs({title:"Unverified sender",body:"Sender has not spoken recently in this room. Accept anyway?",okText:"Accept"})){$t(t.sid,"P2P declined.");return}const e=t.sid,s=Ms(e,"recv"),n=new RTCPeerConnection(Os());s.pc=n,n.ondatachannel=o=>{const i=o.channel;s.dc=i,i.binaryType="arraybuffer",i.onmessage=a=>bo(s,t.from,a.data)},n.onicecandidate=async o=>{o.candidate&&await Se("ice",{sid:e,to:t.from,candidate:{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex}})},await n.setRemoteDescription({type:"offer",sdp:t.sdp});const r=await n.createAnswer();await n.setLocalDescription(r),await Se("answer",{sid:e,to:t.from,sdp:r.sdp})}function bo(t,e,s){if(typeof s=="string"){try{const r=JSON.parse(s);r.kind==="file_meta"&&r.sid===t.sid&&(t.meta=r,t.expectedSize=r.size,r.size>(c.settings.max_p2p_mb||5)*1024*1024&&$t(t.sid,"P2P file too large."))}catch{return}return}if(!t.meta)return;const n=new Uint8Array(s);if(t.receivedChunks.push(n),t.receivedBytes+=n.byteLength,t.receivedBytes>=t.expectedSize){const r=new Blob(t.receivedChunks,{type:t.meta.mime}),o=URL.createObjectURL(r),i={nick:e.slice(0,8),ts:Oe(),text:"[P2P image]",action:!1,attachments:[{data:o}]};oe(i),Ht(),t.dc&&t.dc.send(JSON.stringify({kind:"file_ack",sid:t.sid,ok:!0})),$t(t.sid,null)}}async function Eo(t){if(t.room!==c.currentRoom)return;if(t.kind==="offer"){if(c.pendingOffers.has(t.sid))return;c.pendingOffers.set(t.sid,t),yo(t);return}const e=c.sessions.get(t.sid);if(e){if(t.kind==="answer"&&e.pc){await e.pc.setRemoteDescription({type:"answer",sdp:t.sdp});return}if(t.kind==="ice"&&e.pc&&t.candidate)try{await e.pc.addIceCandidate(t.candidate)}catch{return}}}ys.addEventListener("click",async()=>{const t=Y(rn.value);t&&(c.rooms.includes(t)||(c.rooms.push(t),at(),await Z("add_room",{room:t})),c.currentRoom=t,Lt.textContent=t,ct(`Joined ${t}.`),await Ot(t),rn.value="")});kr.addEventListener("click",ho);Rr.addEventListener("click",bn);Ar.addEventListener("click",Me);D==null||D.addEventListener("blur",En);D==null||D.addEventListener("change",En);dt.addEventListener("click",t=>{t.target===dt&&bn()});je==null||je.addEventListener("click",async()=>{await wn()});De==null||De.addEventListener("click",async()=>{W&&(W.value=Es.join(`
`)),await Me({close:!1})});Ye==null||Ye.addEventListener("click",async()=>{try{const t=await Z("check_tor",{});ct(t?"Tor proxy is reachable.":"Tor is disabled. Enable Use Tor to test.")}catch(t){ct(`Tor check failed: ${String(t)}`)}});Fe==null||Fe.addEventListener("click",async()=>{const t=new Set(c.relayItems.filter(s=>s.state==="error").map(s=>s.url));if(!t.size){M("No failing relays to remove.");return}const e=c.settings.relays.filter(s=>!t.has(s));if(!e.length){M("All relays would be removed.");return}W.value=e.join(`
`),await Me({close:!1})});ws.addEventListener("click",()=>$e(!0));Cr.addEventListener("click",()=>$e(!1));ne.addEventListener("click",t=>{t.target===ne&&$e(!1)});Ie.addEventListener("click",()=>{Ns()});Ge==null||Ge.addEventListener("click",()=>{window.innerWidth<=900?document.body.classList.toggle("sidebar-open"):document.body.classList.toggle("sidebar-collapsed")});We==null||We.addEventListener("click",()=>{document.body.classList.remove("sidebar-open")});Br.addEventListener("click",()=>on.click());Ve==null||Ve.addEventListener("click",()=>{xt==null||xt.click()});xt==null||xt.addEventListener("change",async t=>{var s;const e=(s=t.target.files)==null?void 0:s[0];e&&await po(e),xt.value=""});on.addEventListener("change",async t=>{const e=Array.from(t.target.files||[]);await Ls(e),on.value=""});rn.addEventListener("keydown",async t=>{t.key==="Enter"&&(t.preventDefault(),ys.click())});Sr.addEventListener("click",async()=>Cs(tt.value));tt.addEventListener("keydown",async t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),await Cs(tt.value))});tt.addEventListener("paste",async t=>{var n;const e=(n=t.clipboardData)==null?void 0:n.items;if(!e)return;const s=[];for(const r of e)if(r.kind==="file"&&r.type.startsWith("image/")){const o=r.getAsFile();o&&s.push(o)}s.length&&(t.preventDefault(),await Ls(s))});tt.addEventListener("input",_e);document.addEventListener("keydown",t=>{t.key==="Escape"&&!ne.classList.contains("hidden")&&$e(!1),t.key==="Escape"&&!Ie.classList.contains("hidden")&&Ns()});hn("new-message",t=>{const e=t.payload;!e||!e.room||(c.roomCounts[e.room]||(c.roomCounts[e.room]=0),c.roomCounts[e.room]+=1,e.room===c.currentRoom&&(oe(e),Ht(),Ts([e])),at())});hn("relay-status",t=>{Te(t.payload)});hn("signal-message",t=>{Eo(t.payload).catch(()=>{})});ro().then(wn).catch(t=>M(String(t)));_e();
