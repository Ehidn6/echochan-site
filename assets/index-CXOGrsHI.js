(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function r(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=r(s);fetch(s.href,o)}})();const qt=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Ze(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function vn(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function Pt(t,...e){if(!Ze(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function yr(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");vn(t.outputLen),vn(t.blockLen)}function Me(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function ys(t,e){Pt(t);const r=e.outputLen;if(t.length<r)throw new Error("digestInto() expects output buffer of length at least "+r)}function $e(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function en(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function dt(t,e){return t<<32-e|t>>>e}const gr=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",gs=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function lt(t){if(Pt(t),gr)return t.toHex();let e="";for(let r=0;r<t.length;r++)e+=gs[t[r]];return e}const pt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Xn(t){if(t>=pt._0&&t<=pt._9)return t-pt._0;if(t>=pt.A&&t<=pt.F)return t-(pt.A-10);if(t>=pt.a&&t<=pt.f)return t-(pt.a-10)}function Dt(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(gr)return Uint8Array.fromHex(t);const e=t.length,r=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(r);for(let s=0,o=0;s<r;s++,o+=2){const i=Xn(t.charCodeAt(o)),a=Xn(t.charCodeAt(o+1));if(i===void 0||a===void 0){const l=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+o)}n[s]=i*16+a}return n}function Ve(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function Tn(t){return typeof t=="string"&&(t=Ve(t)),Pt(t),t}function ft(...t){let e=0;for(let n=0;n<t.length;n++){const s=t[n];Pt(s),e+=s.length}const r=new Uint8Array(e);for(let n=0,s=0;n<t.length;n++){const o=t[n];r.set(o,s),s+=o.length}return r}class wr{}function ws(t){const e=n=>t().update(Tn(n)).digest(),r=t();return e.outputLen=r.outputLen,e.blockLen=r.blockLen,e.create=()=>t(),e}function je(t=32){if(qt&&typeof qt.getRandomValues=="function")return qt.getRandomValues(new Uint8Array(t));if(qt&&typeof qt.randomBytes=="function")return Uint8Array.from(qt.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function bs(t,e,r,n){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,r,n);const s=BigInt(32),o=BigInt(4294967295),i=Number(r>>s&o),a=Number(r&o),l=n?4:0,d=n?0:4;t.setUint32(e+l,i,n),t.setUint32(e+d,a,n)}function Es(t,e,r){return t&e^~t&r}function vs(t,e,r){return t&e^t&r^e&r}class xs extends wr{constructor(e,r,n,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=r,this.padOffset=n,this.isLE=s,this.buffer=new Uint8Array(e),this.view=en(this.buffer)}update(e){Me(this),e=Tn(e),Pt(e);const{view:r,buffer:n,blockLen:s}=this,o=e.length;for(let i=0;i<o;){const a=Math.min(s-this.pos,o-i);if(a===s){const l=en(e);for(;s<=o-i;i+=s)this.process(l,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(r,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Me(this),ys(e,this),this.finished=!0;const{buffer:r,view:n,blockLen:s,isLE:o}=this;let{pos:i}=this;r[i++]=128,$e(this.buffer.subarray(i)),this.padOffset>s-i&&(this.process(n,0),i=0);for(let g=i;g<s;g++)r[g]=0;bs(n,s-8,BigInt(this.length*8),o),this.process(n,0);const a=en(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const d=l/4,p=this.get();if(d>p.length)throw new Error("_sha2: outputLen bigger than state");for(let g=0;g<d;g++)a.setUint32(4*g,p[g],o)}digest(){const{buffer:e,outputLen:r}=this;this.digestInto(e);const n=e.slice(0,r);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:r,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.destroyed=i,e.finished=o,e.length=s,e.pos=a,s%r&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const xt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Ss=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),St=new Uint32Array(64);class _s extends xs{constructor(e=32){super(64,e,8,!1),this.A=xt[0]|0,this.B=xt[1]|0,this.C=xt[2]|0,this.D=xt[3]|0,this.E=xt[4]|0,this.F=xt[5]|0,this.G=xt[6]|0,this.H=xt[7]|0}get(){const{A:e,B:r,C:n,D:s,E:o,F:i,G:a,H:l}=this;return[e,r,n,s,o,i,a,l]}set(e,r,n,s,o,i,a,l){this.A=e|0,this.B=r|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=l|0}process(e,r){for(let g=0;g<16;g++,r+=4)St[g]=e.getUint32(r,!1);for(let g=16;g<64;g++){const u=St[g-15],f=St[g-2],x=dt(u,7)^dt(u,18)^u>>>3,S=dt(f,17)^dt(f,19)^f>>>10;St[g]=S+St[g-7]+x+St[g-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:l,G:d,H:p}=this;for(let g=0;g<64;g++){const u=dt(a,6)^dt(a,11)^dt(a,25),f=p+u+Es(a,l,d)+Ss[g]+St[g]|0,S=(dt(n,2)^dt(n,13)^dt(n,22))+vs(n,s,o)|0;p=d,d=l,l=a,a=i+f|0,i=o,o=s,s=n,n=f+S|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,l=l+this.F|0,d=d+this.G|0,p=p+this.H|0,this.set(n,s,o,i,a,l,d,p)}roundClean(){$e(St)}destroy(){this.set(0,0,0,0,0,0,0,0),$e(this.buffer)}}const Oe=ws(()=>new _s),br=Oe;class Er extends wr{constructor(e,r){super(),this.finished=!1,this.destroyed=!1,yr(e);const n=Tn(r);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),$e(o)}update(e){return Me(this),this.iHash.update(e),this}digestInto(e){Me(this),Pt(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:r,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=r._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const vr=(t,e,r)=>new Er(t,e).update(r).digest();vr.create=(t,e)=>new Er(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Mn=BigInt(0),xn=BigInt(1);function Pe(t,e=""){if(typeof t!="boolean"){const r=e&&`"${e}"`;throw new Error(r+"expected boolean, got type="+typeof t)}return t}function Nt(t,e,r=""){const n=Ze(t),s=t==null?void 0:t.length,o=e!==void 0;if(!n||o&&s!==e){const i=r&&`"${r}" `,a=o?` of length ${e}`:"",l=n?`length=${s}`:`type=${typeof t}`;throw new Error(i+"expected Uint8Array"+a+", got "+l)}return t}function Se(t){const e=t.toString(16);return e.length&1?"0"+e:e}function xr(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?Mn:BigInt("0x"+t)}function Jt(t){return xr(lt(t))}function Sr(t){return Pt(t),xr(lt(Uint8Array.from(t).reverse()))}function Ye(t,e){return Dt(t.toString(16).padStart(e*2,"0"))}function _r(t,e){return Ye(t,e).reverse()}function Z(t,e,r){let n;if(typeof e=="string")try{n=Dt(e)}catch(o){throw new Error(t+" must be hex string or Uint8Array, cause: "+o)}else if(Ze(e))n=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const s=n.length;if(typeof r=="number"&&s!==r)throw new Error(t+" of length "+r+" expected, got "+s);return n}const nn=t=>typeof t=="bigint"&&Mn<=t;function Sn(t,e,r){return nn(t)&&nn(e)&&nn(r)&&e<=t&&t<r}function ks(t,e,r,n){if(!Sn(e,r,n))throw new Error("expected valid "+t+": "+r+" <= n < "+n+", got "+e)}function kr(t){let e;for(e=0;t>Mn;t>>=xn,e+=1);return e}const Ee=t=>(xn<<BigInt(t))-xn;function Bs(t,e,r){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof r!="function")throw new Error("hmacFn must be a function");const n=f=>new Uint8Array(f),s=f=>Uint8Array.of(f);let o=n(t),i=n(t),a=0;const l=()=>{o.fill(1),i.fill(0),a=0},d=(...f)=>r(i,o,...f),p=(f=n(0))=>{i=d(s(0),f),o=d(),f.length!==0&&(i=d(s(1),f),o=d())},g=()=>{if(a++>=1e3)throw new Error("drbg: tried 1000 values");let f=0;const x=[];for(;f<e;){o=d();const S=o.slice();x.push(S),f+=o.length}return ft(...x)};return(f,x)=>{l(),p(f);let S;for(;!(S=x(g()));)p();return l(),S}}function $n(t,e,r={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function n(s,o,i){const a=t[s];if(i&&a===void 0)return;const l=typeof a;if(l!==o||a===null)throw new Error(`param "${s}" is invalid: expected ${o}, got ${l}`)}Object.entries(e).forEach(([s,o])=>n(s,o,!1)),Object.entries(r).forEach(([s,o])=>n(s,o,!0))}function Qn(t){const e=new WeakMap;return(r,...n)=>{const s=e.get(r);if(s!==void 0)return s;const o=t(r,...n);return e.set(r,o),o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Q=BigInt(0),G=BigInt(1),Rt=BigInt(2),Br=BigInt(3),Ar=BigInt(4),Cr=BigInt(5),As=BigInt(7),Lr=BigInt(8),Cs=BigInt(9),Nr=BigInt(16);function st(t,e){const r=t%e;return r>=Q?r:e+r}function rt(t,e,r){let n=t;for(;e-- >Q;)n*=n,n%=r;return n}function tr(t,e){if(t===Q)throw new Error("invert: expected non-zero number");if(e<=Q)throw new Error("invert: expected positive modulus, got "+e);let r=st(t,e),n=e,s=Q,o=G;for(;r!==Q;){const a=n/r,l=n%r,d=s-o*a;n=r,r=l,s=o,o=d}if(n!==G)throw new Error("invert: does not exist");return st(s,e)}function On(t,e,r){if(!t.eql(t.sqr(e),r))throw new Error("Cannot find square root")}function Rr(t,e){const r=(t.ORDER+G)/Ar,n=t.pow(e,r);return On(t,n,e),n}function Ls(t,e){const r=(t.ORDER-Cr)/Lr,n=t.mul(e,Rt),s=t.pow(n,r),o=t.mul(e,s),i=t.mul(t.mul(o,Rt),s),a=t.mul(o,t.sub(i,t.ONE));return On(t,a,e),a}function Ns(t){const e=ve(t),r=Ir(t),n=r(e,e.neg(e.ONE)),s=r(e,n),o=r(e,e.neg(n)),i=(t+As)/Nr;return(a,l)=>{let d=a.pow(l,i),p=a.mul(d,n);const g=a.mul(d,s),u=a.mul(d,o),f=a.eql(a.sqr(p),l),x=a.eql(a.sqr(g),l);d=a.cmov(d,p,f),p=a.cmov(u,g,x);const S=a.eql(a.sqr(p),l),I=a.cmov(d,p,S);return On(a,I,l),I}}function Ir(t){if(t<Br)throw new Error("sqrt is not defined for small field");let e=t-G,r=0;for(;e%Rt===Q;)e/=Rt,r++;let n=Rt;const s=ve(t);for(;er(s,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(r===1)return Rr;let o=s.pow(n,e);const i=(e+G)/Rt;return function(l,d){if(l.is0(d))return d;if(er(l,d)!==1)throw new Error("Cannot find square root");let p=r,g=l.mul(l.ONE,o),u=l.pow(d,e),f=l.pow(d,i);for(;!l.eql(u,l.ONE);){if(l.is0(u))return l.ZERO;let x=1,S=l.sqr(u);for(;!l.eql(S,l.ONE);)if(x++,S=l.sqr(S),x===p)throw new Error("Cannot find square root");const I=G<<BigInt(p-x-1),b=l.pow(g,I);p=x,g=l.sqr(b),u=l.mul(u,g),f=l.mul(f,b)}return f}}function Rs(t){return t%Ar===Br?Rr:t%Lr===Cr?Ls:t%Nr===Cs?Ns(t):Ir(t)}const Is=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Ts(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},r=Is.reduce((n,s)=>(n[s]="function",n),e);return $n(t,r),t}function Ms(t,e,r){if(r<Q)throw new Error("invalid exponent, negatives unsupported");if(r===Q)return t.ONE;if(r===G)return e;let n=t.ONE,s=e;for(;r>Q;)r&G&&(n=t.mul(n,s)),s=t.sqr(s),r>>=G;return n}function Tr(t,e,r=!1){const n=new Array(e.length).fill(r?t.ZERO:void 0),s=e.reduce((i,a,l)=>t.is0(a)?i:(n[l]=i,t.mul(i,a)),t.ONE),o=t.inv(s);return e.reduceRight((i,a,l)=>t.is0(a)?i:(n[l]=t.mul(i,n[l]),t.mul(i,a)),o),n}function er(t,e){const r=(t.ORDER-G)/Rt,n=t.pow(e,r),s=t.eql(n,t.ONE),o=t.eql(n,t.ZERO),i=t.eql(n,t.neg(t.ONE));if(!s&&!o&&!i)throw new Error("invalid Legendre symbol result");return s?1:o?0:-1}function Mr(t,e){e!==void 0&&vn(e);const r=e!==void 0?e:t.toString(2).length,n=Math.ceil(r/8);return{nBitLength:r,nByteLength:n}}function ve(t,e,r=!1,n={}){if(t<=Q)throw new Error("invalid field: expected ORDER > 0, got "+t);let s,o,i=!1,a;if(typeof e=="object"&&e!=null){if(n.sqrt||r)throw new Error("cannot specify opts in two arguments");const u=e;u.BITS&&(s=u.BITS),u.sqrt&&(o=u.sqrt),typeof u.isLE=="boolean"&&(r=u.isLE),typeof u.modFromBytes=="boolean"&&(i=u.modFromBytes),a=u.allowedLengths}else typeof e=="number"&&(s=e),n.sqrt&&(o=n.sqrt);const{nBitLength:l,nByteLength:d}=Mr(t,s);if(d>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let p;const g=Object.freeze({ORDER:t,isLE:r,BITS:l,BYTES:d,MASK:Ee(l),ZERO:Q,ONE:G,allowedLengths:a,create:u=>st(u,t),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return Q<=u&&u<t},is0:u=>u===Q,isValidNot0:u=>!g.is0(u)&&g.isValid(u),isOdd:u=>(u&G)===G,neg:u=>st(-u,t),eql:(u,f)=>u===f,sqr:u=>st(u*u,t),add:(u,f)=>st(u+f,t),sub:(u,f)=>st(u-f,t),mul:(u,f)=>st(u*f,t),pow:(u,f)=>Ms(g,u,f),div:(u,f)=>st(u*tr(f,t),t),sqrN:u=>u*u,addN:(u,f)=>u+f,subN:(u,f)=>u-f,mulN:(u,f)=>u*f,inv:u=>tr(u,t),sqrt:o||(u=>(p||(p=Rs(t)),p(g,u))),toBytes:u=>r?_r(u,d):Ye(u,d),fromBytes:(u,f=!0)=>{if(a){if(!a.includes(u.length)||u.length>d)throw new Error("Field.fromBytes: expected "+a+" bytes, got "+u.length);const S=new Uint8Array(d);S.set(u,r?0:S.length-u.length),u=S}if(u.length!==d)throw new Error("Field.fromBytes: expected "+d+" bytes, got "+u.length);let x=r?Sr(u):Jt(u);if(i&&(x=st(x,t)),!f&&!g.isValid(x))throw new Error("invalid field element: outside of range 0..ORDER");return x},invertBatch:u=>Tr(g,u),cmov:(u,f,x)=>x?f:u});return Object.freeze(g)}function $r(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function Or(t){const e=$r(t);return e+Math.ceil(e/2)}function Pr(t,e,r=!1){const n=t.length,s=$r(e),o=Or(e);if(n<16||n<o||n>1024)throw new Error("expected "+o+"-1024 bytes of input, got "+n);const i=r?Sr(t):Jt(t),a=st(i,e-G)+G;return r?_r(a,s):Ye(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const zt=BigInt(0),It=BigInt(1);function qe(t,e){const r=e.negate();return t?r:e}function rn(t,e){const r=Tr(t.Fp,e.map(n=>n.Z));return e.map((n,s)=>t.fromAffine(n.toAffine(r[s])))}function qr(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function sn(t,e){qr(t,e);const r=Math.ceil(e/t)+1,n=2**(t-1),s=2**t,o=Ee(t),i=BigInt(t);return{windows:r,windowSize:n,mask:o,maxNumber:s,shiftBy:i}}function nr(t,e,r){const{windowSize:n,mask:s,maxNumber:o,shiftBy:i}=r;let a=Number(t&s),l=t>>i;a>n&&(a-=o,l+=It);const d=e*n,p=d+Math.abs(a)-1,g=a===0,u=a<0,f=e%2!==0;return{nextN:l,offset:p,isZero:g,isNeg:u,isNegF:f,offsetF:d}}function $s(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((r,n)=>{if(!(r instanceof e))throw new Error("invalid point at index "+n)})}function Os(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((r,n)=>{if(!e.isValid(r))throw new Error("invalid scalar at index "+n)})}const on=new WeakMap,Hr=new WeakMap;function cn(t){return Hr.get(t)||1}function rr(t){if(t!==zt)throw new Error("invalid wNAF")}class Ps{constructor(e,r){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=r}_unsafeLadder(e,r,n=this.ZERO){let s=e;for(;r>zt;)r&It&&(n=n.add(s)),s=s.double(),r>>=It;return n}precomputeWindow(e,r){const{windows:n,windowSize:s}=sn(r,this.bits),o=[];let i=e,a=i;for(let l=0;l<n;l++){a=i,o.push(a);for(let d=1;d<s;d++)a=a.add(i),o.push(a);i=a.double()}return o}wNAF(e,r,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let s=this.ZERO,o=this.BASE;const i=sn(e,this.bits);for(let a=0;a<i.windows;a++){const{nextN:l,offset:d,isZero:p,isNeg:g,isNegF:u,offsetF:f}=nr(n,a,i);n=l,p?o=o.add(qe(u,r[f])):s=s.add(qe(g,r[d]))}return rr(n),{p:s,f:o}}wNAFUnsafe(e,r,n,s=this.ZERO){const o=sn(e,this.bits);for(let i=0;i<o.windows&&n!==zt;i++){const{nextN:a,offset:l,isZero:d,isNeg:p}=nr(n,i,o);if(n=a,!d){const g=r[l];s=s.add(p?g.negate():g)}}return rr(n),s}getPrecomputes(e,r,n){let s=on.get(r);return s||(s=this.precomputeWindow(r,e),e!==1&&(typeof n=="function"&&(s=n(s)),on.set(r,s))),s}cached(e,r,n){const s=cn(e);return this.wNAF(s,this.getPrecomputes(s,e,n),r)}unsafe(e,r,n,s){const o=cn(e);return o===1?this._unsafeLadder(e,r,s):this.wNAFUnsafe(o,this.getPrecomputes(o,e,n),r,s)}createCache(e,r){qr(r,this.bits),Hr.set(e,r),on.delete(e)}hasCache(e){return cn(e)!==1}}function qs(t,e,r,n){let s=e,o=t.ZERO,i=t.ZERO;for(;r>zt||n>zt;)r&It&&(o=o.add(s)),n&It&&(i=i.add(s)),s=s.double(),r>>=It,n>>=It;return{p1:o,p2:i}}function Hs(t,e,r,n){$s(r,t),Os(n,e);const s=r.length,o=n.length;if(s!==o)throw new Error("arrays of points and scalars must have equal length");const i=t.ZERO,a=kr(BigInt(s));let l=1;a>12?l=a-3:a>4?l=a-2:a>0&&(l=2);const d=Ee(l),p=new Array(Number(d)+1).fill(i),g=Math.floor((e.BITS-1)/l)*l;let u=i;for(let f=g;f>=0;f-=l){p.fill(i);for(let S=0;S<o;S++){const I=n[S],b=Number(I>>BigInt(f)&d);p[b]=p[b].add(r[S])}let x=i;for(let S=p.length-1,I=i;S>0;S--)I=I.add(p[S]),x=x.add(I);if(u=u.add(x),f!==0)for(let S=0;S<l;S++)u=u.double()}return u}function sr(t,e,r){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Ts(e),e}else return ve(t,{isLE:r})}function Us(t,e,r={},n){if(n===void 0&&(n=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const l of["p","n","h"]){const d=e[l];if(!(typeof d=="bigint"&&d>zt))throw new Error(`CURVE.${l} must be positive bigint`)}const s=sr(e.p,r.Fp,n),o=sr(e.n,r.Fn,n),a=["Gx","Gy","a","b"];for(const l of a)if(!s.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:o}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const or=(t,e)=>(t+(t>=0?e:-e)/Ur)/e;function Ks(t,e,r){const[[n,s],[o,i]]=e,a=or(i*t,r),l=or(-s*t,r);let d=t-a*n-l*o,p=-a*s-l*i;const g=d<wt,u=p<wt;g&&(d=-d),u&&(p=-p);const f=Ee(Math.ceil(kr(r)/2))+Ht;if(d<wt||d>=f||p<wt||p>=f)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:g,k1:d,k2neg:u,k2:p}}function _n(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function an(t,e){const r={};for(let n of Object.keys(e))r[n]=t[n]===void 0?e[n]:t[n];return Pe(r.lowS,"lowS"),Pe(r.prehash,"prehash"),r.format!==void 0&&_n(r.format),r}class Ds extends Error{constructor(e=""){super(e)}}const yt={Err:Ds,_tlv:{encode:(t,e)=>{const{Err:r}=yt;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length&1)throw new r("tlv.encode: unpadded data");const n=e.length/2,s=Se(n);if(s.length/2&128)throw new r("tlv.encode: long form length too big");const o=n>127?Se(s.length/2|128):"";return Se(t)+o+s+e},decode(t,e){const{Err:r}=yt;let n=0;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new r("tlv.decode: wrong tlv");const s=e[n++],o=!!(s&128);let i=0;if(!o)i=s;else{const l=s&127;if(!l)throw new r("tlv.decode(long): indefinite length not supported");if(l>4)throw new r("tlv.decode(long): byte length is too big");const d=e.subarray(n,n+l);if(d.length!==l)throw new r("tlv.decode: length bytes not complete");if(d[0]===0)throw new r("tlv.decode(long): zero leftmost byte");for(const p of d)i=i<<8|p;if(n+=l,i<128)throw new r("tlv.decode(long): not minimal encoding")}const a=e.subarray(n,n+i);if(a.length!==i)throw new r("tlv.decode: wrong value length");return{v:a,l:e.subarray(n+i)}}},_int:{encode(t){const{Err:e}=yt;if(t<wt)throw new e("integer: negative integers are not allowed");let r=Se(t);if(Number.parseInt(r[0],16)&8&&(r="00"+r),r.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return r},decode(t){const{Err:e}=yt;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Jt(t)}},toSig(t){const{Err:e,_int:r,_tlv:n}=yt,s=Z("signature",t),{v:o,l:i}=n.decode(48,s);if(i.length)throw new e("invalid signature: left bytes after parsing");const{v:a,l}=n.decode(2,o),{v:d,l:p}=n.decode(2,l);if(p.length)throw new e("invalid signature: left bytes after parsing");return{r:r.decode(a),s:r.decode(d)}},hexFromSig(t){const{_tlv:e,_int:r}=yt,n=e.encode(2,r.encode(t.r)),s=e.encode(2,r.encode(t.s)),o=n+s;return e.encode(48,o)}},wt=BigInt(0),Ht=BigInt(1),Ur=BigInt(2),_e=BigInt(3),zs=BigInt(4);function Tt(t,e){const{BYTES:r}=t;let n;if(typeof e=="bigint")n=e;else{let s=Z("private key",e);try{n=t.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${r}, got ${typeof e}`)}}if(!t.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function Zs(t,e={}){const r=Us("weierstrass",t,e),{Fp:n,Fn:s}=r;let o=r.CURVE;const{h:i,n:a}=o;$n(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!n.is0(o.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const d=Dr(n,s);function p(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function g(M,y,h){const{x:m,y:E}=y.toAffine(),_=n.toBytes(m);if(Pe(h,"isCompressed"),h){p();const A=!n.isOdd(E);return ft(Kr(A),_)}else return ft(Uint8Array.of(4),_,n.toBytes(E))}function u(M){Nt(M,void 0,"Point");const{publicKey:y,publicKeyUncompressed:h}=d,m=M.length,E=M[0],_=M.subarray(1);if(m===y&&(E===2||E===3)){const A=n.fromBytes(_);if(!n.isValid(A))throw new Error("bad point: is not on curve, wrong x");const B=S(A);let k;try{k=n.sqrt(B)}catch(D){const O=D instanceof Error?": "+D.message:"";throw new Error("bad point: is not on curve, sqrt error"+O)}p();const C=n.isOdd(k);return(E&1)===1!==C&&(k=n.neg(k)),{x:A,y:k}}else if(m===h&&E===4){const A=n.BYTES,B=n.fromBytes(_.subarray(0,A)),k=n.fromBytes(_.subarray(A,A*2));if(!I(B,k))throw new Error("bad point: is not on curve");return{x:B,y:k}}else throw new Error(`bad point: got length ${m}, expected compressed=${y} or uncompressed=${h}`)}const f=e.toBytes||g,x=e.fromBytes||u;function S(M){const y=n.sqr(M),h=n.mul(y,M);return n.add(n.add(h,n.mul(M,o.a)),o.b)}function I(M,y){const h=n.sqr(y),m=S(M);return n.eql(h,m)}if(!I(o.Gx,o.Gy))throw new Error("bad curve params: generator point");const b=n.mul(n.pow(o.a,_e),zs),R=n.mul(n.sqr(o.b),BigInt(27));if(n.is0(n.add(b,R)))throw new Error("bad curve params: a or b");function $(M,y,h=!1){if(!n.isValid(y)||h&&n.is0(y))throw new Error(`bad point coordinate ${M}`);return y}function U(M){if(!(M instanceof w))throw new Error("ProjectivePoint expected")}function K(M){if(!l||!l.basises)throw new Error("no endo");return Ks(M,l.basises,s.ORDER)}const W=Qn((M,y)=>{const{X:h,Y:m,Z:E}=M;if(n.eql(E,n.ONE))return{x:h,y:m};const _=M.is0();y==null&&(y=_?n.ONE:n.inv(E));const A=n.mul(h,y),B=n.mul(m,y),k=n.mul(E,y);if(_)return{x:n.ZERO,y:n.ZERO};if(!n.eql(k,n.ONE))throw new Error("invZ was invalid");return{x:A,y:B}}),ot=Qn(M=>{if(M.is0()){if(e.allowInfinityPoint&&!n.is0(M.Y))return;throw new Error("bad point: ZERO")}const{x:y,y:h}=M.toAffine();if(!n.isValid(y)||!n.isValid(h))throw new Error("bad point: x or y not field elements");if(!I(y,h))throw new Error("bad point: equation left != right");if(!M.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function it(M,y,h,m,E){return h=new w(n.mul(h.X,M),h.Y,h.Z),y=qe(m,y),h=qe(E,h),y.add(h)}class w{constructor(y,h,m){this.X=$("x",y),this.Y=$("y",h,!0),this.Z=$("z",m),Object.freeze(this)}static CURVE(){return o}static fromAffine(y){const{x:h,y:m}=y||{};if(!y||!n.isValid(h)||!n.isValid(m))throw new Error("invalid affine point");if(y instanceof w)throw new Error("projective point not allowed");return n.is0(h)&&n.is0(m)?w.ZERO:new w(h,m,n.ONE)}static fromBytes(y){const h=w.fromAffine(x(Nt(y,void 0,"point")));return h.assertValidity(),h}static fromHex(y){return w.fromBytes(Z("pointHex",y))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(y=8,h=!0){return F.createCache(this,y),h||this.multiply(_e),this}assertValidity(){ot(this)}hasEvenY(){const{y}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(y)}equals(y){U(y);const{X:h,Y:m,Z:E}=this,{X:_,Y:A,Z:B}=y,k=n.eql(n.mul(h,B),n.mul(_,E)),C=n.eql(n.mul(m,B),n.mul(A,E));return k&&C}negate(){return new w(this.X,n.neg(this.Y),this.Z)}double(){const{a:y,b:h}=o,m=n.mul(h,_e),{X:E,Y:_,Z:A}=this;let B=n.ZERO,k=n.ZERO,C=n.ZERO,N=n.mul(E,E),D=n.mul(_,_),O=n.mul(A,A),T=n.mul(E,_);return T=n.add(T,T),C=n.mul(E,A),C=n.add(C,C),B=n.mul(y,C),k=n.mul(m,O),k=n.add(B,k),B=n.sub(D,k),k=n.add(D,k),k=n.mul(B,k),B=n.mul(T,B),C=n.mul(m,C),O=n.mul(y,O),T=n.sub(N,O),T=n.mul(y,T),T=n.add(T,C),C=n.add(N,N),N=n.add(C,N),N=n.add(N,O),N=n.mul(N,T),k=n.add(k,N),O=n.mul(_,A),O=n.add(O,O),N=n.mul(O,T),B=n.sub(B,N),C=n.mul(O,D),C=n.add(C,C),C=n.add(C,C),new w(B,k,C)}add(y){U(y);const{X:h,Y:m,Z:E}=this,{X:_,Y:A,Z:B}=y;let k=n.ZERO,C=n.ZERO,N=n.ZERO;const D=o.a,O=n.mul(o.b,_e);let T=n.mul(h,_),P=n.mul(m,A),z=n.mul(E,B),X=n.add(h,m),q=n.add(_,A);X=n.mul(X,q),q=n.add(T,P),X=n.sub(X,q),q=n.add(h,E);let j=n.add(_,B);return q=n.mul(q,j),j=n.add(T,z),q=n.sub(q,j),j=n.add(m,E),k=n.add(A,B),j=n.mul(j,k),k=n.add(P,z),j=n.sub(j,k),N=n.mul(D,q),k=n.mul(O,z),N=n.add(k,N),k=n.sub(P,N),N=n.add(P,N),C=n.mul(k,N),P=n.add(T,T),P=n.add(P,T),z=n.mul(D,z),q=n.mul(O,q),P=n.add(P,z),z=n.sub(T,z),z=n.mul(D,z),q=n.add(q,z),T=n.mul(P,q),C=n.add(C,T),T=n.mul(j,q),k=n.mul(X,k),k=n.sub(k,T),T=n.mul(X,P),N=n.mul(j,N),N=n.add(N,T),new w(k,C,N)}subtract(y){return this.add(y.negate())}is0(){return this.equals(w.ZERO)}multiply(y){const{endo:h}=e;if(!s.isValidNot0(y))throw new Error("invalid scalar: out of range");let m,E;const _=A=>F.cached(this,A,B=>rn(w,B));if(h){const{k1neg:A,k1:B,k2neg:k,k2:C}=K(y),{p:N,f:D}=_(B),{p:O,f:T}=_(C);E=D.add(T),m=it(h.beta,N,O,A,k)}else{const{p:A,f:B}=_(y);m=A,E=B}return rn(w,[m,E])[0]}multiplyUnsafe(y){const{endo:h}=e,m=this;if(!s.isValid(y))throw new Error("invalid scalar: out of range");if(y===wt||m.is0())return w.ZERO;if(y===Ht)return m;if(F.hasCache(this))return this.multiply(y);if(h){const{k1neg:E,k1:_,k2neg:A,k2:B}=K(y),{p1:k,p2:C}=qs(w,m,_,B);return it(h.beta,k,C,E,A)}else return F.unsafe(m,y)}multiplyAndAddUnsafe(y,h,m){const E=this.multiplyUnsafe(h).add(y.multiplyUnsafe(m));return E.is0()?void 0:E}toAffine(y){return W(this,y)}isTorsionFree(){const{isTorsionFree:y}=e;return i===Ht?!0:y?y(w,this):F.unsafe(this,a).is0()}clearCofactor(){const{clearCofactor:y}=e;return i===Ht?this:y?y(w,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(y=!0){return Pe(y,"isCompressed"),this.assertValidity(),f(w,this,y)}toHex(y=!0){return lt(this.toBytes(y))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(y=!0){return this.toBytes(y)}_setWindowSize(y){this.precompute(y)}static normalizeZ(y){return rn(w,y)}static msm(y,h){return Hs(w,s,y,h)}static fromPrivateKey(y){return w.BASE.multiply(Tt(s,y))}}w.BASE=new w(o.Gx,o.Gy,n.ONE),w.ZERO=new w(n.ZERO,n.ONE,n.ZERO),w.Fp=n,w.Fn=s;const L=s.BITS,F=new Ps(w,e.endo?Math.ceil(L/2):L);return w.BASE.precompute(8),w}function Kr(t){return Uint8Array.of(t?2:3)}function Dr(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function Vs(t,e={}){const{Fn:r}=t,n=e.randomBytes||je,s=Object.assign(Dr(t.Fp,r),{seed:Or(r.ORDER)});function o(f){try{return!!Tt(r,f)}catch{return!1}}function i(f,x){const{publicKey:S,publicKeyUncompressed:I}=s;try{const b=f.length;return x===!0&&b!==S||x===!1&&b!==I?!1:!!t.fromBytes(f)}catch{return!1}}function a(f=n(s.seed)){return Pr(Nt(f,s.seed,"seed"),r.ORDER)}function l(f,x=!0){return t.BASE.multiply(Tt(r,f)).toBytes(x)}function d(f){const x=a(f);return{secretKey:x,publicKey:l(x)}}function p(f){if(typeof f=="bigint")return!1;if(f instanceof t)return!0;const{secretKey:x,publicKey:S,publicKeyUncompressed:I}=s;if(r.allowedLengths||x===S)return;const b=Z("key",f).length;return b===S||b===I}function g(f,x,S=!0){if(p(f)===!0)throw new Error("first arg must be private key");if(p(x)===!1)throw new Error("second arg must be public key");const I=Tt(r,f);return t.fromHex(x).multiply(I).toBytes(S)}return Object.freeze({getPublicKey:l,getSharedSecret:g,keygen:d,Point:t,utils:{isValidSecretKey:o,isValidPublicKey:i,randomSecretKey:a,isValidPrivateKey:o,randomPrivateKey:a,normPrivateKeyToScalar:f=>Tt(r,f),precompute(f=8,x=t.BASE){return x.precompute(f,!1)}},lengths:s})}function js(t,e,r={}){yr(e),$n(r,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=r.randomBytes||je,s=r.hmac||((h,...m)=>vr(e,h,ft(...m))),{Fp:o,Fn:i}=t,{ORDER:a,BITS:l}=i,{keygen:d,getPublicKey:p,getSharedSecret:g,utils:u,lengths:f}=Vs(t,r),x={prehash:!1,lowS:typeof r.lowS=="boolean"?r.lowS:!1,format:void 0,extraEntropy:!1},S="compact";function I(h){const m=a>>Ht;return h>m}function b(h,m){if(!i.isValidNot0(m))throw new Error(`invalid signature ${h}: out of range 1..Point.Fn.ORDER`);return m}function R(h,m){_n(m);const E=f.signature,_=m==="compact"?E:m==="recovered"?E+1:void 0;return Nt(h,_,`${m} signature`)}class ${constructor(m,E,_){this.r=b("r",m),this.s=b("s",E),_!=null&&(this.recovery=_),Object.freeze(this)}static fromBytes(m,E=S){R(m,E);let _;if(E==="der"){const{r:C,s:N}=yt.toSig(Nt(m));return new $(C,N)}E==="recovered"&&(_=m[0],E="compact",m=m.subarray(1));const A=i.BYTES,B=m.subarray(0,A),k=m.subarray(A,A*2);return new $(i.fromBytes(B),i.fromBytes(k),_)}static fromHex(m,E){return this.fromBytes(Dt(m),E)}addRecoveryBit(m){return new $(this.r,this.s,m)}recoverPublicKey(m){const E=o.ORDER,{r:_,s:A,recovery:B}=this;if(B==null||![0,1,2,3].includes(B))throw new Error("recovery id invalid");if(a*Ur<E&&B>1)throw new Error("recovery id is ambiguous for h>1 curve");const C=B===2||B===3?_+a:_;if(!o.isValid(C))throw new Error("recovery id 2 or 3 invalid");const N=o.toBytes(C),D=t.fromBytes(ft(Kr((B&1)===0),N)),O=i.inv(C),T=K(Z("msgHash",m)),P=i.create(-T*O),z=i.create(A*O),X=t.BASE.multiplyUnsafe(P).add(D.multiplyUnsafe(z));if(X.is0())throw new Error("point at infinify");return X.assertValidity(),X}hasHighS(){return I(this.s)}toBytes(m=S){if(_n(m),m==="der")return Dt(yt.hexFromSig(this));const E=i.toBytes(this.r),_=i.toBytes(this.s);if(m==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return ft(Uint8Array.of(this.recovery),E,_)}return ft(E,_)}toHex(m){return lt(this.toBytes(m))}assertValidity(){}static fromCompact(m){return $.fromBytes(Z("sig",m),"compact")}static fromDER(m){return $.fromBytes(Z("sig",m),"der")}normalizeS(){return this.hasHighS()?new $(this.r,i.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return lt(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return lt(this.toBytes("compact"))}}const U=r.bits2int||function(m){if(m.length>8192)throw new Error("input is too large");const E=Jt(m),_=m.length*8-l;return _>0?E>>BigInt(_):E},K=r.bits2int_modN||function(m){return i.create(U(m))},W=Ee(l);function ot(h){return ks("num < 2^"+l,h,wt,W),i.toBytes(h)}function it(h,m){return Nt(h,void 0,"message"),m?Nt(e(h),void 0,"prehashed message"):h}function w(h,m,E){if(["recovered","canonical"].some(P=>P in E))throw new Error("sign() legacy options not supported");const{lowS:_,prehash:A,extraEntropy:B}=an(E,x);h=it(h,A);const k=K(h),C=Tt(i,m),N=[ot(C),ot(k)];if(B!=null&&B!==!1){const P=B===!0?n(f.secretKey):B;N.push(Z("extraEntropy",P))}const D=ft(...N),O=k;function T(P){const z=U(P);if(!i.isValidNot0(z))return;const X=i.inv(z),q=t.BASE.multiply(z).toAffine(),j=i.create(q.x);if(j===wt)return;const xe=i.create(X*i.create(O+j*C));if(xe===wt)return;let Jn=(q.x===j?0:2)|Number(q.y&Ht),Wn=xe;return _&&I(xe)&&(Wn=i.neg(xe),Jn^=1),new $(j,Wn,Jn)}return{seed:D,k2sig:T}}function L(h,m,E={}){h=Z("message",h);const{seed:_,k2sig:A}=w(h,m,E);return Bs(e.outputLen,i.BYTES,s)(_,A)}function F(h){let m;const E=typeof h=="string"||Ze(h),_=!E&&h!==null&&typeof h=="object"&&typeof h.r=="bigint"&&typeof h.s=="bigint";if(!E&&!_)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(_)m=new $(h.r,h.s);else if(E){try{m=$.fromBytes(Z("sig",h),"der")}catch(A){if(!(A instanceof yt.Err))throw A}if(!m)try{m=$.fromBytes(Z("sig",h),"compact")}catch{return!1}}return m||!1}function M(h,m,E,_={}){const{lowS:A,prehash:B,format:k}=an(_,x);if(E=Z("publicKey",E),m=it(Z("message",m),B),"strict"in _)throw new Error("options.strict was renamed to lowS");const C=k===void 0?F(h):$.fromBytes(Z("sig",h),k);if(C===!1)return!1;try{const N=t.fromBytes(E);if(A&&C.hasHighS())return!1;const{r:D,s:O}=C,T=K(m),P=i.inv(O),z=i.create(T*P),X=i.create(D*P),q=t.BASE.multiplyUnsafe(z).add(N.multiplyUnsafe(X));return q.is0()?!1:i.create(q.x)===D}catch{return!1}}function y(h,m,E={}){const{prehash:_}=an(E,x);return m=it(m,_),$.fromBytes(h,"recovered").recoverPublicKey(m).toBytes()}return Object.freeze({keygen:d,getPublicKey:p,getSharedSecret:g,utils:u,lengths:f,Point:t,sign:L,verify:M,recoverPublicKey:y,Signature:$,hash:e})}function Ys(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},r=t.Fp;let n=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(i=>Math.ceil(i/2)))):void 0;const s=ve(e.n,{BITS:t.nBitLength,allowedLengths:n,modFromBytes:t.wrapPrivateKey}),o={Fp:r,Fn:s,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:o}}function Fs(t){const{CURVE:e,curveOpts:r}=Ys(t),n={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:r,hash:t.hash,ecdsaOpts:n}}function Gs(t,e){const r=e.Point;return Object.assign({},e,{ProjectivePoint:r,CURVE:Object.assign({},t,Mr(r.Fn.ORDER,r.Fn.BITS))})}function Js(t){const{CURVE:e,curveOpts:r,hash:n,ecdsaOpts:s}=Fs(t),o=Zs(e,r),i=js(o,n,s);return Gs(t,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Ws(t,e){const r=n=>Js({...t,hash:n});return{...r(e),create:r}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Zt={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Xs={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Qs=BigInt(0),ir=BigInt(1),kn=BigInt(2);function to(t){const e=Zt.p,r=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),l=BigInt(88),d=t*t*t%e,p=d*d*t%e,g=rt(p,r,e)*p%e,u=rt(g,r,e)*p%e,f=rt(u,kn,e)*d%e,x=rt(f,s,e)*f%e,S=rt(x,o,e)*x%e,I=rt(S,a,e)*S%e,b=rt(I,l,e)*I%e,R=rt(b,a,e)*S%e,$=rt(R,r,e)*p%e,U=rt($,i,e)*x%e,K=rt(U,n,e)*d%e,W=rt(K,kn,e);if(!He.eql(He.sqr(W),t))throw new Error("Cannot find square root");return W}const He=ve(Zt.p,{sqrt:to}),Pn=Ws({...Zt,Fp:He,lowS:!0,endo:Xs},Oe),cr={};function Ue(t,...e){let r=cr[t];if(r===void 0){const n=Oe(Ve(t));r=ft(n,n),cr[t]=r}return Oe(ft(r,...e))}const qn=t=>t.toBytes(!0).slice(1),Wt=Pn.Point,Hn=t=>t%kn===Qs;function Bn(t){const{Fn:e,BASE:r}=Wt,n=Tt(e,t),s=r.multiply(n);return{scalar:Hn(s.y)?n:e.neg(n),bytes:qn(s)}}function zr(t){const e=He;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x ≥ p");const r=e.create(t*t),n=e.create(r*t+BigInt(7));let s=e.sqrt(n);Hn(s)||(s=e.neg(s));const o=Wt.fromAffine({x:t,y:s});return o.assertValidity(),o}const ee=Jt;function Zr(...t){return Wt.Fn.create(ee(Ue("BIP0340/challenge",...t)))}function ar(t){return Bn(t).bytes}function eo(t,e,r=je(32)){const{Fn:n}=Wt,s=Z("message",t),{bytes:o,scalar:i}=Bn(e),a=Z("auxRand",r,32),l=n.toBytes(i^ee(Ue("BIP0340/aux",a))),d=Ue("BIP0340/nonce",l,o,s),{bytes:p,scalar:g}=Bn(d),u=Zr(p,o,s),f=new Uint8Array(64);if(f.set(p,0),f.set(n.toBytes(n.create(g+u*i)),32),!Vr(f,s,o))throw new Error("sign: Invalid signature produced");return f}function Vr(t,e,r){const{Fn:n,BASE:s}=Wt,o=Z("signature",t,64),i=Z("message",e),a=Z("publicKey",r,32);try{const l=zr(ee(a)),d=ee(o.subarray(0,32));if(!Sn(d,ir,Zt.p))return!1;const p=ee(o.subarray(32,64));if(!Sn(p,ir,Zt.n))return!1;const g=Zr(n.toBytes(d),qn(l),i),u=s.multiplyUnsafe(p).add(l.multiplyUnsafe(n.neg(g))),{x:f,y:x}=u.toAffine();return!(u.is0()||!Hn(x)||f!==d)}catch{return!1}}const jr=(()=>{const r=(s=je(48))=>Pr(s,Zt.n);Pn.utils.randomSecretKey;function n(s){const o=r(s);return{secretKey:o,publicKey:ar(o)}}return{keygen:n,getPublicKey:ar,sign:eo,verify:Vr,Point:Wt,utils:{randomSecretKey:r,randomPrivateKey:r,taggedHash:Ue,lift_x:zr,pointToBytes:qn,numberToBytesBE:Ye,bytesToNumberBE:Jt,mod:st},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),v=t=>document.getElementById(t),c={settings:null,currentRoom:"#test",rooms:[],roomCounts:{},attachments:[],maxImageKB:300,maxPayloadKB:450,peers:new Map,sessions:new Map,pendingOffers:new Map,lastRelayNotice:"",lastRelayDetail:"",pendingRelayDetail:!1,relayPollId:null,relayItems:[],messagePollId:null,lastMessageId:new Map,initialBuffering:!1,bufferedMessages:[],bufferTimer:null,replyTo:null,isAtBottom:!0},bt=new Map,Vt=new Map,ge=new Set,jt=new Map;let Fe="echochan-web";const Y=(()=>{const t=new Map;let e=null,r=null,n=!1;const s=[];function o(b){const R=s.indexOf(b);R>=0&&s.splice(R,1),s.unshift(b)}function i(b){!b||!b.id||(t.set(b.id,b),o(b.id),_t())}function a(b){if(!b)return;t.delete(b);const R=s.indexOf(b);R>=0&&s.splice(R,1),e===b&&(e=null,r=null,n=!1),_t()}function l(b){var R;for(const[$,U]of t.entries())if($!==b)try{(R=U.pause)==null||R.call(U)}catch{}}function d(b){var R;t.has(b)&&(l(b),e=b,r=((R=t.get(b))==null?void 0:R.type)||null,n=!0,o(b),_t())}function p(b){e===b&&(n=!1,_t())}function g(){var R;const b=e?t.get(e):null;if(b)try{(R=b.play)==null||R.call(b),n=!0,_t()}catch{}}function u(){var R;const b=e?t.get(e):null;if(b)try{(R=b.pause)==null||R.call(b),n=!1,_t()}catch{}}function f(){var R;const b=e?t.get(e):null;if(b){try{(R=b.stop)==null||R.call(b)}catch{}n=!1,e=null,r=null,_t()}}function x(){var W;if(t.size<2)return;const b=s.filter(ot=>t.has(ot)),R=b.indexOf(e),$=R>=0?(R+1)%b.length:0,U=b[$];if(!U)return;d(U);const K=t.get(U);(W=K==null?void 0:K.play)==null||W.call(K)}function S(){var b;for(const R of t.values())try{(b=R.stop)==null||b.call(R)}catch{}t.clear(),s.length=0,e=null,r=null,n=!1,_t()}function I(){return e&&t.get(e)||null}return{registerSource:i,unregisterSource:a,requestFocus:d,markPaused:p,playCurrent:g,pauseCurrent:u,stopCurrent:f,switchSource:x,clearAll:S,getCurrent:I,isPlaying:()=>n,currentType:()=>r}})(),te=new Map,Un=async(t,e)=>(te.has(t)||te.set(t,new Set),te.get(t).add(e),()=>{var r;return(r=te.get(t))==null?void 0:r.delete(e)});function An(t,e){const r=te.get(t);r&&r.forEach(n=>n({payload:e}))}const J=async(t,e={})=>{switch(t){case"get_state":return Mo();case"save_settings":return $o(e.settings);case"add_room":return Oo(e.room);case"remove_room":return Po(e.room);case"get_room_messages":return qo(e.room);case"connect_relays":return Ho();case"send_message":return Uo(e.message);case"send_signal":return Ko(e.signal);case"check_tor":throw new Error("Tor is not supported in the web build.");default:throw new Error(`Unknown command: ${t}`)}},lr=v("room-list"),Cn=v("command-input"),mt=v("message-input"),V=v("messages"),ur=v("inline-previews"),no=v("relay-status"),Yt=v("current-room"),Yr=v("connect-btn"),ro=v("send-btn"),so=v("attach-btn"),ln=v("p2p-btn"),oo=v("settings-btn"),kt=v("settings-modal"),ke=kt==null?void 0:kt.querySelector(".modal-content"),io=v("settings-close"),co=v("settings-save"),un=v("relay-test"),dn=v("relay-defaults"),fn=v("tor-check"),mn=v("relay-prune"),Be=v("relay-status-list"),we=v("confirm-modal"),ao=v("confirm-title"),lo=v("confirm-body"),Fr=v("confirm-ok"),uo=v("confirm-cancel"),tt=v("nick-input"),at=v("relay-input"),ne=v("stun-input"),re=v("turn-input"),se=v("turn-username"),oe=v("turn-password"),At=v("max-image-kb"),Ct=v("max-payload-kb"),ie=v("supabase-upload-toggle"),ce=v("supabase-url"),ae=v("supabase-anon-key"),le=v("supabase-bucket"),ue=v("tor-toggle"),de=v("proxy-input"),fe=v("max-p2p-mb"),me=v("p2p-timeout"),he=v("p2p-recent-min"),pe=v("p2p-max-sessions"),Ln=v("file-input"),Mt=v("p2p-file-input"),Et=v("target-select");v("p2p-inbox");const Qt=v("relay-errors"),fo=v("toast-stack"),Ge=v("image-viewer"),Gr=v("viewer-image"),Ut=v("jump-latest"),hn=v("sidebar-toggle"),pn=v("sidebar-overlay"),yn=v("reply-bar"),Ae=v("reply-nick"),Ce=v("reply-snippet"),gn=v("reply-cancel"),wn=v("now-playing"),Le=v("np-title"),Ne=v("np-meta"),ye=v("np-play"),bn=v("np-stop"),En=v("np-switch"),dr=16*1024,mo=44;let Ie=null;const Jr=["wss://nos.lol","wss://relay.nostr.net","wss://www.nostr.ltd"];function Lt(t,e="info",r=6e3){if(!t)return;const n=document.createElement("div");n.className=`toast ${e==="error"?"error":""}`.trim(),n.textContent=t,fo.appendChild(n),setTimeout(()=>{n.remove()},r)}function Je(t){const e=[];for(const r of t){const n=String(r||"").trim();if(!n)continue;const o=n.split(/\s+/)[0].replace(/[;,]+$/,"");o.startsWith("wss://")&&e.push(o)}return e}function et(t){const e=String(t||"").trim();return e?e.startsWith("#")?e:`#${e}`:""}function Kn(t){const e=[],r=new Set;for(const n of t||[]){const s=et(n);s&&!r.has(s)&&(r.add(s),e.push(s))}return e}function fr(){return{nick:"Anonymous",relays:[...Jr],rooms:["#echo"],max_image_kb:40,max_payload_kb:80,supabase_upload:!1,supabase_url:"",supabase_anon_key:"",supabase_bucket:"echochan-images",stun_urls:["stun:stun.l.google.com:19302"],turn_urls:[],turn_username:"",turn_password:"",max_p2p_mb:5,p2p_timeout_sec:15,p2p_recent_minutes:10,p2p_max_sessions:2,nostr_pubkey:"",nostr_privkey:"",client_id:"",use_tor:!1,proxy_url:""}}function ho(){const t=Pn.utils.randomPrivateKey(),e=jr.getPublicKey(t);return{priv:lt(t),pub:lt(e)}}function Wr(t){if(!t.nostr_privkey||!t.nostr_pubkey){const e=ho();t.nostr_privkey=e.priv,t.nostr_pubkey=e.pub}t.client_id=t.nostr_pubkey}function po(){const t=localStorage.getItem("echochan_settings");let e=fr();if(t)try{e={...e,...JSON.parse(t)}}catch{e=fr()}return e.relays=Je(e.relays||[]),e.rooms=Kn(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),Wr(e),e}function Dn(t){localStorage.setItem("echochan_settings",JSON.stringify(t))}function Xr(t){return`echochan-${(t||"").slice(0,8)||"web"}`}function nt(t){if(t&&typeof t.createdAtSec=="number")return t.createdAtSec;const e=Number((t==null?void 0:t.ts)||(t==null?void 0:t.receivedAtMs)||0);return e?Math.floor(e/1e3):0}function zn(t){const e=JSON.stringify(t.attachments||[]),r=JSON.stringify(t.reply||null),n=nt(t),s=`${t.room}${t.nick}${n}${t.text}${e}${r}`,o=br(Ve(s));return lt(o)}function be(t,e){const r=nt(t),n=nt(e);if(r!==n)return r-n;const s=String((t==null?void 0:t.id)||""),o=String((e==null?void 0:e.id)||"");return s.localeCompare(o)}function $t(t){if(!t)return"unknown";const e=new Date(t*1e3),r=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${r}-${n}-${s}`}function yo(t){if(!t)return"";const e=new Date,r=$t(Math.floor((e.getTime()-864e5)/1e3)),n=$t(Math.floor(e.getTime()/1e3)),s=$t(t);return s===n?"Сегодня":s===r?"Вчера":s}function Nn(t){const e=document.createElement("div");return e.className="day-separator",e.dataset.dayKey=$t(t),e.textContent=yo(t),e}function go(t){const e=String(t||"Anonymous");let r=0;for(let n=0;n<e.length;n+=1)r=(r*31+e.charCodeAt(n))%360;return`hsl(${r}, 55%, 70%)`}function wo(t){if(!t)return null;const r=In(String(t.text||"")).trim();return r?r.length>120?`${r.slice(0,120)}…`:r:t.attachments&&t.attachments.length?"[media]":"(no text)"}function bo(t){!t||!t.id||(c.replyTo={id:t.id,nick:t.nick||"Anonymous",text:wo(t),ts:t.ts||ut()},Zn())}function Rn(){c.replyTo=null,Zn()}function Zn(){if(yn){if(!c.replyTo){yn.classList.add("hidden"),Ae&&(Ae.textContent=""),Ce&&(Ce.textContent="");return}yn.classList.remove("hidden"),Ae&&(Ae.textContent=c.replyTo.nick),Ce&&(Ce.textContent=c.replyTo.text||"")}}function Eo(t){if(!t)return;const e=V.querySelector(`[data-msg-id="${t}"]`);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("flash"),setTimeout(()=>e.classList.remove("flash"),800))}let ct=null;function vo(t,e){if(!t)return;ct||(ct=document.createElement("div"),ct.className="reply-tooltip",document.body.appendChild(ct));const r=jt.get(e);if(!r)ct.textContent="Original message not available";else{const s=`${r.nick||"Anonymous"} · ${is(r.createdAtSec||nt(r))}`,o=r.text||"";ct.textContent=`${s}
${o}`}const n=t.getBoundingClientRect();ct.style.left=`${Math.min(n.left,window.innerWidth-260)}px`,ct.style.top=`${Math.max(12,n.top-8)}px`,ct.classList.add("visible")}function xo(){ct&&ct.classList.remove("visible")}function We(){return V.scrollHeight-V.scrollTop-V.clientHeight<=80}function Ot(){Ut&&(c.isAtBottom?Ut.classList.add("hidden"):Ut.classList.remove("hidden"))}function Qr(t){var r;let e=t.previousSibling;for(;e;){if((r=e.classList)!=null&&r.contains("message"))return e;e=e.previousSibling}return null}function ts(t){var r;let e=t.nextSibling;for(;e;){if((r=e.classList)!=null&&r.contains("message"))return e;e=e.nextSibling}return null}function So(t,e){var d,p,g,u;const r=t.dataset.dayKey||$t(nt(e)),n=Qr(t),s=ts(t),o=n?n.dataset.dayKey:null,i=(p=(d=t.previousSibling)==null?void 0:d.classList)!=null&&p.contains("day-separator")?t.previousSibling:null;if(o!==r){if(!i||i.nextSibling!==t){const f=Nn(nt(e));V.insertBefore(f,t)}}else i&&i.remove();const a=s?s.dataset.dayKey:null,l=(u=(g=t.nextSibling)==null?void 0:g.classList)!=null&&u.contains("day-separator")?t.nextSibling:null;if(s&&a!==r){if(!l||l.previousSibling!==t){const f=Nn(nt(s));V.insertBefore(f,s)}}else l&&a===r&&l.remove()}function Te(t,e){const r=t.querySelector(".meta");r&&r.classList.toggle("compact",!e)}function mr(t){if(!t)return;if(t.dataset.groupable!=="1"){Te(t,!0);return}const e=Qr(t);if(!e||e.dataset.groupable!=="1"){Te(t,!0);return}const r=e.dataset.author===t.dataset.author,n=e.dataset.dayKey===t.dataset.dayKey;Te(t,!(r&&n))}function _o(){c.initialBuffering=!0,c.bufferedMessages=[],c.bufferTimer&&clearTimeout(c.bufferTimer),c.bufferTimer=setTimeout(()=>Bo(),800)}function ko(t){return!t||(t.id||(t.id=zn(t)),t.createdAtSec||(t.createdAtSec=nt(t)),t.receivedAtMs||(t.receivedAtMs=ut()),ge.has(t.id))?null:(ge.add(t.id),t)}function Bo(){c.initialBuffering=!1;const t=c.bufferedMessages||[];if(c.bufferedMessages=[],!t.length){Ot();return}t.sort(be);const e=We(),r=c.currentRoom;t.forEach(n=>{const s=Vt.get(n.room)||[];if(s.push(n),s.sort(be),s.length>500){const o=s.shift();o!=null&&o.id&&jt.delete(o.id)}Vt.set(n.room,s),n!=null&&n.id&&jt.set(n.id,n),c.roomCounts[n.room]=s.length,n.room===r&&Xt(n,{sorted:!0})}),ht(),e&&Bt(!0)}function _t(){if(!wn)return;const t=Y.getCurrent();if(!t){wn.classList.add("empty"),Le&&(Le.textContent="No audio"),Ne&&(Ne.textContent="");return}wn.classList.remove("empty"),Le&&(Le.textContent=t.title||"Now playing"),Ne&&(Ne.textContent=t.type?t.type.toUpperCase():""),ye&&(ye.textContent=Y.isPlaying()?"⏸":"▶")}let Re=null;function Ao(){return window.YT&&window.YT.Player?Promise.resolve(window.YT):Re||(Re=new Promise(t=>{if(window.YT&&window.YT.Player){t(window.YT);return}if(window.onYouTubeIframeAPIReady=()=>t(window.YT),!document.getElementById("yt-iframe-api")){const e=document.createElement("script");e.id="yt-iframe-api",e.src="https://www.youtube.com/iframe_api",document.head.appendChild(e)}}),Re)}function Co(t,e){if(!t||!t.id)return;const r=t.id;Ao().then(n=>{const s=new n.Player(r,{events:{onStateChange:o=>{o.data===n.PlayerState.PLAYING?Y.requestFocus(r):(o.data===n.PlayerState.PAUSED||o.data===n.PlayerState.ENDED)&&Y.markPaused(r)}}});Y.registerSource({id:r,type:"youtube",title:e,play:()=>s.playVideo(),pause:()=>s.pauseVideo(),stop:()=>s.stopVideo()})})}function Lo(t,e){if(!t)return;const r=t.id||`audio-${Kt()}`;t.id=r,Y.registerSource({id:r,type:"html5",title:t.getAttribute("data-title")||"Audio",play:()=>t.play(),pause:()=>t.pause(),stop:()=>{t.pause(),t.currentTime=0}}),t.addEventListener("play",()=>Y.requestFocus(r)),t.addEventListener("pause",()=>Y.markPaused(r)),t.addEventListener("ended",()=>Y.markPaused(r))}function hr(t,{type:e,title:r}={}){if(!t)return;const n=t.id||`${e||"embed"}-${Kt()}`;if(t.id=n,t.dataset.src||(t.dataset.src=t.src),!t.dataset.autoplay){const i=t.dataset.src;let a=i;e==="spotify"?a=i.includes("?")?`${i}&autoplay=1`:`${i}?autoplay=1`:e==="yandex"&&(a=i.includes("?")?`${i}&autoplay=1`:`${i}?autoplay=1`),t.dataset.autoplay=a}const s=t.parentElement,o=s?s.querySelector(".embed-overlay"):null;o&&o.remove(),Y.registerSource({id:n,type:e||"other",title:r||"Embed",play:()=>{t.src=t.dataset.autoplay||t.dataset.src},pause:()=>{t.src=t.dataset.src},stop:()=>{t.src=t.dataset.src}})}function No(t,e,r,n,s){const o=JSON.stringify([0,t,e,r,n,s]),i=br(Ve(o));return lt(i)}async function es(t,e,r,n,s){const o=t.nostr_pubkey,i=No(o,s,e,r,n),a=await jr.sign(Dt(i),Dt(t.nostr_privkey)),l=lt(a);return{id:i,pubkey:o,created_at:s,kind:e,tags:r,content:n,sig:l}}function Vn(t){return t.trim().replace(/^#/,"")}function ns(){const e=(c.settings.rooms||[]).map(n=>Vn(n));return e.length?JSON.stringify(["REQ",Fe,{kinds:[1,42],"#t":e}]):null}function Ro(){return JSON.stringify(["CLOSE",Fe])}function gt(){const t=Array.from(bt.values()).map(s=>({url:s.url,state:s.status,last_error:s.lastError||null})),e=t.filter(s=>s.state==="connected").length,r=t.filter(s=>s.state==="error").length,n={total:t.length,connected:e,errors:r,items:t};return An("relay-status",n),n}function Io(){var r;const t=Je(c.settings.relays||[]),e=new Set(t);for(const[n,s]of bt.entries())e.has(n)||((r=s.ws)==null||r.close(),bt.delete(n));for(const n of t)bt.has(n)||bt.set(n,{url:n,status:"connecting",lastError:null,backoff:1e3,ws:null,timer:null}),rs(n);return gt()}function rs(t){const e=bt.get(t);if(e&&!(e.ws&&(e.ws.readyState===WebSocket.OPEN||e.ws.readyState===WebSocket.CONNECTING))){e.status="connecting",e.lastError=null,gt();try{const r=new WebSocket(t);e.ws=r,r.onopen=()=>{e.status="connected",e.lastError=null,e.backoff=1e3;const n=ns();n&&r.send(n),gt()},r.onmessage=n=>{typeof n.data=="string"&&To(n.data,t)},r.onerror=()=>{e.status="error",e.lastError=e.lastError||"WebSocket error",gt()},r.onclose=()=>{e.status="reconnecting",gt();const n=Math.min(e.backoff,3e4);e.backoff=Math.min(e.backoff*2,3e4),clearTimeout(e.timer),e.timer=setTimeout(()=>rs(t),n)}}catch(r){e.status="error",e.lastError=String(r),gt()}}}function Ke(t){bt.forEach(e=>{e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(t)})}function jn(){const t=Ro();Ke(t);const e=ns();e&&Ke(e)}function To(t,e){let r;try{r=JSON.parse(t)}catch{return}if(!Array.isArray(r)||!r.length)return;const n=r[0];if(n==="NOTICE"){const d=r[1]||"",p=bt.get(e);p&&(p.lastError=d||"NOTICE",p.status=p.status==="connected"?"connected":"error",gt());return}if(n==="OK"){if(!(r[2]!==!1)){const p=r[3]||"event rejected",g=bt.get(e);g&&(g.lastError=p,gt())}return}if(n!=="EVENT"||r.length<3)return;const s=r[2];if(!s||s.kind!==1&&s.kind!==42)return;let o;try{o=JSON.parse(s.content)}catch{return}if(!o||typeof o!="object")return;if(o.type==="signal"){const d={type:"signal",room:et(o.room||"")||pr(s.tags),from:o.from||s.pubkey,to:o.to||null,sid:o.sid,kind:o.kind,sdp:o.sdp||null,candidate:o.candidate||null,ts:o.ts||s.created_at*1e3};An("signal-message",d);return}if(o.type!=="message")return;const i=et(o.room||"")||pr(s.tags);if(!i)return;const a={type:"message",room:i,nick:o.nick||`npub:${(s.pubkey||"").slice(0,8)}`,client_id:o.client_id||s.pubkey,createdAtSec:Number(s.created_at||0)||Math.floor(Date.now()/1e3),ts:Number(s.created_at||0)*1e3||Date.now(),text:o.text||"",attachments:Array.isArray(o.attachments)?o.attachments:[],id:s.id,action:!!o.action,reply:o.reply&&typeof o.reply=="object"?o.reply:null};a.receivedAtMs=ut();const l=ko(a);if(l){if(c.initialBuffering){c.bufferedMessages.push(l);return}ss(l)&&An("new-message",l)}}function pr(t=[]){for(const e of t)if(e&&e[0]==="t"&&e[1])return et(e[1]);return""}function ss(t){if(!t||(t.id||(t.id=zn(t)),t.createdAtSec||(t.createdAtSec=nt(t)),t.receivedAtMs||(t.receivedAtMs=ut()),ge.has(t.id)))return!1;ge.add(t.id),jt.set(t.id,t);const e=Vt.get(t.room)||[];if(e.push(t),e.sort(be),e.length>500){const r=e.shift();r!=null&&r.id&&jt.delete(r.id)}return Vt.set(t.room,e),!0}async function Mo(){const t={};return Vt.forEach((e,r)=>{t[r]=e.length}),{settings:c.settings,counts:t,relay_summary:gt()}}async function $o(t){const e={...c.settings,...t};e.relays=Je(e.relays||[]),e.rooms=Kn(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),Wr(e),c.settings=e,Fe=Xr(e.nostr_pubkey),Dn(e),jn()}async function Oo(t){const e=et(t);e&&(c.settings.rooms.includes(e)||(c.settings.rooms.push(e),Dn(c.settings),jn()))}async function Po(t){const e=et(t);if(e){if(c.settings.rooms.length<=1)throw new Error("At least one room must remain.");c.settings.rooms=c.settings.rooms.filter(r=>r!==e),Dn(c.settings),jn()}}async function qo(t){const e=et(t);return Vt.get(e)||[]}async function Ho(){return Io()}async function Uo(t){var l;if(((l=t.attachments)==null?void 0:l.length)>2)throw new Error("Only 2 inline images allowed.");const e=et(t.room),r=Math.floor(Date.now()/1e3),n={room:e,type:"message",nick:t.nick||"Anonymous",client_id:c.settings.nostr_pubkey,createdAtSec:r,ts:r*1e3,text:t.text||"",attachments:t.attachments||[],id:"",action:!!t.action,reply:t.reply||null};n.id=zn(n);const s=JSON.stringify(n),o=[["t",Vn(e)]],i=await es(c.settings,1,o,s,r);n.id=i.id,n.receivedAtMs=ut();const a=JSON.stringify(["EVENT",i]);if(a.length>(c.settings.max_payload_kb||450)*1024)throw new Error("Payload exceeds max_payload_kb limit.");return ss(n)&&Ke(a),n}async function Ko(t){const e={type:"signal",room:et(t.room),from:t.from||c.settings.nostr_pubkey,to:t.to||null,sid:t.sid,kind:t.kind,sdp:t.sdp||null,candidate:t.candidate||null,ts:Date.now()},r=JSON.stringify(e),n=[["t",Vn(e.room)]],s=await es(c.settings,1,n,r,Math.floor(e.ts/1e3)),o=JSON.stringify(["EVENT",s]);Ke(o)}function ut(){return Date.now()}function H(t){no.textContent=t}function os({title:t,body:e,okText:r}){return new Promise(n=>{Ie=n,ao.textContent=t||"Confirm",lo.textContent=e||"Are you sure?",Fr.textContent=r||"OK",we.classList.remove("hidden")})}function Xe(t){Ie&&(Ie(t),Ie=null),we.classList.add("hidden")}function De(){mt.style.height="auto";const t=Math.max(mt.scrollHeight,mo);mt.style.height=`${t}px`}function is(t){const e=Number(t||0)*1e3;if(!e)return"";const r=new Date(e),n=new Date,s=r.getFullYear()===n.getFullYear()&&r.getMonth()===n.getMonth()&&r.getDate()===n.getDate(),o=String(r.getHours()).padStart(2,"0"),i=String(r.getMinutes()).padStart(2,"0");if(s)return`${o}:${i}`;const a=r.getFullYear(),l=String(r.getMonth()+1).padStart(2,"0"),d=String(r.getDate()).padStart(2,"0");return`${a}-${l}-${d} ${o}:${i}`}function Do(t){if(!t)return"";const e=[/(?:https?:\/\/)?(?:www\.)?youtu\.be\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/i];for(const r of e){const n=t.match(r);if(n&&n[1])return n[1]}return""}function zo(t){if(!t)return null;const e=/(?:https?:\/\/)?open\.spotify\.com\/(track|album|playlist|episode|show)\/([A-Za-z0-9]+)(?:\?[^ \n]*)?/i,r=t.match(e);return r?{type:r[1],id:r[2]}:null}function Zo(t){if(!t)return"";const e=t.match(/https?:\/\/music\.yandex\.ru\/iframe\/#([A-Za-z0-9/_-]+)/i);if(e&&e[1])return`https://music.yandex.ru/iframe/#${e[1]}`;const r=t.match(/https?:\/\/music\.yandex\.ru\/album\/(\d+)\/track\/(\d+)/i);if(r){const s=r[1];return`https://music.yandex.ru/iframe/#track/${r[2]}/${s}`}const n=t.match(/https?:\/\/music\.yandex\.ru\/track\/(\d+)/i);return n?`https://music.yandex.ru/iframe/#track/${n[1]}`:""}function In(t){if(!t)return"";let e=t;const r=[/https?:\/\/(?:www\.)?youtu\.be\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/watch\?v=[A-Za-z0-9_-]+(?:\&[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/shorts\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/embed\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/open\.spotify\.com\/(track|album|playlist|episode|show)\/[A-Za-z0-9]+(?:\?[^ \n]*)?/gi,/https?:\/\/music\.yandex\.ru\/iframe\/#[A-Za-z0-9/_-]+/gi,/https?:\/\/music\.yandex\.ru\/album\/\d+\/track\/\d+/gi,/https?:\/\/music\.yandex\.ru\/track\/\d+/gi];for(const n of r)e=e.replace(n,"");return e.replace(/\n{3,}/g,`

`).trim()}function Kt(){const t=new Uint8Array(12);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}function ht(){lr.innerHTML="",c.rooms.forEach(t=>{const e=document.createElement("div");e.className="room"+(t===c.currentRoom?" active":"");const r=document.createElement("span");r.textContent=t;const n=document.createElement("span");n.className="count",n.textContent=c.roomCounts[t]||0;const s=document.createElement("button");s.className="room-remove",s.textContent="×",s.title="Remove room",s.addEventListener("click",async o=>{if(o.stopPropagation(),c.rooms.length<=1){H("At least one room must remain.");return}await os({title:"Remove room",body:`Remove room ${t}?`,okText:"Remove"})&&(await J("remove_room",{room:t}),c.rooms=c.rooms.filter(a=>a!==t),c.currentRoom===t&&(c.currentRoom=c.rooms[0],Yt.textContent=c.currentRoom,await Ft(c.currentRoom)),ht(),vt(`Left ${t}.`))}),e.append(r,n,s),e.addEventListener("click",async()=>{document.body.classList.remove("sidebar-open"),c.currentRoom=t,Yt.textContent=t,ht(),await Ft(t)}),lr.appendChild(e)})}function cs(){if(!Et)return;Et.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="All",Et.appendChild(t);const e=Array.from(c.peers.values()).sort((r,n)=>r.nick.localeCompare(n.nick));for(const r of e){const n=document.createElement("option");n.value=r.id,n.textContent=`${r.nick} · ${r.id.slice(0,8)}`,Et.appendChild(n)}}function Vo(t,{autoScroll:e=!0}={}){if(Y.clearAll(),V.innerHTML="",!t.length){const i=document.createElement("div");i.className="empty-state",i.textContent="No messages yet. Try /join #room or type a message.",V.appendChild(i)}const r=[...t].sort((i,a)=>be(i,a));let n=null,s=null,o=!1;if(r.forEach(i=>{i.createdAtSec=i.createdAtSec||nt(i),i.receivedAtMs=i.receivedAtMs||ut();const a=$t(i.createdAtSec);a!==s&&(V.appendChild(Nn(i.createdAtSec)),s=a,n=null,o=!1);const l=!i.system,d=!(l&&o&&n===i.nick);Xt(i,{showMeta:d}),i!=null&&i.id&&(ge.add(i.id),jt.set(i.id,i)),l?(n=i.nick,o=!0):(n=null,o=!1)}),e?Bt(!0):(c.isAtBottom=We(),Ot()),r.length){const i=r[r.length-1];i&&i.id&&c.lastMessageId.set(c.currentRoom,i.id)}}function Bt(t=!1){if(!t&&!c.isAtBottom){Ot();return}requestAnimationFrame(()=>{V.scrollTop=V.scrollHeight,c.isAtBottom=!0,Ot()})}function vt(t){const e={nick:"system",createdAtSec:Math.floor(ut()/1e3),ts:ut(),text:t,action:!1,attachments:[],system:!0};Xt(e),Bt()}function Xt(t,{sorted:e=!1,showMeta:r=!0}={}){const n=document.createElement("div");n.className=t.system?"message system":"message",t&&t.id&&(n.dataset.msgId=t.id);const s=(t==null?void 0:t.createdAtSec)||nt(t)||0;n.dataset.createdAtSec=String(s),n.dataset.dayKey=$t(s),n.dataset.author=t.nick||"Anonymous",n.dataset.groupable=t.system?"0":"1";const o=V.querySelector(".empty-state");o&&o.remove();const i=document.createElement("div"),a=Do(t.text),l=zo(t.text),d=Zo(t.text),p=t.attachments&&t.attachments.length||a||l||d,g=t.action?`* ${t.nick} ${t.text}`:In(t.text),f=p&&!!!g;i.className="message-body",p&&i.classList.add("has-media"),f&&i.classList.add("media-only");const x=document.createElement("div");x.className="meta";const S=document.createElement("div");S.className="meta-left";const I=document.createElement("span");I.className="nick",I.textContent=t.nick||"Anonymous",I.style.color=go(I.textContent);const b=document.createElement("span");if(b.className="time",b.textContent=is(t.createdAtSec||nt(t)),S.append(I,b),x.appendChild(S),!t.system){const w=document.createElement("button");w.className="reply-btn",w.textContent="Reply",w.addEventListener("click",L=>{L.stopPropagation(),bo(t)}),x.appendChild(w)}const R=document.createElement("div");R.className="text";const $=g;R.textContent=$;const U=document.createElement("div");if(U.className="message-content",t.reply&&t.reply.id){const w=document.createElement("div");w.className="reply-snippet-inline";const L=t.reply.nick||"Anonymous",F=t.reply.text||"";w.textContent=`${L}: ${F}`,w.addEventListener("mouseenter",()=>vo(w,t.reply.id)),w.addEventListener("mouseleave",xo),w.addEventListener("click",()=>Eo(t.reply.id)),U.appendChild(w)}$&&U.appendChild(R),i.appendChild(U),n.appendChild(x);const K=document.createElement("div");K.className="attachments";const W=a?(()=>{const w=document.createElement("div");w.className="youtube-embed";const L=document.createElement("iframe"),F=encodeURIComponent(window.location.origin);return L.src=`https://www.youtube-nocookie.com/embed/${a}?enablejsapi=1&origin=${F}&playsinline=1`,L.title="YouTube video",L.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",L.referrerPolicy="origin-when-cross-origin",L.allowFullscreen=!0,L.id=`yt-${t.id||Kt()}`,w.appendChild(L),w})():null,ot=l?(()=>{const w=document.createElement("div");w.className="spotify-embed";const L=document.createElement("iframe");return L.src=`https://open.spotify.com/embed/${l.type}/${l.id}`,L.title="Spotify",L.allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture",L.loading="lazy",L.referrerPolicy="origin-when-cross-origin",L.id=`sp-${t.id||Kt()}`,w.appendChild(L),w})():null,it=d?(()=>{const w=document.createElement("div");w.className="yandex-embed";const L=document.createElement("iframe");return L.src=d,L.title="Yandex Music",L.allow="autoplay; clipboard-write; encrypted-media",L.loading="lazy",L.referrerPolicy="origin-when-cross-origin",L.id=`ym-${t.id||Kt()}`,w.appendChild(L),w})():null;if(t.attachments&&t.attachments.length&&t.attachments.forEach(w=>{const L=document.createElement("img");L.src=w.data,L.alt="attachment",L.addEventListener("click",()=>jo(w.data)),K.appendChild(L)}),W&&K.appendChild(W),ot&&K.appendChild(ot),it&&K.appendChild(it),p&&i.insertBefore(K,U),n.appendChild(i),r||Te(n,!1),e){const w=Array.from(V.querySelectorAll(".message"));let L=!1;for(const F of w){const M={createdAtSec:Number(F.dataset.createdAtSec||0),id:F.dataset.msgId||""};if(be(t,M)<0){V.insertBefore(n,F),L=!0;break}}L||V.appendChild(n),So(n,t),mr(n),mr(ts(n))}else V.appendChild(n);if(W){const w=W.querySelector("iframe");w&&Co(w,In(t.text)||"YouTube")}if(ot){const w=ot.querySelector("iframe");w&&hr(w,{type:"spotify",title:"Spotify"})}if(it){const w=it.querySelector("iframe");w&&hr(w,{type:"yandex",title:"Yandex Music"})}return n.querySelectorAll("audio").forEach(w=>Lo(w)),t&&t.id&&c.lastMessageId.set(t.room||c.currentRoom,t.id),n}function jo(t){t&&(Gr.src=t,Ge.classList.remove("hidden"))}function as(){Ge.classList.add("hidden"),Gr.src=""}function ls(){ur.innerHTML="",c.attachments.forEach(t=>{const e=document.createElement("img");e.src=t.data,ur.appendChild(e)})}function Yo(t){const e=JSON.stringify(t);return new TextEncoder().encode(e).length/1024}async function Fo(){var r,n;c.settings=po(),Fe=Xr(c.settings.nostr_pubkey);const t=await J("get_state",{});c.settings=t.settings;const e=Kn(t.settings.rooms);c.rooms=e,c.roomCounts=t.counts||{},c.currentRoom=c.rooms[0]||"#test",c.maxImageKB=t.settings.max_image_kb,c.maxPayloadKB=t.settings.max_payload_kb,tt&&(tt.value=t.settings.nick),at&&(at.value=t.settings.relays.join(`
`)),At&&(At.value=t.settings.max_image_kb),Ct&&(Ct.value=t.settings.max_payload_kb),ie&&(ie.checked=!!t.settings.supabase_upload),ce&&(ce.value=t.settings.supabase_url||""),ae&&(ae.value=t.settings.supabase_anon_key||""),le&&(le.value=t.settings.supabase_bucket||"echochan-images"),ne&&(ne.value=((r=t.settings.stun_urls)==null?void 0:r.join(`
`))||""),ue&&(ue.checked=t.settings.use_tor||!1),de&&(de.value=t.settings.proxy_url||""),re&&(re.value=((n=t.settings.turn_urls)==null?void 0:n.join(`
`))||""),se&&(se.value=t.settings.turn_username||""),oe&&(oe.value=t.settings.turn_password||""),fe&&(fe.value=t.settings.max_p2p_mb||5),me&&(me.value=t.settings.p2p_timeout_sec||15),he&&(he.value=t.settings.p2p_recent_minutes||10),pe&&(pe.value=t.settings.p2p_max_sessions||2),Yt.textContent=c.currentRoom,ht(),Et&&cs(),await Ft(c.currentRoom),Qe(t.relay_summary),JSON.stringify(e)!==JSON.stringify(t.settings.rooms)&&(c.settings.rooms=e,await J("save_settings",{settings:c.settings})),vt(`Relays configured: ${c.settings.relays.length}`),Zn(),c.isAtBottom=!0,Ot(),Go()}function Go(){c.relayPollId||(c.relayPollId=setInterval(async()=>{try{const t=await J("get_state",{});t&&t.relay_summary&&Qe(t.relay_summary)}catch{}},4e3))}function Qe(t){if(!t)return;const e=t.total??(t.items?t.items.length:0),r=t.connected??0,n=t.errors??0;c.relayItems=t.items||[],e>0&&r===0&&n===0?H(`Connecting to ${e} relays...`):r>0?H(`Connected to ${r}/${e} relays, ${n} errors`):H(`Connected to 0 relays, ${n} errors`),Xo(t.items||[]),Qo(t.items||[]),Jo(t),c.pendingRelayDetail&&Wo(t)}function Jo(t){const e=[];t.total===0?e.push("No relays configured. Open Settings and add wss:// relays."):t.connected===0&&e.push("No relay connections yet. Check relay errors in Settings.");const r=(t.items||[]).filter(s=>s.last_error);if(r.length)for(const s of r)s.last_error?e.push(`${s.url} error: ${s.last_error}`):e.push(`${s.url} error`);if(!e.length)return;const n=e.join(" ");n!==c.lastRelayNotice&&(c.lastRelayNotice=n,Lt(n,"error"))}function Wo(t){const e=t.items||[];if(!e.length)return;const n=`Relay status: ${e.map(s=>s.last_error?`${s.state}: ${s.url} (${s.last_error})`:`${s.state}: ${s.url}`).join(" | ")}`;n!==c.lastRelayDetail&&(c.lastRelayDetail=n,Lt(n,"info",5e3),c.pendingRelayDetail=!1)}function Xo(t){const e=ke&&!kt.classList.contains("hidden"),r=e?ke.scrollTop:0;if(Be){if(Be.innerHTML="",!t.length){const n=document.createElement("div");n.textContent="No relay status yet. Click Test relays.",Be.appendChild(n),e&&(ke.scrollTop=r);return}t.forEach(n=>{const s=document.createElement("div");s.className="relay-status-item";const o=document.createElement("div");o.textContent=n.url;const i=document.createElement("div");i.className=`state ${n.state}`,i.textContent=n.state;const a=document.createElement("button");if(a.textContent="Remove",a.addEventListener("click",async()=>{const l=c.settings.relays.filter(d=>d!==n.url);if(!l.length){H("At least one relay must remain.");return}at.value=l.join(`
`),await tn({close:!1})}),s.append(o,i,a),n.last_error){const l=document.createElement("div");l.className="error",l.textContent=n.last_error,s.appendChild(l)}Be.appendChild(s)}),e&&(ke.scrollTop=r)}}function Qo(t){const e=t.filter(n=>n.last_error);if(Qt.innerHTML="",!e.length){Qt.classList.add("hidden");return}Qt.classList.remove("hidden");const r=document.createElement("div");r.className="title",r.textContent="Relay errors",Qt.appendChild(r),e.forEach(n=>{const s=document.createElement("div");s.className="item",s.textContent=n.last_error?`${n.url} — ${n.last_error}`:`${n.url} — error`,Qt.appendChild(s)})}async function Ft(t){const e=await J("get_room_messages",{room:t});c.roomCounts[t]=e.length,Vo(e),hs(e),ht()}async function Yn(){var t;if(H("Connecting..."),Lt("Connecting to relays...","info",3e3),_o(),(t=c.settings)!=null&&t.use_tor){const e=c.settings.proxy_url||"socks5://127.0.0.1:9150";Lt(`Using SOCKS5 proxy: ${e}`,"info",4e3)}c.pendingRelayDetail=!0;try{const e=await J("connect_relays",{});Qe(e);const r=e.total??(e.items?e.items.length:0),n=e.connected??0,s=e.errors??0;r>0&&n===0&&s===0?Lt("Connecting to chat...","info",3e3):Lt("Connected to chat.","info",3e3)}catch(e){H(String(e)),Lt(String(e),"error",5e3)}}async function ti(t){const e=t.trim();if(e){if(e.startsWith("/join ")){const r=et(e.replace("/join","").trim());if(!r)return;c.rooms.includes(r)||(c.rooms.push(r),ht(),await J("add_room",{room:r})),c.currentRoom=r,Yt.textContent=r,vt(`Joined ${r}.`),await Ft(r);return}if(e.startsWith("/leave ")){const r=et(e.replace("/leave","").trim());if(!r)return;if(c.rooms.length<=1){H("At least one room must remain.");return}if(!c.rooms.includes(r)){H("Room not found.");return}await J("remove_room",{room:r}),c.rooms=c.rooms.filter(n=>n!==r),c.currentRoom===r&&(c.currentRoom=c.rooms[0],Yt.textContent=c.currentRoom,await Ft(c.currentRoom)),ht(),vt(`Left ${r}.`);return}if(e.startsWith("/nick ")){const r=e.replace("/nick","").trim();if(!r)return;c.settings.nick=r,tt.value=r,await J("save_settings",{settings:c.settings}),vt(`Nick changed to ${r}.`);return}}}async function us(t){const e=t.trim();if(!e)return;if(e.startsWith("/join ")||e.startsWith("/nick ")||e.startsWith("/leave ")){await ti(e),mt.value="",Rn(),De();return}let r=!1,n=e;e.startsWith("/me ")&&(r=!0,n=e.replace("/me","").trim());const s=c.replyTo?{id:c.replyTo.id,nick:c.replyTo.nick,text:c.replyTo.text,ts:c.replyTo.ts}:null,o={type:"message",room:et(c.currentRoom),nick:c.settings.nick,createdAtSec:Math.floor(Date.now()/1e3),ts:Date.now(),text:n,attachments:c.attachments,id:"0".repeat(64),action:r,reply:s};if(Yo(o)>c.maxPayloadKB){H(`Payload exceeds ${c.maxPayloadKB}KB limit.`);return}try{const i=await J("send_message",{message:{room:et(c.currentRoom),nick:c.settings.nick,text:n,attachments:c.attachments,action:r,reply:s}});c.attachments=[],Rn(),ls(),mt.value="",De(),c.roomCounts[c.currentRoom]=(c.roomCounts[c.currentRoom]||0)+1,Xt(i),ht(),Bt(!0)}catch(i){H(String(i))}}async function ei(t,e,r){const n=await createImageBitmap(t),s=Math.max(n.width,n.height),o=Math.min(1,e/s),i=[1,.9,.8,.7,.6],a=[.75,.6,.45,.3],l=document.createElement("canvas"),d=l.getContext("2d");for(const p of i){const g=o*p,u=Math.max(1,Math.round(n.width*g)),f=Math.max(1,Math.round(n.height*g));l.width=u,l.height=f,d.clearRect(0,0,u,f),d.drawImage(n,0,0,u,f);for(const x of a){const S=l.toDataURL("image/webp",x),I=S.split(",")[1]||"",b=Math.floor(I.length*.75);if(b<=r*1024)return{kind:"inline",mime:"image/webp",data:S,w:u,h:f,size:b}}}throw new Error("Image too large after compression.")}async function ni(t,e){const r=c.settings.supabase_url,n=c.settings.supabase_anon_key,s=c.settings.supabase_bucket;if(!r||!n||!s)throw new Error("Supabase upload is enabled but credentials are missing.");const o=(t.split(",")[1]||"").trim();if(!o)throw new Error("Invalid image data.");const i=Uint8Array.from(atob(o),g=>g.charCodeAt(0)),a=String(e).replace(/[^\w.-]+/g,"_"),l=`uploads/${Date.now()}_${Math.random().toString(16).slice(2)}_${a}.webp`,d=`${r}/storage/v1/object/${s}/${l}`,p=await fetch(d,{method:"POST",headers:{Authorization:`Bearer ${n}`,apikey:n,"Content-Type":"image/webp","x-upsert":"true"},body:i});if(!p.ok){const g=await p.text();throw new Error(`Supabase upload failed: ${p.status} ${g}`)}return`${r}/storage/v1/object/public/${s}/${l}`}async function ds(t){for(const e of t){if(c.attachments.length>=2){H("Only 2 inline images allowed.");break}try{const r=await ei(e,1280,c.maxImageKB);if(c.settings.supabase_upload){H("Uploading image...");const n=await ni(r.data,e.name||"image");c.attachments.push({kind:"link",mime:r.mime,data:n,w:r.w,h:r.h,size:r.size}),H("Image uploaded.")}else c.attachments.push(r);ls()}catch(r){H(String(r))}}}function ri(){kt.classList.remove("hidden")}function Fn(){kt.classList.add("hidden"),Gn()}async function tn({close:t=!0}={}){const e=Je(((at==null?void 0:at.value)||"").split(`
`)),r=((ne==null?void 0:ne.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length),n=((re==null?void 0:re.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length);c.settings.nick=(tt==null?void 0:tt.value.trim())||c.settings.nick,c.settings.relays=e,at&&(at.value=e.join(`
`));const s=Number(At==null?void 0:At.value)||c.maxImageKB,o=Number(Ct==null?void 0:Ct.value)||c.maxPayloadKB;c.settings.max_image_kb=Math.max(20,Math.min(80,s)),c.settings.max_payload_kb=Math.max(60,Math.min(200,o)),c.settings.supabase_upload=!!(ie!=null&&ie.checked),c.settings.supabase_url=(ce==null?void 0:ce.value.trim())||"",c.settings.supabase_anon_key=(ae==null?void 0:ae.value.trim())||"",c.settings.supabase_bucket=(le==null?void 0:le.value.trim())||"echochan-images",At&&(At.value=String(c.settings.max_image_kb)),Ct&&(Ct.value=String(c.settings.max_payload_kb)),c.settings.stun_urls=r,c.settings.use_tor=(ue==null?void 0:ue.checked)||!1,c.settings.proxy_url=(de==null?void 0:de.value.trim())||"",c.settings.turn_urls=n,c.settings.turn_username=(se==null?void 0:se.value)||"",c.settings.turn_password=(oe==null?void 0:oe.value)||"",c.settings.max_p2p_mb=Number(fe==null?void 0:fe.value)||5,c.settings.p2p_timeout_sec=Number(me==null?void 0:me.value)||15,c.settings.p2p_recent_minutes=Number(he==null?void 0:he.value)||10,c.settings.p2p_max_sessions=Number(pe==null?void 0:pe.value)||2,c.maxImageKB=c.settings.max_image_kb,c.maxPayloadKB=c.settings.max_payload_kb,await J("save_settings",{settings:c.settings}),t&&Fn(),await Yn()}async function Gn(){if(!tt)return;const t=tt.value.trim()||"Anonymous";t!==c.settings.nick&&(c.settings.nick=t,await J("save_settings",{settings:c.settings}))}function fs(){const t=[];return c.settings.stun_urls&&c.settings.stun_urls.length&&t.push({urls:c.settings.stun_urls}),c.settings.turn_urls&&c.settings.turn_urls.length&&t.push({urls:c.settings.turn_urls,username:c.settings.turn_username||void 0,credential:c.settings.turn_password||void 0}),{iceServers:t}}function ms(){return c.sessions.size}function si(t){const e=c.peers.get(t);return e?ut()-e.lastSeen<=(c.settings.p2p_recent_minutes||10)*60*1e3:!1}function hs(t){if(Et){for(const e of t){if(!e.client_id)continue;const r=e.client_id,n=c.peers.get(r),s=e.nick||r.slice(0,8),o=(e.createdAtSec||nt(e))*1e3||ut();(!n||n.lastSeen<o)&&c.peers.set(r,{id:r,nick:s,lastSeen:o})}cs()}}function ps(t,e){const r=c.settings.p2p_timeout_sec||15,n={sid:t,mode:e,pc:null,dc:null,meta:null,receivedChunks:[],receivedBytes:0,expectedSize:0,timeout:null};return n.timeout=setTimeout(()=>{Gt(t,"P2P failed (timeout). Use inline instead.")},r*1e3),c.sessions.set(t,n),n}function Gt(t,e){const r=c.sessions.get(t);r&&(clearTimeout(r.timeout),r.dc&&r.dc.close(),r.pc&&r.pc.close(),c.sessions.delete(t),e&&H(e))}async function ze(t,e){const r={room:c.currentRoom,from:c.settings.nostr_pubkey||"",to:e.to||null,sid:e.sid,kind:t,sdp:e.sdp||null,candidate:e.candidate||null};await J("send_signal",{signal:r})}async function oi(t){if(ms()>=(c.settings.p2p_max_sessions||2)){H("P2P session limit reached.");return}if(t.size>(c.settings.max_p2p_mb||5)*1024*1024){H("P2P file too large.");return}const e=Kt(),r=ps(e,"send"),n=new RTCPeerConnection(fs());r.pc=n;const s=n.createDataChannel("file");r.dc=s,s.binaryType="arraybuffer",s.onopen=async()=>{const a=await t.arrayBuffer(),l={kind:"file_meta",sid:e,name:t.name,mime:t.type||"application/octet-stream",size:t.size};s.send(JSON.stringify(l));let d=0;const p=new Uint8Array(a);for(;d<p.length;){const g=p.slice(d,d+dr);s.send(g),d+=dr}},s.onmessage=a=>{if(typeof a.data=="string")try{const l=JSON.parse(a.data);l.kind==="file_ack"&&l.sid===e&&Gt(e,"P2P transfer completed.")}catch{return}};const o=(Et==null?void 0:Et.value)||null;n.onicecandidate=async a=>{a.candidate&&await ze("ice",{sid:e,to:o,candidate:{candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex}})};const i=await n.createOffer();await n.setLocalDescription(i),await ze("offer",{sid:e,to:o,sdp:i.sdp})}function ii(t){const e=document.createElement("div");e.className="p2p-card";const r=document.createElement("div");r.textContent=`Incoming P2P image from ${t.from.slice(0,8)}`;const n=document.createElement("div");n.className="actions";const s=document.createElement("button");s.textContent="Accept";const o=document.createElement("button");o.textContent="Decline",n.append(s,o),e.append(r,n);const i=document.createElement("div");i.className="message system";const a=document.createElement("div");a.className="message-body",a.appendChild(e),i.appendChild(a),V.appendChild(i),Bt(),s.addEventListener("click",async()=>{i.remove(),await ci(t)}),o.addEventListener("click",()=>{i.remove(),Gt(t.sid,"P2P declined.")})}async function ci(t){if(ms()>=(c.settings.p2p_max_sessions||2)){H("P2P session limit reached.");return}if(!si(t.from)&&!await os({title:"Unverified sender",body:"Sender has not spoken recently in this room. Accept anyway?",okText:"Accept"})){Gt(t.sid,"P2P declined.");return}const e=t.sid,r=ps(e,"recv"),n=new RTCPeerConnection(fs());r.pc=n,n.ondatachannel=o=>{const i=o.channel;r.dc=i,i.binaryType="arraybuffer",i.onmessage=a=>ai(r,t.from,a.data)},n.onicecandidate=async o=>{o.candidate&&await ze("ice",{sid:e,to:t.from,candidate:{candidate:o.candidate.candidate,sdpMid:o.candidate.sdpMid,sdpMLineIndex:o.candidate.sdpMLineIndex}})},await n.setRemoteDescription({type:"offer",sdp:t.sdp});const s=await n.createAnswer();await n.setLocalDescription(s),await ze("answer",{sid:e,to:t.from,sdp:s.sdp})}function ai(t,e,r){if(typeof r=="string"){try{const s=JSON.parse(r);s.kind==="file_meta"&&s.sid===t.sid&&(t.meta=s,t.expectedSize=s.size,s.size>(c.settings.max_p2p_mb||5)*1024*1024&&Gt(t.sid,"P2P file too large."))}catch{return}return}if(!t.meta)return;const n=new Uint8Array(r);if(t.receivedChunks.push(n),t.receivedBytes+=n.byteLength,t.receivedBytes>=t.expectedSize){const s=new Blob(t.receivedChunks,{type:t.meta.mime}),o=URL.createObjectURL(s),i={nick:e.slice(0,8),ts:ut(),text:"[P2P image]",action:!1,attachments:[{data:o}]};Xt(i),Bt(),t.dc&&t.dc.send(JSON.stringify({kind:"file_ack",sid:t.sid,ok:!0})),Gt(t.sid,null)}}async function li(t){if(t.room!==c.currentRoom)return;if(t.kind==="offer"){if(c.pendingOffers.has(t.sid))return;c.pendingOffers.set(t.sid,t),ii(t);return}const e=c.sessions.get(t.sid);if(e){if(t.kind==="answer"&&e.pc){await e.pc.setRemoteDescription({type:"answer",sdp:t.sdp});return}if(t.kind==="ice"&&e.pc&&t.candidate)try{await e.pc.addIceCandidate(t.candidate)}catch{return}}}Yr.addEventListener("click",async()=>{const t=et(Cn.value);t&&(c.rooms.includes(t)||(c.rooms.push(t),ht(),await J("add_room",{room:t})),c.currentRoom=t,Yt.textContent=t,vt(`Joined ${t}.`),await Ft(t),Cn.value="")});oo.addEventListener("click",ri);io.addEventListener("click",Fn);co.addEventListener("click",tn);tt==null||tt.addEventListener("blur",Gn);tt==null||tt.addEventListener("change",Gn);kt.addEventListener("click",t=>{t.target===kt&&Fn()});un==null||un.addEventListener("click",async()=>{await Yn()});dn==null||dn.addEventListener("click",async()=>{at&&(at.value=Jr.join(`
`)),await tn({close:!1})});fn==null||fn.addEventListener("click",async()=>{try{const t=await J("check_tor",{});vt(t?"Tor proxy is reachable.":"Tor is disabled. Enable Use Tor to test.")}catch(t){vt(`Tor check failed: ${String(t)}`)}});mn==null||mn.addEventListener("click",async()=>{const t=new Set(c.relayItems.filter(r=>r.state==="error").map(r=>r.url));if(!t.size){H("No failing relays to remove.");return}const e=c.settings.relays.filter(r=>!t.has(r));if(!e.length){H("All relays would be removed.");return}at.value=e.join(`
`),await tn({close:!1})});Fr.addEventListener("click",()=>Xe(!0));uo.addEventListener("click",()=>Xe(!1));we.addEventListener("click",t=>{t.target===we&&Xe(!1)});Ge.addEventListener("click",()=>{as()});hn==null||hn.addEventListener("click",()=>{window.innerWidth<=900?document.body.classList.toggle("sidebar-open"):document.body.classList.toggle("sidebar-collapsed")});pn==null||pn.addEventListener("click",()=>{document.body.classList.remove("sidebar-open")});so.addEventListener("click",()=>Ln.click());ln==null||ln.addEventListener("click",()=>{Mt==null||Mt.click()});Mt==null||Mt.addEventListener("change",async t=>{var r;const e=(r=t.target.files)==null?void 0:r[0];e&&await oi(e),Mt.value=""});Ln.addEventListener("change",async t=>{const e=Array.from(t.target.files||[]);await ds(e),Ln.value=""});Cn.addEventListener("keydown",async t=>{t.key==="Enter"&&(t.preventDefault(),Yr.click())});ro.addEventListener("click",async()=>us(mt.value));mt.addEventListener("keydown",async t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),await us(mt.value))});mt.addEventListener("paste",async t=>{var n;const e=(n=t.clipboardData)==null?void 0:n.items;if(!e)return;const r=[];for(const s of e)if(s.kind==="file"&&s.type.startsWith("image/")){const o=s.getAsFile();o&&r.push(o)}r.length&&(t.preventDefault(),await ds(r))});mt.addEventListener("input",De);V.addEventListener("scroll",()=>{c.isAtBottom=We(),Ot()});Ut==null||Ut.addEventListener("click",()=>{Bt(!0)});gn==null||gn.addEventListener("click",()=>{Rn()});ye==null||ye.addEventListener("click",()=>{Y.isPlaying()?Y.pauseCurrent():Y.playCurrent()});bn==null||bn.addEventListener("click",()=>Y.stopCurrent());En==null||En.addEventListener("click",()=>Y.switchSource());document.addEventListener("keydown",t=>{t.key==="Escape"&&!we.classList.contains("hidden")&&Xe(!1),t.key==="Escape"&&!Ge.classList.contains("hidden")&&as()});Un("new-message",t=>{const e=t.payload;if(!(!e||!e.room)){if(c.roomCounts[e.room]||(c.roomCounts[e.room]=0),c.roomCounts[e.room]+=1,e.room===c.currentRoom){const r=We();Xt(e,{sorted:!0}),r?Bt(!0):(c.isAtBottom=!1,Ot()),hs([e])}ht()}});Un("relay-status",t=>{Qe(t.payload)});Un("signal-message",t=>{li(t.payload).catch(()=>{})});Fo().then(Yn).catch(t=>H(String(t)));De();
