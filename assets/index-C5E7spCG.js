(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();const Ot=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function De(t){return t instanceof Uint8Array||ArrayBuffer.isView(t)&&t.constructor.name==="Uint8Array"}function bn(t){if(!Number.isSafeInteger(t)||t<0)throw new Error("positive integer expected, got "+t)}function Mt(t,...e){if(!De(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error("Uint8Array expected of length "+e+", got length="+t.length)}function mr(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");bn(t.outputLen),bn(t.blockLen)}function $e(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function uo(t,e){Mt(t);const r=e.outputLen;if(t.length<r)throw new Error("digestInto() expects output buffer of length at least "+r)}function Te(...t){for(let e=0;e<t.length;e++)t[e].fill(0)}function Qe(t){return new DataView(t.buffer,t.byteOffset,t.byteLength)}function ft(t,e){return t<<32-e|t>>>e}const yr=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",fo=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function lt(t){if(Mt(t),yr)return t.toHex();let e="";for(let r=0;r<t.length;r++)e+=fo[t[r]];return e}const yt={_0:48,_9:57,A:65,F:70,a:97,f:102};function Wn(t){if(t>=yt._0&&t<=yt._9)return t-yt._0;if(t>=yt.A&&t<=yt.F)return t-(yt.A-10);if(t>=yt.a&&t<=yt.f)return t-(yt.a-10)}function Kt(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);if(yr)return Uint8Array.fromHex(t);const e=t.length,r=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(r);for(let o=0,s=0;o<r;o++,s+=2){const i=Wn(t.charCodeAt(s)),c=Wn(t.charCodeAt(s+1));if(i===void 0||c===void 0){const l=t[s]+t[s+1];throw new Error('hex string expected, got non-hex character "'+l+'" at index '+s)}n[o]=i*16+c}return n}function Ze(t){if(typeof t!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(t))}function In(t){return typeof t=="string"&&(t=Ze(t)),Mt(t),t}function dt(...t){let e=0;for(let n=0;n<t.length;n++){const o=t[n];Mt(o),e+=o.length}const r=new Uint8Array(e);for(let n=0,o=0;n<t.length;n++){const s=t[n];r.set(s,o),o+=s.length}return r}class pr{}function ho(t){const e=n=>t().update(In(n)).digest(),r=t();return e.outputLen=r.outputLen,e.blockLen=r.blockLen,e.create=()=>t(),e}function ze(t=32){if(Ot&&typeof Ot.getRandomValues=="function")return Ot.getRandomValues(new Uint8Array(t));if(Ot&&typeof Ot.randomBytes=="function")return Uint8Array.from(Ot.randomBytes(t));throw new Error("crypto.getRandomValues must be defined")}function mo(t,e,r,n){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,r,n);const o=BigInt(32),s=BigInt(4294967295),i=Number(r>>o&s),c=Number(r&s),l=n?4:0,f=n?0:4;t.setUint32(e+l,i,n),t.setUint32(e+f,c,n)}function yo(t,e,r){return t&e^~t&r}function po(t,e,r){return t&e^t&r^e&r}class go extends pr{constructor(e,r,n,o){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=r,this.padOffset=n,this.isLE=o,this.buffer=new Uint8Array(e),this.view=Qe(this.buffer)}update(e){$e(this),e=In(e),Mt(e);const{view:r,buffer:n,blockLen:o}=this,s=e.length;for(let i=0;i<s;){const c=Math.min(o-this.pos,s-i);if(c===o){const l=Qe(e);for(;o<=s-i;i+=o)this.process(l,i);continue}n.set(e.subarray(i,i+c),this.pos),this.pos+=c,i+=c,this.pos===o&&(this.process(r,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){$e(this),uo(e,this),this.finished=!0;const{buffer:r,view:n,blockLen:o,isLE:s}=this;let{pos:i}=this;r[i++]=128,Te(this.buffer.subarray(i)),this.padOffset>o-i&&(this.process(n,0),i=0);for(let g=i;g<o;g++)r[g]=0;mo(n,o-8,BigInt(this.length*8),s),this.process(n,0);const c=Qe(e),l=this.outputLen;if(l%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const f=l/4,y=this.get();if(f>y.length)throw new Error("_sha2: outputLen bigger than state");for(let g=0;g<f;g++)c.setUint32(4*g,y[g],s)}digest(){const{buffer:e,outputLen:r}=this;this.digestInto(e);const n=e.slice(0,r);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:r,buffer:n,length:o,finished:s,destroyed:i,pos:c}=this;return e.destroyed=i,e.finished=s,e.length=o,e.pos=c,o%r&&e.buffer.set(n),e}clone(){return this._cloneInto()}}const vt=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),wo=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),xt=new Uint32Array(64);class bo extends go{constructor(e=32){super(64,e,8,!1),this.A=vt[0]|0,this.B=vt[1]|0,this.C=vt[2]|0,this.D=vt[3]|0,this.E=vt[4]|0,this.F=vt[5]|0,this.G=vt[6]|0,this.H=vt[7]|0}get(){const{A:e,B:r,C:n,D:o,E:s,F:i,G:c,H:l}=this;return[e,r,n,o,s,i,c,l]}set(e,r,n,o,s,i,c,l){this.A=e|0,this.B=r|0,this.C=n|0,this.D=o|0,this.E=s|0,this.F=i|0,this.G=c|0,this.H=l|0}process(e,r){for(let g=0;g<16;g++,r+=4)xt[g]=e.getUint32(r,!1);for(let g=16;g<64;g++){const u=xt[g-15],d=xt[g-2],x=ft(u,7)^ft(u,18)^u>>>3,S=ft(d,17)^ft(d,19)^d>>>10;xt[g]=S+xt[g-7]+x+xt[g-16]|0}let{A:n,B:o,C:s,D:i,E:c,F:l,G:f,H:y}=this;for(let g=0;g<64;g++){const u=ft(c,6)^ft(c,11)^ft(c,25),d=y+u+yo(c,l,f)+wo[g]+xt[g]|0,S=(ft(n,2)^ft(n,13)^ft(n,22))+po(n,o,s)|0;y=f,f=l,l=c,c=i+d|0,i=s,s=o,o=n,n=d+S|0}n=n+this.A|0,o=o+this.B|0,s=s+this.C|0,i=i+this.D|0,c=c+this.E|0,l=l+this.F|0,f=f+this.G|0,y=y+this.H|0,this.set(n,o,s,i,c,l,f,y)}roundClean(){Te(xt)}destroy(){this.set(0,0,0,0,0,0,0,0),Te(this.buffer)}}const Me=ho(()=>new bo),gr=Me;class wr extends pr{constructor(e,r){super(),this.finished=!1,this.destroyed=!1,mr(e);const n=In(r);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const o=this.blockLen,s=new Uint8Array(o);s.set(n.length>o?e.create().update(n).digest():n);for(let i=0;i<s.length;i++)s[i]^=54;this.iHash.update(s),this.oHash=e.create();for(let i=0;i<s.length;i++)s[i]^=106;this.oHash.update(s),Te(s)}update(e){return $e(this),this.iHash.update(e),this}digestInto(e){$e(this),Mt(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:r,iHash:n,finished:o,destroyed:s,blockLen:i,outputLen:c}=this;return e=e,e.finished=o,e.destroyed=s,e.blockLen=i,e.outputLen=c,e.oHash=r._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const br=(t,e,r)=>new wr(t,e).update(r).digest();br.create=(t,e)=>new wr(t,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Rn=BigInt(0),En=BigInt(1);function Oe(t,e=""){if(typeof t!="boolean"){const r=e&&`"${e}"`;throw new Error(r+"expected boolean, got type="+typeof t)}return t}function Ct(t,e,r=""){const n=De(t),o=t==null?void 0:t.length,s=e!==void 0;if(!n||s&&o!==e){const i=r&&`"${r}" `,c=s?` of length ${e}`:"",l=n?`length=${o}`:`type=${typeof t}`;throw new Error(i+"expected Uint8Array"+c+", got "+l)}return t}function xe(t){const e=t.toString(16);return e.length&1?"0"+e:e}function Er(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return t===""?Rn:BigInt("0x"+t)}function Yt(t){return Er(lt(t))}function vr(t){return Mt(t),Er(lt(Uint8Array.from(t).reverse()))}function Ve(t,e){return Kt(t.toString(16).padStart(e*2,"0"))}function xr(t,e){return Ve(t,e).reverse()}function Z(t,e,r){let n;if(typeof e=="string")try{n=Kt(e)}catch(s){throw new Error(t+" must be hex string or Uint8Array, cause: "+s)}else if(De(e))n=Uint8Array.from(e);else throw new Error(t+" must be hex string or Uint8Array");const o=n.length;if(typeof r=="number"&&o!==r)throw new Error(t+" of length "+r+" expected, got "+o);return n}const tn=t=>typeof t=="bigint"&&Rn<=t;function vn(t,e,r){return tn(t)&&tn(e)&&tn(r)&&e<=t&&t<r}function Eo(t,e,r,n){if(!vn(e,r,n))throw new Error("expected valid "+t+": "+r+" <= n < "+n+", got "+e)}function Sr(t){let e;for(e=0;t>Rn;t>>=En,e+=1);return e}const we=t=>(En<<BigInt(t))-En;function vo(t,e,r){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof r!="function")throw new Error("hmacFn must be a function");const n=d=>new Uint8Array(d),o=d=>Uint8Array.of(d);let s=n(t),i=n(t),c=0;const l=()=>{s.fill(1),i.fill(0),c=0},f=(...d)=>r(i,s,...d),y=(d=n(0))=>{i=f(o(0),d),s=f(),d.length!==0&&(i=f(o(1),d),s=f())},g=()=>{if(c++>=1e3)throw new Error("drbg: tried 1000 values");let d=0;const x=[];for(;d<e;){s=f();const S=s.slice();x.push(S),d+=s.length}return dt(...x)};return(d,x)=>{l(),y(d);let S;for(;!(S=x(g()));)y();return l(),S}}function $n(t,e,r={}){if(!t||typeof t!="object")throw new Error("expected valid options object");function n(o,s,i){const c=t[o];if(i&&c===void 0)return;const l=typeof c;if(l!==s||c===null)throw new Error(`param "${o}" is invalid: expected ${s}, got ${l}`)}Object.entries(e).forEach(([o,s])=>n(o,s,!1)),Object.entries(r).forEach(([o,s])=>n(o,s,!0))}function Jn(t){const e=new WeakMap;return(r,...n)=>{const o=e.get(r);if(o!==void 0)return o;const s=t(r,...n);return e.set(r,s),s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const X=BigInt(0),G=BigInt(1),Lt=BigInt(2),_r=BigInt(3),Br=BigInt(4),kr=BigInt(5),xo=BigInt(7),Ar=BigInt(8),So=BigInt(9),Cr=BigInt(16);function rt(t,e){const r=t%e;return r>=X?r:e+r}function nt(t,e,r){let n=t;for(;e-- >X;)n*=n,n%=r;return n}function Xn(t,e){if(t===X)throw new Error("invert: expected non-zero number");if(e<=X)throw new Error("invert: expected positive modulus, got "+e);let r=rt(t,e),n=e,o=X,s=G;for(;r!==X;){const c=n/r,l=n%r,f=o-s*c;n=r,r=l,o=s,s=f}if(n!==G)throw new Error("invert: does not exist");return rt(o,e)}function Tn(t,e,r){if(!t.eql(t.sqr(e),r))throw new Error("Cannot find square root")}function Lr(t,e){const r=(t.ORDER+G)/Br,n=t.pow(e,r);return Tn(t,n,e),n}function _o(t,e){const r=(t.ORDER-kr)/Ar,n=t.mul(e,Lt),o=t.pow(n,r),s=t.mul(e,o),i=t.mul(t.mul(s,Lt),o),c=t.mul(s,t.sub(i,t.ONE));return Tn(t,c,e),c}function Bo(t){const e=be(t),r=Nr(t),n=r(e,e.neg(e.ONE)),o=r(e,n),s=r(e,e.neg(n)),i=(t+xo)/Cr;return(c,l)=>{let f=c.pow(l,i),y=c.mul(f,n);const g=c.mul(f,o),u=c.mul(f,s),d=c.eql(c.sqr(y),l),x=c.eql(c.sqr(g),l);f=c.cmov(f,y,d),y=c.cmov(u,g,x);const S=c.eql(c.sqr(y),l),R=c.cmov(f,y,S);return Tn(c,R,l),R}}function Nr(t){if(t<_r)throw new Error("sqrt is not defined for small field");let e=t-G,r=0;for(;e%Lt===X;)e/=Lt,r++;let n=Lt;const o=be(t);for(;Qn(o,n)===1;)if(n++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(r===1)return Lr;let s=o.pow(n,e);const i=(e+G)/Lt;return function(l,f){if(l.is0(f))return f;if(Qn(l,f)!==1)throw new Error("Cannot find square root");let y=r,g=l.mul(l.ONE,s),u=l.pow(f,e),d=l.pow(f,i);for(;!l.eql(u,l.ONE);){if(l.is0(u))return l.ZERO;let x=1,S=l.sqr(u);for(;!l.eql(S,l.ONE);)if(x++,S=l.sqr(S),x===y)throw new Error("Cannot find square root");const R=G<<BigInt(y-x-1),b=l.pow(g,R);y=x,g=l.sqr(b),u=l.mul(u,g),d=l.mul(d,b)}return d}}function ko(t){return t%Br===_r?Lr:t%Ar===kr?_o:t%Cr===So?Bo(t):Nr(t)}const Ao=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Co(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},r=Ao.reduce((n,o)=>(n[o]="function",n),e);return $n(t,r),t}function Lo(t,e,r){if(r<X)throw new Error("invalid exponent, negatives unsupported");if(r===X)return t.ONE;if(r===G)return e;let n=t.ONE,o=e;for(;r>X;)r&G&&(n=t.mul(n,o)),o=t.sqr(o),r>>=G;return n}function Ir(t,e,r=!1){const n=new Array(e.length).fill(r?t.ZERO:void 0),o=e.reduce((i,c,l)=>t.is0(c)?i:(n[l]=i,t.mul(i,c)),t.ONE),s=t.inv(o);return e.reduceRight((i,c,l)=>t.is0(c)?i:(n[l]=t.mul(i,n[l]),t.mul(i,c)),s),n}function Qn(t,e){const r=(t.ORDER-G)/Lt,n=t.pow(e,r),o=t.eql(n,t.ONE),s=t.eql(n,t.ZERO),i=t.eql(n,t.neg(t.ONE));if(!o&&!s&&!i)throw new Error("invalid Legendre symbol result");return o?1:s?0:-1}function Rr(t,e){e!==void 0&&bn(e);const r=e!==void 0?e:t.toString(2).length,n=Math.ceil(r/8);return{nBitLength:r,nByteLength:n}}function be(t,e,r=!1,n={}){if(t<=X)throw new Error("invalid field: expected ORDER > 0, got "+t);let o,s,i=!1,c;if(typeof e=="object"&&e!=null){if(n.sqrt||r)throw new Error("cannot specify opts in two arguments");const u=e;u.BITS&&(o=u.BITS),u.sqrt&&(s=u.sqrt),typeof u.isLE=="boolean"&&(r=u.isLE),typeof u.modFromBytes=="boolean"&&(i=u.modFromBytes),c=u.allowedLengths}else typeof e=="number"&&(o=e),n.sqrt&&(s=n.sqrt);const{nBitLength:l,nByteLength:f}=Rr(t,o);if(f>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let y;const g=Object.freeze({ORDER:t,isLE:r,BITS:l,BYTES:f,MASK:we(l),ZERO:X,ONE:G,allowedLengths:c,create:u=>rt(u,t),isValid:u=>{if(typeof u!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof u);return X<=u&&u<t},is0:u=>u===X,isValidNot0:u=>!g.is0(u)&&g.isValid(u),isOdd:u=>(u&G)===G,neg:u=>rt(-u,t),eql:(u,d)=>u===d,sqr:u=>rt(u*u,t),add:(u,d)=>rt(u+d,t),sub:(u,d)=>rt(u-d,t),mul:(u,d)=>rt(u*d,t),pow:(u,d)=>Lo(g,u,d),div:(u,d)=>rt(u*Xn(d,t),t),sqrN:u=>u*u,addN:(u,d)=>u+d,subN:(u,d)=>u-d,mulN:(u,d)=>u*d,inv:u=>Xn(u,t),sqrt:s||(u=>(y||(y=ko(t)),y(g,u))),toBytes:u=>r?xr(u,f):Ve(u,f),fromBytes:(u,d=!0)=>{if(c){if(!c.includes(u.length)||u.length>f)throw new Error("Field.fromBytes: expected "+c+" bytes, got "+u.length);const S=new Uint8Array(f);S.set(u,r?0:S.length-u.length),u=S}if(u.length!==f)throw new Error("Field.fromBytes: expected "+f+" bytes, got "+u.length);let x=r?vr(u):Yt(u);if(i&&(x=rt(x,t)),!d&&!g.isValid(x))throw new Error("invalid field element: outside of range 0..ORDER");return x},invertBatch:u=>Ir(g,u),cmov:(u,d,x)=>x?d:u});return Object.freeze(g)}function $r(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function Tr(t){const e=$r(t);return e+Math.ceil(e/2)}function Mr(t,e,r=!1){const n=t.length,o=$r(e),s=Tr(e);if(n<16||n<s||n>1024)throw new Error("expected "+s+"-1024 bytes of input, got "+n);const i=r?vr(t):Yt(t),c=rt(i,e-G)+G;return r?xr(c,o):Ve(c,o)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Pt=BigInt(0),Nt=BigInt(1);function qe(t,e){const r=e.negate();return t?r:e}function en(t,e){const r=Ir(t.Fp,e.map(n=>n.Z));return e.map((n,o)=>t.fromAffine(n.toAffine(r[o])))}function Or(t,e){if(!Number.isSafeInteger(t)||t<=0||t>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+t)}function nn(t,e){Or(t,e);const r=Math.ceil(e/t)+1,n=2**(t-1),o=2**t,s=we(t),i=BigInt(t);return{windows:r,windowSize:n,mask:s,maxNumber:o,shiftBy:i}}function tr(t,e,r){const{windowSize:n,mask:o,maxNumber:s,shiftBy:i}=r;let c=Number(t&o),l=t>>i;c>n&&(c-=s,l+=Nt);const f=e*n,y=f+Math.abs(c)-1,g=c===0,u=c<0,d=e%2!==0;return{nextN:l,offset:y,isZero:g,isNeg:u,isNegF:d,offsetF:f}}function No(t,e){if(!Array.isArray(t))throw new Error("array expected");t.forEach((r,n)=>{if(!(r instanceof e))throw new Error("invalid point at index "+n)})}function Io(t,e){if(!Array.isArray(t))throw new Error("array of scalars expected");t.forEach((r,n)=>{if(!e.isValid(r))throw new Error("invalid scalar at index "+n)})}const rn=new WeakMap,qr=new WeakMap;function on(t){return qr.get(t)||1}function er(t){if(t!==Pt)throw new Error("invalid wNAF")}class Ro{constructor(e,r){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=r}_unsafeLadder(e,r,n=this.ZERO){let o=e;for(;r>Pt;)r&Nt&&(n=n.add(o)),o=o.double(),r>>=Nt;return n}precomputeWindow(e,r){const{windows:n,windowSize:o}=nn(r,this.bits),s=[];let i=e,c=i;for(let l=0;l<n;l++){c=i,s.push(c);for(let f=1;f<o;f++)c=c.add(i),s.push(c);i=c.double()}return s}wNAF(e,r,n){if(!this.Fn.isValid(n))throw new Error("invalid scalar");let o=this.ZERO,s=this.BASE;const i=nn(e,this.bits);for(let c=0;c<i.windows;c++){const{nextN:l,offset:f,isZero:y,isNeg:g,isNegF:u,offsetF:d}=tr(n,c,i);n=l,y?s=s.add(qe(u,r[d])):o=o.add(qe(g,r[f]))}return er(n),{p:o,f:s}}wNAFUnsafe(e,r,n,o=this.ZERO){const s=nn(e,this.bits);for(let i=0;i<s.windows&&n!==Pt;i++){const{nextN:c,offset:l,isZero:f,isNeg:y}=tr(n,i,s);if(n=c,!f){const g=r[l];o=o.add(y?g.negate():g)}}return er(n),o}getPrecomputes(e,r,n){let o=rn.get(r);return o||(o=this.precomputeWindow(r,e),e!==1&&(typeof n=="function"&&(o=n(o)),rn.set(r,o))),o}cached(e,r,n){const o=on(e);return this.wNAF(o,this.getPrecomputes(o,e,n),r)}unsafe(e,r,n,o){const s=on(e);return s===1?this._unsafeLadder(e,r,o):this.wNAFUnsafe(s,this.getPrecomputes(s,e,n),r,o)}createCache(e,r){Or(r,this.bits),qr.set(e,r),rn.delete(e)}hasCache(e){return on(e)!==1}}function $o(t,e,r,n){let o=e,s=t.ZERO,i=t.ZERO;for(;r>Pt||n>Pt;)r&Nt&&(s=s.add(o)),n&Nt&&(i=i.add(o)),o=o.double(),r>>=Nt,n>>=Nt;return{p1:s,p2:i}}function To(t,e,r,n){No(r,t),Io(n,e);const o=r.length,s=n.length;if(o!==s)throw new Error("arrays of points and scalars must have equal length");const i=t.ZERO,c=Sr(BigInt(o));let l=1;c>12?l=c-3:c>4?l=c-2:c>0&&(l=2);const f=we(l),y=new Array(Number(f)+1).fill(i),g=Math.floor((e.BITS-1)/l)*l;let u=i;for(let d=g;d>=0;d-=l){y.fill(i);for(let S=0;S<s;S++){const R=n[S],b=Number(R>>BigInt(d)&f);y[b]=y[b].add(r[S])}let x=i;for(let S=y.length-1,R=i;S>0;S--)R=R.add(y[S]),x=x.add(R);if(u=u.add(x),d!==0)for(let S=0;S<l;S++)u=u.double()}return u}function nr(t,e,r){if(e){if(e.ORDER!==t)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return Co(e),e}else return be(t,{isLE:r})}function Mo(t,e,r={},n){if(n===void 0&&(n=t==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${t} CURVE object`);for(const l of["p","n","h"]){const f=e[l];if(!(typeof f=="bigint"&&f>Pt))throw new Error(`CURVE.${l} must be positive bigint`)}const o=nr(e.p,r.Fp,n),s=nr(e.n,r.Fn,n),c=["Gx","Gy","a","b"];for(const l of c)if(!o.isValid(e[l]))throw new Error(`CURVE.${l} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:o,Fn:s}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const rr=(t,e)=>(t+(t>=0?e:-e)/Hr)/e;function Oo(t,e,r){const[[n,o],[s,i]]=e,c=rr(i*t,r),l=rr(-o*t,r);let f=t-c*n-l*s,y=-c*o-l*i;const g=f<wt,u=y<wt;g&&(f=-f),u&&(y=-y);const d=we(Math.ceil(Sr(r)/2))+Ht;if(f<wt||f>=d||y<wt||y>=d)throw new Error("splitScalar (endomorphism): failed, k="+t);return{k1neg:g,k1:f,k2neg:u,k2:y}}function xn(t){if(!["compact","recovered","der"].includes(t))throw new Error('Signature format must be "compact", "recovered", or "der"');return t}function sn(t,e){const r={};for(let n of Object.keys(e))r[n]=t[n]===void 0?e[n]:t[n];return Oe(r.lowS,"lowS"),Oe(r.prehash,"prehash"),r.format!==void 0&&xn(r.format),r}class qo extends Error{constructor(e=""){super(e)}}const pt={Err:qo,_tlv:{encode:(t,e)=>{const{Err:r}=pt;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length&1)throw new r("tlv.encode: unpadded data");const n=e.length/2,o=xe(n);if(o.length/2&128)throw new r("tlv.encode: long form length too big");const s=n>127?xe(o.length/2|128):"";return xe(t)+s+o+e},decode(t,e){const{Err:r}=pt;let n=0;if(t<0||t>256)throw new r("tlv.encode: wrong tag");if(e.length<2||e[n++]!==t)throw new r("tlv.decode: wrong tlv");const o=e[n++],s=!!(o&128);let i=0;if(!s)i=o;else{const l=o&127;if(!l)throw new r("tlv.decode(long): indefinite length not supported");if(l>4)throw new r("tlv.decode(long): byte length is too big");const f=e.subarray(n,n+l);if(f.length!==l)throw new r("tlv.decode: length bytes not complete");if(f[0]===0)throw new r("tlv.decode(long): zero leftmost byte");for(const y of f)i=i<<8|y;if(n+=l,i<128)throw new r("tlv.decode(long): not minimal encoding")}const c=e.subarray(n,n+i);if(c.length!==i)throw new r("tlv.decode: wrong value length");return{v:c,l:e.subarray(n+i)}}},_int:{encode(t){const{Err:e}=pt;if(t<wt)throw new e("integer: negative integers are not allowed");let r=xe(t);if(Number.parseInt(r[0],16)&8&&(r="00"+r),r.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return r},decode(t){const{Err:e}=pt;if(t[0]&128)throw new e("invalid signature integer: negative");if(t[0]===0&&!(t[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Yt(t)}},toSig(t){const{Err:e,_int:r,_tlv:n}=pt,o=Z("signature",t),{v:s,l:i}=n.decode(48,o);if(i.length)throw new e("invalid signature: left bytes after parsing");const{v:c,l}=n.decode(2,s),{v:f,l:y}=n.decode(2,l);if(y.length)throw new e("invalid signature: left bytes after parsing");return{r:r.decode(c),s:r.decode(f)}},hexFromSig(t){const{_tlv:e,_int:r}=pt,n=e.encode(2,r.encode(t.r)),o=e.encode(2,r.encode(t.s)),s=n+o;return e.encode(48,s)}},wt=BigInt(0),Ht=BigInt(1),Hr=BigInt(2),Se=BigInt(3),Ho=BigInt(4);function It(t,e){const{BYTES:r}=t;let n;if(typeof e=="bigint")n=e;else{let o=Z("private key",e);try{n=t.fromBytes(o)}catch{throw new Error(`invalid private key: expected ui8a of size ${r}, got ${typeof e}`)}}if(!t.isValidNot0(n))throw new Error("invalid private key: out of range [1..N-1]");return n}function Uo(t,e={}){const r=Mo("weierstrass",t,e),{Fp:n,Fn:o}=r;let s=r.CURVE;const{h:i,n:c}=s;$n(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:l}=e;if(l&&(!n.is0(s.a)||typeof l.beta!="bigint"||!Array.isArray(l.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const f=Kr(n,o);function y(){if(!n.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function g(T,p,m){const{x:h,y:E}=p.toAffine(),_=n.toBytes(h);if(Oe(m,"isCompressed"),m){y();const A=!n.isOdd(E);return dt(Ur(A),_)}else return dt(Uint8Array.of(4),_,n.toBytes(E))}function u(T){Ct(T,void 0,"Point");const{publicKey:p,publicKeyUncompressed:m}=f,h=T.length,E=T[0],_=T.subarray(1);if(h===p&&(E===2||E===3)){const A=n.fromBytes(_);if(!n.isValid(A))throw new Error("bad point: is not on curve, wrong x");const k=S(A);let B;try{B=n.sqrt(k)}catch(P){const O=P instanceof Error?": "+P.message:"";throw new Error("bad point: is not on curve, sqrt error"+O)}y();const C=n.isOdd(B);return(E&1)===1!==C&&(B=n.neg(B)),{x:A,y:B}}else if(h===m&&E===4){const A=n.BYTES,k=n.fromBytes(_.subarray(0,A)),B=n.fromBytes(_.subarray(A,A*2));if(!R(k,B))throw new Error("bad point: is not on curve");return{x:k,y:B}}else throw new Error(`bad point: got length ${h}, expected compressed=${p} or uncompressed=${m}`)}const d=e.toBytes||g,x=e.fromBytes||u;function S(T){const p=n.sqr(T),m=n.mul(p,T);return n.add(n.add(m,n.mul(T,s.a)),s.b)}function R(T,p){const m=n.sqr(p),h=S(T);return n.eql(m,h)}if(!R(s.Gx,s.Gy))throw new Error("bad curve params: generator point");const b=n.mul(n.pow(s.a,Se),Ho),I=n.mul(n.sqr(s.b),BigInt(27));if(n.is0(n.add(b,I)))throw new Error("bad curve params: a or b");function M(T,p,m=!1){if(!n.isValid(p)||m&&n.is0(p))throw new Error(`bad point coordinate ${T}`);return p}function U(T){if(!(T instanceof w))throw new Error("ProjectivePoint expected")}function K(T){if(!l||!l.basises)throw new Error("no endo");return Oo(T,l.basises,o.ORDER)}const W=Jn((T,p)=>{const{X:m,Y:h,Z:E}=T;if(n.eql(E,n.ONE))return{x:m,y:h};const _=T.is0();p==null&&(p=_?n.ONE:n.inv(E));const A=n.mul(m,p),k=n.mul(h,p),B=n.mul(E,p);if(_)return{x:n.ZERO,y:n.ZERO};if(!n.eql(B,n.ONE))throw new Error("invZ was invalid");return{x:A,y:k}}),st=Jn(T=>{if(T.is0()){if(e.allowInfinityPoint&&!n.is0(T.Y))return;throw new Error("bad point: ZERO")}const{x:p,y:m}=T.toAffine();if(!n.isValid(p)||!n.isValid(m))throw new Error("bad point: x or y not field elements");if(!R(p,m))throw new Error("bad point: equation left != right");if(!T.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function it(T,p,m,h,E){return m=new w(n.mul(m.X,T),m.Y,m.Z),p=qe(h,p),m=qe(E,m),p.add(m)}class w{constructor(p,m,h){this.X=M("x",p),this.Y=M("y",m,!0),this.Z=M("z",h),Object.freeze(this)}static CURVE(){return s}static fromAffine(p){const{x:m,y:h}=p||{};if(!p||!n.isValid(m)||!n.isValid(h))throw new Error("invalid affine point");if(p instanceof w)throw new Error("projective point not allowed");return n.is0(m)&&n.is0(h)?w.ZERO:new w(m,h,n.ONE)}static fromBytes(p){const m=w.fromAffine(x(Ct(p,void 0,"point")));return m.assertValidity(),m}static fromHex(p){return w.fromBytes(Z("pointHex",p))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(p=8,m=!0){return F.createCache(this,p),m||this.multiply(Se),this}assertValidity(){st(this)}hasEvenY(){const{y:p}=this.toAffine();if(!n.isOdd)throw new Error("Field doesn't support isOdd");return!n.isOdd(p)}equals(p){U(p);const{X:m,Y:h,Z:E}=this,{X:_,Y:A,Z:k}=p,B=n.eql(n.mul(m,k),n.mul(_,E)),C=n.eql(n.mul(h,k),n.mul(A,E));return B&&C}negate(){return new w(this.X,n.neg(this.Y),this.Z)}double(){const{a:p,b:m}=s,h=n.mul(m,Se),{X:E,Y:_,Z:A}=this;let k=n.ZERO,B=n.ZERO,C=n.ZERO,N=n.mul(E,E),P=n.mul(_,_),O=n.mul(A,A),$=n.mul(E,_);return $=n.add($,$),C=n.mul(E,A),C=n.add(C,C),k=n.mul(p,C),B=n.mul(h,O),B=n.add(k,B),k=n.sub(P,B),B=n.add(P,B),B=n.mul(k,B),k=n.mul($,k),C=n.mul(h,C),O=n.mul(p,O),$=n.sub(N,O),$=n.mul(p,$),$=n.add($,C),C=n.add(N,N),N=n.add(C,N),N=n.add(N,O),N=n.mul(N,$),B=n.add(B,N),O=n.mul(_,A),O=n.add(O,O),N=n.mul(O,$),k=n.sub(k,N),C=n.mul(O,P),C=n.add(C,C),C=n.add(C,C),new w(k,B,C)}add(p){U(p);const{X:m,Y:h,Z:E}=this,{X:_,Y:A,Z:k}=p;let B=n.ZERO,C=n.ZERO,N=n.ZERO;const P=s.a,O=n.mul(s.b,Se);let $=n.mul(m,_),q=n.mul(h,A),D=n.mul(E,k),J=n.add(m,h),H=n.add(_,A);J=n.mul(J,H),H=n.add($,q),J=n.sub(J,H),H=n.add(m,E);let j=n.add(_,k);return H=n.mul(H,j),j=n.add($,D),H=n.sub(H,j),j=n.add(h,E),B=n.add(A,k),j=n.mul(j,B),B=n.add(q,D),j=n.sub(j,B),N=n.mul(P,H),B=n.mul(O,D),N=n.add(B,N),B=n.sub(q,N),N=n.add(q,N),C=n.mul(B,N),q=n.add($,$),q=n.add(q,$),D=n.mul(P,D),H=n.mul(O,H),q=n.add(q,D),D=n.sub($,D),D=n.mul(P,D),H=n.add(H,D),$=n.mul(q,H),C=n.add(C,$),$=n.mul(j,H),B=n.mul(J,B),B=n.sub(B,$),$=n.mul(J,q),N=n.mul(j,N),N=n.add(N,$),new w(B,C,N)}subtract(p){return this.add(p.negate())}is0(){return this.equals(w.ZERO)}multiply(p){const{endo:m}=e;if(!o.isValidNot0(p))throw new Error("invalid scalar: out of range");let h,E;const _=A=>F.cached(this,A,k=>en(w,k));if(m){const{k1neg:A,k1:k,k2neg:B,k2:C}=K(p),{p:N,f:P}=_(k),{p:O,f:$}=_(C);E=P.add($),h=it(m.beta,N,O,A,B)}else{const{p:A,f:k}=_(p);h=A,E=k}return en(w,[h,E])[0]}multiplyUnsafe(p){const{endo:m}=e,h=this;if(!o.isValid(p))throw new Error("invalid scalar: out of range");if(p===wt||h.is0())return w.ZERO;if(p===Ht)return h;if(F.hasCache(this))return this.multiply(p);if(m){const{k1neg:E,k1:_,k2neg:A,k2:k}=K(p),{p1:B,p2:C}=$o(w,h,_,k);return it(m.beta,B,C,E,A)}else return F.unsafe(h,p)}multiplyAndAddUnsafe(p,m,h){const E=this.multiplyUnsafe(m).add(p.multiplyUnsafe(h));return E.is0()?void 0:E}toAffine(p){return W(this,p)}isTorsionFree(){const{isTorsionFree:p}=e;return i===Ht?!0:p?p(w,this):F.unsafe(this,c).is0()}clearCofactor(){const{clearCofactor:p}=e;return i===Ht?this:p?p(w,this):this.multiplyUnsafe(i)}isSmallOrder(){return this.multiplyUnsafe(i).is0()}toBytes(p=!0){return Oe(p,"isCompressed"),this.assertValidity(),d(w,this,p)}toHex(p=!0){return lt(this.toBytes(p))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(p=!0){return this.toBytes(p)}_setWindowSize(p){this.precompute(p)}static normalizeZ(p){return en(w,p)}static msm(p,m){return To(w,o,p,m)}static fromPrivateKey(p){return w.BASE.multiply(It(o,p))}}w.BASE=new w(s.Gx,s.Gy,n.ONE),w.ZERO=new w(n.ZERO,n.ONE,n.ZERO),w.Fp=n,w.Fn=o;const L=o.BITS,F=new Ro(w,e.endo?Math.ceil(L/2):L);return w.BASE.precompute(8),w}function Ur(t){return Uint8Array.of(t?2:3)}function Kr(t,e){return{secretKey:e.BYTES,publicKey:1+t.BYTES,publicKeyUncompressed:1+2*t.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function Ko(t,e={}){const{Fn:r}=t,n=e.randomBytes||ze,o=Object.assign(Kr(t.Fp,r),{seed:Tr(r.ORDER)});function s(d){try{return!!It(r,d)}catch{return!1}}function i(d,x){const{publicKey:S,publicKeyUncompressed:R}=o;try{const b=d.length;return x===!0&&b!==S||x===!1&&b!==R?!1:!!t.fromBytes(d)}catch{return!1}}function c(d=n(o.seed)){return Mr(Ct(d,o.seed,"seed"),r.ORDER)}function l(d,x=!0){return t.BASE.multiply(It(r,d)).toBytes(x)}function f(d){const x=c(d);return{secretKey:x,publicKey:l(x)}}function y(d){if(typeof d=="bigint")return!1;if(d instanceof t)return!0;const{secretKey:x,publicKey:S,publicKeyUncompressed:R}=o;if(r.allowedLengths||x===S)return;const b=Z("key",d).length;return b===S||b===R}function g(d,x,S=!0){if(y(d)===!0)throw new Error("first arg must be private key");if(y(x)===!1)throw new Error("second arg must be public key");const R=It(r,d);return t.fromHex(x).multiply(R).toBytes(S)}return Object.freeze({getPublicKey:l,getSharedSecret:g,keygen:f,Point:t,utils:{isValidSecretKey:s,isValidPublicKey:i,randomSecretKey:c,isValidPrivateKey:s,randomPrivateKey:c,normPrivateKeyToScalar:d=>It(r,d),precompute(d=8,x=t.BASE){return x.precompute(d,!1)}},lengths:o})}function Po(t,e,r={}){mr(e),$n(r,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const n=r.randomBytes||ze,o=r.hmac||((m,...h)=>br(e,m,dt(...h))),{Fp:s,Fn:i}=t,{ORDER:c,BITS:l}=i,{keygen:f,getPublicKey:y,getSharedSecret:g,utils:u,lengths:d}=Ko(t,r),x={prehash:!1,lowS:typeof r.lowS=="boolean"?r.lowS:!1,format:void 0,extraEntropy:!1},S="compact";function R(m){const h=c>>Ht;return m>h}function b(m,h){if(!i.isValidNot0(h))throw new Error(`invalid signature ${m}: out of range 1..Point.Fn.ORDER`);return h}function I(m,h){xn(h);const E=d.signature,_=h==="compact"?E:h==="recovered"?E+1:void 0;return Ct(m,_,`${h} signature`)}class M{constructor(h,E,_){this.r=b("r",h),this.s=b("s",E),_!=null&&(this.recovery=_),Object.freeze(this)}static fromBytes(h,E=S){I(h,E);let _;if(E==="der"){const{r:C,s:N}=pt.toSig(Ct(h));return new M(C,N)}E==="recovered"&&(_=h[0],E="compact",h=h.subarray(1));const A=i.BYTES,k=h.subarray(0,A),B=h.subarray(A,A*2);return new M(i.fromBytes(k),i.fromBytes(B),_)}static fromHex(h,E){return this.fromBytes(Kt(h),E)}addRecoveryBit(h){return new M(this.r,this.s,h)}recoverPublicKey(h){const E=s.ORDER,{r:_,s:A,recovery:k}=this;if(k==null||![0,1,2,3].includes(k))throw new Error("recovery id invalid");if(c*Hr<E&&k>1)throw new Error("recovery id is ambiguous for h>1 curve");const C=k===2||k===3?_+c:_;if(!s.isValid(C))throw new Error("recovery id 2 or 3 invalid");const N=s.toBytes(C),P=t.fromBytes(dt(Ur((k&1)===0),N)),O=i.inv(C),$=K(Z("msgHash",h)),q=i.create(-$*O),D=i.create(A*O),J=t.BASE.multiplyUnsafe(q).add(P.multiplyUnsafe(D));if(J.is0())throw new Error("point at infinify");return J.assertValidity(),J}hasHighS(){return R(this.s)}toBytes(h=S){if(xn(h),h==="der")return Kt(pt.hexFromSig(this));const E=i.toBytes(this.r),_=i.toBytes(this.s);if(h==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return dt(Uint8Array.of(this.recovery),E,_)}return dt(E,_)}toHex(h){return lt(this.toBytes(h))}assertValidity(){}static fromCompact(h){return M.fromBytes(Z("sig",h),"compact")}static fromDER(h){return M.fromBytes(Z("sig",h),"der")}normalizeS(){return this.hasHighS()?new M(this.r,i.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return lt(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return lt(this.toBytes("compact"))}}const U=r.bits2int||function(h){if(h.length>8192)throw new Error("input is too large");const E=Yt(h),_=h.length*8-l;return _>0?E>>BigInt(_):E},K=r.bits2int_modN||function(h){return i.create(U(h))},W=we(l);function st(m){return Eo("num < 2^"+l,m,wt,W),i.toBytes(m)}function it(m,h){return Ct(m,void 0,"message"),h?Ct(e(m),void 0,"prehashed message"):m}function w(m,h,E){if(["recovered","canonical"].some(q=>q in E))throw new Error("sign() legacy options not supported");const{lowS:_,prehash:A,extraEntropy:k}=sn(E,x);m=it(m,A);const B=K(m),C=It(i,h),N=[st(C),st(B)];if(k!=null&&k!==!1){const q=k===!0?n(d.secretKey):k;N.push(Z("extraEntropy",q))}const P=dt(...N),O=B;function $(q){const D=U(q);if(!i.isValidNot0(D))return;const J=i.inv(D),H=t.BASE.multiply(D).toAffine(),j=i.create(H.x);if(j===wt)return;const ve=i.create(J*i.create(O+j*C));if(ve===wt)return;let Fn=(H.x===j?0:2)|Number(H.y&Ht),Gn=ve;return _&&R(ve)&&(Gn=i.neg(ve),Fn^=1),new M(j,Gn,Fn)}return{seed:P,k2sig:$}}function L(m,h,E={}){m=Z("message",m);const{seed:_,k2sig:A}=w(m,h,E);return vo(e.outputLen,i.BYTES,o)(_,A)}function F(m){let h;const E=typeof m=="string"||De(m),_=!E&&m!==null&&typeof m=="object"&&typeof m.r=="bigint"&&typeof m.s=="bigint";if(!E&&!_)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(_)h=new M(m.r,m.s);else if(E){try{h=M.fromBytes(Z("sig",m),"der")}catch(A){if(!(A instanceof pt.Err))throw A}if(!h)try{h=M.fromBytes(Z("sig",m),"compact")}catch{return!1}}return h||!1}function T(m,h,E,_={}){const{lowS:A,prehash:k,format:B}=sn(_,x);if(E=Z("publicKey",E),h=it(Z("message",h),k),"strict"in _)throw new Error("options.strict was renamed to lowS");const C=B===void 0?F(m):M.fromBytes(Z("sig",m),B);if(C===!1)return!1;try{const N=t.fromBytes(E);if(A&&C.hasHighS())return!1;const{r:P,s:O}=C,$=K(h),q=i.inv(O),D=i.create($*q),J=i.create(P*q),H=t.BASE.multiplyUnsafe(D).add(N.multiplyUnsafe(J));return H.is0()?!1:i.create(H.x)===P}catch{return!1}}function p(m,h,E={}){const{prehash:_}=sn(E,x);return h=it(h,_),M.fromBytes(m,"recovered").recoverPublicKey(h).toBytes()}return Object.freeze({keygen:f,getPublicKey:y,getSharedSecret:g,utils:u,lengths:d,Point:t,sign:L,verify:T,recoverPublicKey:p,Signature:M,hash:e})}function Do(t){const e={a:t.a,b:t.b,p:t.Fp.ORDER,n:t.n,h:t.h,Gx:t.Gx,Gy:t.Gy},r=t.Fp;let n=t.allowedPrivateKeyLengths?Array.from(new Set(t.allowedPrivateKeyLengths.map(i=>Math.ceil(i/2)))):void 0;const o=be(e.n,{BITS:t.nBitLength,allowedLengths:n,modFromBytes:t.wrapPrivateKey}),s={Fp:r,Fn:o,allowInfinityPoint:t.allowInfinityPoint,endo:t.endo,isTorsionFree:t.isTorsionFree,clearCofactor:t.clearCofactor,fromBytes:t.fromBytes,toBytes:t.toBytes};return{CURVE:e,curveOpts:s}}function Zo(t){const{CURVE:e,curveOpts:r}=Do(t),n={hmac:t.hmac,randomBytes:t.randomBytes,lowS:t.lowS,bits2int:t.bits2int,bits2int_modN:t.bits2int_modN};return{CURVE:e,curveOpts:r,hash:t.hash,ecdsaOpts:n}}function zo(t,e){const r=e.Point;return Object.assign({},e,{ProjectivePoint:r,CURVE:Object.assign({},t,Rr(r.Fn.ORDER,r.Fn.BITS))})}function Vo(t){const{CURVE:e,curveOpts:r,hash:n,ecdsaOpts:o}=Zo(t),s=Uo(e,r),i=Po(s,n,o);return zo(t,i)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function jo(t,e){const r=n=>Vo({...t,hash:n});return{...r(e),create:r}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Dt={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},Yo={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},Fo=BigInt(0),or=BigInt(1),Sn=BigInt(2);function Go(t){const e=Dt.p,r=BigInt(3),n=BigInt(6),o=BigInt(11),s=BigInt(22),i=BigInt(23),c=BigInt(44),l=BigInt(88),f=t*t*t%e,y=f*f*t%e,g=nt(y,r,e)*y%e,u=nt(g,r,e)*y%e,d=nt(u,Sn,e)*f%e,x=nt(d,o,e)*d%e,S=nt(x,s,e)*x%e,R=nt(S,c,e)*S%e,b=nt(R,l,e)*R%e,I=nt(b,c,e)*S%e,M=nt(I,r,e)*y%e,U=nt(M,i,e)*x%e,K=nt(U,n,e)*f%e,W=nt(K,Sn,e);if(!He.eql(He.sqr(W),t))throw new Error("Cannot find square root");return W}const He=be(Dt.p,{sqrt:Go}),Mn=jo({...Dt,Fp:He,lowS:!0,endo:Yo},Me),sr={};function Ue(t,...e){let r=sr[t];if(r===void 0){const n=Me(Ze(t));r=dt(n,n),sr[t]=r}return Me(dt(r,...e))}const On=t=>t.toBytes(!0).slice(1),Ft=Mn.Point,qn=t=>t%Sn===Fo;function _n(t){const{Fn:e,BASE:r}=Ft,n=It(e,t),o=r.multiply(n);return{scalar:qn(o.y)?n:e.neg(n),bytes:On(o)}}function Pr(t){const e=He;if(!e.isValidNot0(t))throw new Error("invalid x: Fail if x ≥ p");const r=e.create(t*t),n=e.create(r*t+BigInt(7));let o=e.sqrt(n);qn(o)||(o=e.neg(o));const s=Ft.fromAffine({x:t,y:o});return s.assertValidity(),s}const Xt=Yt;function Dr(...t){return Ft.Fn.create(Xt(Ue("BIP0340/challenge",...t)))}function ir(t){return _n(t).bytes}function Wo(t,e,r=ze(32)){const{Fn:n}=Ft,o=Z("message",t),{bytes:s,scalar:i}=_n(e),c=Z("auxRand",r,32),l=n.toBytes(i^Xt(Ue("BIP0340/aux",c))),f=Ue("BIP0340/nonce",l,s,o),{bytes:y,scalar:g}=_n(f),u=Dr(y,s,o),d=new Uint8Array(64);if(d.set(y,0),d.set(n.toBytes(n.create(g+u*i)),32),!Zr(d,o,s))throw new Error("sign: Invalid signature produced");return d}function Zr(t,e,r){const{Fn:n,BASE:o}=Ft,s=Z("signature",t,64),i=Z("message",e),c=Z("publicKey",r,32);try{const l=Pr(Xt(c)),f=Xt(s.subarray(0,32));if(!vn(f,or,Dt.p))return!1;const y=Xt(s.subarray(32,64));if(!vn(y,or,Dt.n))return!1;const g=Dr(n.toBytes(f),On(l),i),u=o.multiplyUnsafe(y).add(l.multiplyUnsafe(n.neg(g))),{x:d,y:x}=u.toAffine();return!(u.is0()||!qn(x)||d!==f)}catch{return!1}}const zr=(()=>{const r=(o=ze(48))=>Mr(o,Dt.n);Mn.utils.randomSecretKey;function n(o){const s=r(o);return{secretKey:s,publicKey:ir(s)}}return{keygen:n,getPublicKey:ir,sign:Wo,verify:Zr,Point:Ft,utils:{randomSecretKey:r,randomPrivateKey:r,taggedHash:Ue,lift_x:Pr,pointToBytes:On,numberToBytesBE:Ve,bytesToNumberBE:Yt,mod:rt},lengths:{secretKey:32,publicKey:32,publicKeyHasPrefix:!1,signature:32*2,seed:48}}})(),v=t=>document.getElementById(t),a={settings:null,currentRoom:"#test",rooms:[],roomCounts:{},attachments:[],maxImageKB:300,maxPayloadKB:450,peers:new Map,sessions:new Map,pendingOffers:new Map,lastRelayNotice:"",lastRelayDetail:"",pendingRelayDetail:!1,relayPollId:null,relayItems:[],messagePollId:null,lastMessageId:new Map,initialBuffering:!1,bufferedMessages:[],bufferTimer:null,replyTo:null,isAtBottom:!0},bt=new Map,Zt=new Map,ye=new Set,zt=new Map;let je="echochan-web";const Y=(()=>{const t=new Map;let e=null,r=null,n=!1;const o=[];function s(b){const I=o.indexOf(b);I>=0&&o.splice(I,1),o.unshift(b)}function i(b){!b||!b.id||(t.set(b.id,b),s(b.id),St())}function c(b){if(!b)return;t.delete(b);const I=o.indexOf(b);I>=0&&o.splice(I,1),e===b&&(e=null,r=null,n=!1),St()}function l(b){var I;for(const[M,U]of t.entries())if(M!==b)try{(I=U.pause)==null||I.call(U)}catch{}}function f(b){var I;t.has(b)&&(l(b),e=b,r=((I=t.get(b))==null?void 0:I.type)||null,n=!0,s(b),St())}function y(b){e===b&&(n=!1,St())}function g(){var I;const b=e?t.get(e):null;if(b)try{(I=b.play)==null||I.call(b),n=!0,St()}catch{}}function u(){var I;const b=e?t.get(e):null;if(b)try{(I=b.pause)==null||I.call(b),n=!1,St()}catch{}}function d(){var I;const b=e?t.get(e):null;if(b){try{(I=b.stop)==null||I.call(b)}catch{}n=!1,e=null,r=null,St()}}function x(){var W;if(t.size<2)return;const b=o.filter(st=>t.has(st)),I=b.indexOf(e),M=I>=0?(I+1)%b.length:0,U=b[M];if(!U)return;f(U);const K=t.get(U);(W=K==null?void 0:K.play)==null||W.call(K)}function S(){var b;for(const I of t.values())try{(b=I.stop)==null||b.call(I)}catch{}t.clear(),o.length=0,e=null,r=null,n=!1,St()}function R(){return e&&t.get(e)||null}return{registerSource:i,unregisterSource:c,requestFocus:f,markPaused:y,playCurrent:g,pauseCurrent:u,stopCurrent:d,switchSource:x,clearAll:S,getCurrent:R,isPlaying:()=>n,currentType:()=>r}})(),Jt=new Map,Hn=async(t,e)=>(Jt.has(t)||Jt.set(t,new Set),Jt.get(t).add(e),()=>{var r;return(r=Jt.get(t))==null?void 0:r.delete(e)});function Bn(t,e){const r=Jt.get(t);r&&r.forEach(n=>n({payload:e}))}const Q=async(t,e={})=>{switch(t){case"get_state":return Cs();case"save_settings":return Ls(e.settings);case"add_room":return Ns(e.room);case"remove_room":return Is(e.room);case"get_room_messages":return Rs(e.room);case"connect_relays":return $s();case"send_message":return Ts(e.message);case"send_signal":return Ms(e.signal);case"check_tor":throw new Error("Tor is not supported in the web build.");default:throw new Error(`Unknown command: ${t}`)}},ar=v("room-list"),kn=v("command-input"),ht=v("message-input"),V=v("messages"),cr=v("inline-previews"),Jo=v("relay-status"),Vt=v("current-room"),Vr=v("connect-btn"),Xo=v("send-btn"),Qo=v("attach-btn"),an=v("p2p-btn"),ts=v("settings-btn"),_t=v("settings-modal"),_e=_t==null?void 0:_t.querySelector(".modal-content"),es=v("settings-close"),ns=v("settings-save"),cn=v("relay-test"),ln=v("relay-defaults"),un=v("tor-check"),fn=v("relay-prune"),Be=v("relay-status-list"),pe=v("confirm-modal"),rs=v("confirm-title"),os=v("confirm-body"),jr=v("confirm-ok"),ss=v("confirm-cancel"),tt=v("nick-input"),ct=v("relay-input"),Qt=v("stun-input"),te=v("turn-input"),ee=v("turn-username"),ne=v("turn-password"),Bt=v("max-image-kb"),kt=v("max-payload-kb"),re=v("supabase-upload-toggle"),oe=v("supabase-url"),se=v("supabase-anon-key"),ie=v("supabase-bucket"),ae=v("tor-toggle"),ce=v("proxy-input"),le=v("max-p2p-mb"),ue=v("p2p-timeout"),fe=v("p2p-recent-min"),de=v("p2p-max-sessions"),An=v("file-input"),Rt=v("p2p-file-input"),qt=v("target-select");v("p2p-inbox");const Wt=v("relay-errors"),is=v("toast-stack"),Ye=v("image-viewer"),Yr=v("viewer-image"),Ut=v("jump-latest"),dn=v("sidebar-toggle"),hn=v("sidebar-overlay"),mn=v("reply-bar"),ke=v("reply-nick"),Ae=v("reply-snippet"),yn=v("reply-cancel"),pn=v("now-playing"),Ce=v("np-title"),Le=v("np-meta"),he=v("np-play"),gn=v("np-stop"),wn=v("np-switch"),as=44;let Ie=null;const Fr=["wss://nos.lol","wss://relay.damus.io","wss://nostr.oxtr.dev","wss://www.nostr.ltd"];function At(t,e="info",r=6e3){if(!t)return;const n=document.createElement("div");n.className=`toast ${e==="error"?"error":""}`.trim(),n.textContent=t,is.appendChild(n),setTimeout(()=>{n.remove()},r)}function Fe(t){const e=[];for(const r of t){const n=String(r||"").trim();if(!n)continue;const s=n.split(/\s+/)[0].replace(/[;,]+$/,"");s.startsWith("wss://")&&e.push(s)}return e}function et(t){const e=String(t||"").trim();return e?e.startsWith("#")?e:`#${e}`:""}function Un(t){const e=[],r=new Set;for(const n of t||[]){const o=et(n);o&&!r.has(o)&&(r.add(o),e.push(o))}return e}function lr(){return{nick:"Anonymous",relays:[...Fr],rooms:["#echo"],max_image_kb:40,max_payload_kb:80,supabase_upload:!1,supabase_url:"",supabase_anon_key:"",supabase_bucket:"echochan-images",stun_urls:["stun:stun.l.google.com:19302"],turn_urls:[],turn_username:"",turn_password:"",max_p2p_mb:5,p2p_timeout_sec:15,p2p_recent_minutes:10,p2p_max_sessions:2,nostr_pubkey:"",nostr_privkey:"",client_id:"",use_tor:!1,proxy_url:""}}function cs(){const t=Mn.utils.randomPrivateKey(),e=zr.getPublicKey(t);return{priv:lt(t),pub:lt(e)}}function Gr(t){if(!t.nostr_privkey||!t.nostr_pubkey){const e=cs();t.nostr_privkey=e.priv,t.nostr_pubkey=e.pub}t.client_id=t.nostr_pubkey}function ls(){const t=localStorage.getItem("echochan_settings");let e=lr();if(t)try{e={...e,...JSON.parse(t)}}catch{e=lr()}return e.relays=Fe(e.relays||[]),e.rooms=Un(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),Gr(e),e}function Kn(t){localStorage.setItem("echochan_settings",JSON.stringify(t))}function Wr(t){return`echochan-${(t||"").slice(0,8)||"web"}`}function ot(t){if(t&&typeof t.createdAtSec=="number")return t.createdAtSec;const e=Number((t==null?void 0:t.ts)||(t==null?void 0:t.receivedAtMs)||0);return e?Math.floor(e/1e3):0}function Pn(t){const e=JSON.stringify(t.attachments||[]),r=JSON.stringify(t.reply||null),n=ot(t),o=`${t.room}${t.nick}${n}${t.text}${e}${r}`,s=gr(Ze(o));return lt(s)}function ur(t){const e=ot(t),r=Math.floor(ut()/1e3);return e?Math.abs(e-r)>6*3600&&Math.floor(((t==null?void 0:t.receivedAtMs)||ut())/1e3)||e:r}function ge(t,e){const r=ur(t),n=ur(e);if(r!==n)return r-n;const o=String((t==null?void 0:t.id)||""),s=String((e==null?void 0:e.id)||"");return o.localeCompare(s)}function $t(t){if(!t)return"unknown";const e=new Date(t*1e3),r=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${r}-${n}-${o}`}function us(t){if(!t)return"";const e=new Date,r=$t(Math.floor((e.getTime()-864e5)/1e3)),n=$t(Math.floor(e.getTime()/1e3)),o=$t(t);return o===n?"Сегодня":o===r?"Вчера":o}function Cn(t){const e=document.createElement("div");return e.className="day-separator",e.dataset.dayKey=$t(t),e.textContent=us(t),e}function fs(t){const e=String(t||"Anonymous");let r=0;for(let n=0;n<e.length;n+=1)r=(r*31+e.charCodeAt(n))%360;return`hsl(${r}, 55%, 70%)`}function ds(t){if(!t)return null;const r=Nn(String(t.text||"")).trim();return r?r.length>120?`${r.slice(0,120)}…`:r:t.attachments&&t.attachments.length?"[media]":"(no text)"}function hs(t){!t||!t.id||(a.replyTo={id:t.id,nick:t.nick||"Anonymous",text:ds(t),ts:t.ts||ut()},Dn())}function Ln(){a.replyTo=null,Dn()}function Dn(){if(mn){if(!a.replyTo){mn.classList.add("hidden"),ke&&(ke.textContent=""),Ae&&(Ae.textContent="");return}mn.classList.remove("hidden"),ke&&(ke.textContent=a.replyTo.nick),Ae&&(Ae.textContent=a.replyTo.text||"")}}function ms(t){if(!t)return;const e=V.querySelector(`[data-msg-id="${t}"]`);e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.classList.add("flash"),setTimeout(()=>e.classList.remove("flash"),800))}let at=null;function ys(t,e){if(!t)return;at||(at=document.createElement("div"),at.className="reply-tooltip",document.body.appendChild(at));const r=zt.get(e);if(!r)at.textContent="Original message not available";else{const o=`${r.nick||"Anonymous"} · ${ro(r.createdAtSec||ot(r))}`,s=r.text||"";at.textContent=`${o}
${s}`}const n=t.getBoundingClientRect();at.style.left=`${Math.min(n.left,window.innerWidth-260)}px`,at.style.top=`${Math.max(12,n.top-8)}px`,at.classList.add("visible")}function ps(){at&&at.classList.remove("visible")}function Ge(){return V.scrollHeight-V.scrollTop-V.clientHeight<=80}function Tt(){Ut&&(a.isAtBottom?Ut.classList.add("hidden"):Ut.classList.remove("hidden"))}function Jr(t){var r;let e=t.previousSibling;for(;e;){if((r=e.classList)!=null&&r.contains("message"))return e;e=e.previousSibling}return null}function Xr(t){var r;let e=t.nextSibling;for(;e;){if((r=e.classList)!=null&&r.contains("message"))return e;e=e.nextSibling}return null}function gs(t,e){var f,y,g,u;const r=t.dataset.dayKey||$t(ot(e)),n=Jr(t),o=Xr(t),s=n?n.dataset.dayKey:null,i=(y=(f=t.previousSibling)==null?void 0:f.classList)!=null&&y.contains("day-separator")?t.previousSibling:null;if(s!==r){if(!i||i.nextSibling!==t){const d=Cn(ot(e));V.insertBefore(d,t)}}else i&&i.remove();const c=o?o.dataset.dayKey:null,l=(u=(g=t.nextSibling)==null?void 0:g.classList)!=null&&u.contains("day-separator")?t.nextSibling:null;if(o&&c!==r){if(!l||l.previousSibling!==t){const d=Cn(ot(o));V.insertBefore(d,o)}}else l&&c===r&&l.remove()}function Re(t,e){const r=t.querySelector(".meta");r&&r.classList.toggle("compact",!e)}function fr(t){if(!t)return;if(t.dataset.groupable!=="1"){Re(t,!0);return}const e=Jr(t);if(!e||e.dataset.groupable!=="1"){Re(t,!0);return}const r=e.dataset.author===t.dataset.author,n=e.dataset.dayKey===t.dataset.dayKey;Re(t,!(r&&n))}function ws(){a.initialBuffering=!0,a.bufferedMessages=[],a.bufferTimer&&clearTimeout(a.bufferTimer),a.bufferTimer=setTimeout(()=>Es(),800)}function bs(t){return!t||(t.id||(t.id=Pn(t)),t.createdAtSec||(t.createdAtSec=ot(t)),t.receivedAtMs||(t.receivedAtMs=ut()),ye.has(t.id))?null:(ye.add(t.id),t)}function Es(){a.initialBuffering=!1;const t=a.bufferedMessages||[];if(a.bufferedMessages=[],!t.length){Tt();return}t.sort(ge);const e=Ge(),r=a.currentRoom;t.forEach(n=>{const o=Zt.get(n.room)||[];if(o.push(n),o.sort(ge),o.length>500){const s=o.shift();s!=null&&s.id&&zt.delete(s.id)}Zt.set(n.room,o),n!=null&&n.id&&zt.set(n.id,n),a.roomCounts[n.room]=o.length,n.room===r&&Ee(n,{sorted:!0})}),mt(),e&&Gt(!0)}function St(){if(!pn)return;const t=Y.getCurrent();if(!t){pn.classList.add("empty"),Ce&&(Ce.textContent="No audio"),Le&&(Le.textContent="");return}pn.classList.remove("empty"),Ce&&(Ce.textContent=t.title||"Now playing"),Le&&(Le.textContent=t.type?t.type.toUpperCase():""),he&&(he.textContent=Y.isPlaying()?"⏸":"▶")}let Ne=null;function vs(){return window.YT&&window.YT.Player?Promise.resolve(window.YT):Ne||(Ne=new Promise(t=>{if(window.YT&&window.YT.Player){t(window.YT);return}if(window.onYouTubeIframeAPIReady=()=>t(window.YT),!document.getElementById("yt-iframe-api")){const e=document.createElement("script");e.id="yt-iframe-api",e.src="https://www.youtube.com/iframe_api",document.head.appendChild(e)}}),Ne)}function xs(t,e){if(!t||!t.id)return;const r=t.id;vs().then(n=>{const o=new n.Player(r,{events:{onStateChange:s=>{s.data===n.PlayerState.PLAYING?Y.requestFocus(r):(s.data===n.PlayerState.PAUSED||s.data===n.PlayerState.ENDED)&&Y.markPaused(r)}}});Y.registerSource({id:r,type:"youtube",title:e,play:()=>o.playVideo(),pause:()=>o.pauseVideo(),stop:()=>o.stopVideo()})})}function Ss(t,e){if(!t)return;const r=t.id||`audio-${me()}`;t.id=r,Y.registerSource({id:r,type:"html5",title:t.getAttribute("data-title")||"Audio",play:()=>t.play(),pause:()=>t.pause(),stop:()=>{t.pause(),t.currentTime=0}}),t.addEventListener("play",()=>Y.requestFocus(r)),t.addEventListener("pause",()=>Y.markPaused(r)),t.addEventListener("ended",()=>Y.markPaused(r))}function dr(t,{type:e,title:r}={}){if(!t)return;const n=t.id||`${e||"embed"}-${me()}`;if(t.id=n,t.dataset.src||(t.dataset.src=t.src),!t.dataset.autoplay){const i=t.dataset.src;let c=i;e==="spotify"?c=i.includes("?")?`${i}&autoplay=1`:`${i}?autoplay=1`:e==="yandex"&&(c=i.includes("?")?`${i}&autoplay=1`:`${i}?autoplay=1`),t.dataset.autoplay=c}const o=t.parentElement,s=o?o.querySelector(".embed-overlay"):null;s&&s.remove(),Y.registerSource({id:n,type:e||"other",title:r||"Embed",play:()=>{t.src=t.dataset.autoplay||t.dataset.src},pause:()=>{t.src=t.dataset.src},stop:()=>{t.src=t.dataset.src}})}function _s(t,e,r,n,o){const s=JSON.stringify([0,t,e,r,n,o]),i=gr(Ze(s));return lt(i)}async function Qr(t,e,r,n,o){const s=t.nostr_pubkey,i=_s(s,o,e,r,n),c=await zr.sign(Kt(i),Kt(t.nostr_privkey)),l=lt(c);return{id:i,pubkey:s,created_at:o,kind:e,tags:r,content:n,sig:l}}function Zn(t){return t.trim().replace(/^#/,"")}function to(){const e=(a.settings.rooms||[]).map(n=>Zn(n));return e.length?JSON.stringify(["REQ",je,{kinds:[1,42],"#t":e}]):null}function Bs(){return JSON.stringify(["CLOSE",je])}function gt(){const t=Array.from(bt.values()).map(o=>({url:o.url,state:o.status,last_error:o.lastError||null})),e=t.filter(o=>o.state==="connected").length,r=t.filter(o=>o.state==="error").length,n={total:t.length,connected:e,errors:r,items:t};return Bn("relay-status",n),n}function ks(){var r;const t=Fe(a.settings.relays||[]),e=new Set(t);for(const[n,o]of bt.entries())e.has(n)||((r=o.ws)==null||r.close(),bt.delete(n));for(const n of t)bt.has(n)||bt.set(n,{url:n,status:"connecting",lastError:null,backoff:1e3,ws:null,timer:null}),eo(n);return gt()}function eo(t){const e=bt.get(t);if(e&&!(e.ws&&(e.ws.readyState===WebSocket.OPEN||e.ws.readyState===WebSocket.CONNECTING))){e.status="connecting",e.lastError=null,gt();try{const r=new WebSocket(t);e.ws=r,r.onopen=()=>{e.status="connected",e.lastError=null,e.backoff=1e3;const n=to();n&&r.send(n),gt()},r.onmessage=n=>{typeof n.data=="string"&&As(n.data,t)},r.onerror=()=>{e.status="error",e.lastError=e.lastError||"WebSocket error",gt()},r.onclose=()=>{e.status="reconnecting",gt();const n=Math.min(e.backoff,3e4);e.backoff=Math.min(e.backoff*2,3e4),clearTimeout(e.timer),e.timer=setTimeout(()=>eo(t),n)}}catch(r){e.status="error",e.lastError=String(r),gt()}}}function Ke(t){bt.forEach(e=>{e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(t)})}function zn(){const t=Bs();Ke(t);const e=to();e&&Ke(e)}function As(t,e){let r;try{r=JSON.parse(t)}catch{return}if(!Array.isArray(r)||!r.length)return;const n=r[0];if(n==="NOTICE"){const f=r[1]||"",y=bt.get(e);y&&(y.lastError=f||"NOTICE",y.status=y.status==="connected"?"connected":"error",gt());return}if(n==="OK"){if(!(r[2]!==!1)){const y=r[3]||"event rejected",g=bt.get(e);g&&(g.lastError=y,gt())}return}if(n!=="EVENT"||r.length<3)return;const o=r[2];if(!o||o.kind!==1&&o.kind!==42)return;let s;try{s=JSON.parse(o.content)}catch{return}if(!s||typeof s!="object")return;if(s.type==="signal"){const f={type:"signal",room:et(s.room||"")||hr(o.tags),from:s.from||o.pubkey,to:s.to||null,sid:s.sid,kind:s.kind,sdp:s.sdp||null,candidate:s.candidate||null,ts:s.ts||o.created_at*1e3};Bn("signal-message",f);return}if(s.type!=="message")return;const i=et(s.room||"")||hr(o.tags);if(!i)return;const c={type:"message",room:i,nick:s.nick||`npub:${(o.pubkey||"").slice(0,8)}`,client_id:s.client_id||o.pubkey,createdAtSec:Number(o.created_at||0)||Math.floor(Date.now()/1e3),ts:Number(o.created_at||0)*1e3||Date.now(),text:s.text||"",attachments:Array.isArray(s.attachments)?s.attachments:[],id:o.id,action:!!s.action,reply:s.reply&&typeof s.reply=="object"?s.reply:null};c.receivedAtMs=ut();const l=bs(c);if(l){if(a.initialBuffering){a.bufferedMessages.push(l);return}no(l)&&Bn("new-message",l)}}function hr(t=[]){for(const e of t)if(e&&e[0]==="t"&&e[1])return et(e[1]);return""}function no(t){if(!t||(t.id||(t.id=Pn(t)),t.createdAtSec||(t.createdAtSec=ot(t)),t.receivedAtMs||(t.receivedAtMs=ut()),ye.has(t.id)))return!1;ye.add(t.id),zt.set(t.id,t);const e=Zt.get(t.room)||[];if(e.push(t),e.sort(ge),e.length>500){const r=e.shift();r!=null&&r.id&&zt.delete(r.id)}return Zt.set(t.room,e),!0}async function Cs(){const t={};return Zt.forEach((e,r)=>{t[r]=e.length}),{settings:a.settings,counts:t,relay_summary:gt()}}async function Ls(t){const e={...a.settings,...t};e.relays=Fe(e.relays||[]),e.rooms=Un(e.rooms||[]),e.rooms.length||(e.rooms=["#echo"]),Gr(e),a.settings=e,je=Wr(e.nostr_pubkey),Kn(e),zn()}async function Ns(t){const e=et(t);e&&(a.settings.rooms.includes(e)||(a.settings.rooms.push(e),Kn(a.settings),zn()))}async function Is(t){const e=et(t);if(e){if(a.settings.rooms.length<=1)throw new Error("At least one room must remain.");a.settings.rooms=a.settings.rooms.filter(r=>r!==e),Kn(a.settings),zn()}}async function Rs(t){const e=et(t);return Zt.get(e)||[]}async function $s(){return ks()}async function Ts(t){var l;if(((l=t.attachments)==null?void 0:l.length)>2)throw new Error("Only 2 inline images allowed.");const e=et(t.room),r=Math.floor(Date.now()/1e3),n={room:e,type:"message",nick:t.nick||"Anonymous",client_id:a.settings.nostr_pubkey,createdAtSec:r,ts:r*1e3,text:t.text||"",attachments:t.attachments||[],id:"",action:!!t.action,reply:t.reply||null};n.id=Pn(n);const o=JSON.stringify(n),s=[["t",Zn(e)]],i=await Qr(a.settings,1,s,o,r);n.id=i.id,n.receivedAtMs=ut();const c=JSON.stringify(["EVENT",i]);if(c.length>(a.settings.max_payload_kb||450)*1024)throw new Error("Payload exceeds max_payload_kb limit.");return no(n)&&Ke(c),n}async function Ms(t){const e={type:"signal",room:et(t.room),from:t.from||a.settings.nostr_pubkey,to:t.to||null,sid:t.sid,kind:t.kind,sdp:t.sdp||null,candidate:t.candidate||null,ts:Date.now()},r=JSON.stringify(e),n=[["t",Zn(e.room)]],o=await Qr(a.settings,1,n,r,Math.floor(e.ts/1e3)),s=JSON.stringify(["EVENT",o]);Ke(s)}function ut(){return Date.now()}function z(t){Jo.textContent=t}function Os({title:t,body:e,okText:r}){return new Promise(n=>{Ie=n,rs.textContent=t,os.textContent=e||"Are you sure?",jr.textContent=r,pe.classList.remove("hidden")})}function We(t){Ie&&(Ie(t),Ie=null),pe.classList.add("hidden")}function Pe(){ht.style.height="auto";const t=Math.max(ht.scrollHeight,as);ht.style.height=`${t}px`}function ro(t){const e=Number(t||0)*1e3;if(!e)return"";const r=new Date(e),n=new Date,o=r.getFullYear()===n.getFullYear()&&r.getMonth()===n.getMonth()&&r.getDate()===n.getDate(),s=String(r.getHours()).padStart(2,"0"),i=String(r.getMinutes()).padStart(2,"0");if(o)return`${s}:${i}`;const c=r.getFullYear(),l=String(r.getMonth()+1).padStart(2,"0"),f=String(r.getDate()).padStart(2,"0");return`${c}-${l}-${f} ${s}:${i}`}function qs(t){if(!t)return"";const e=[/(?:https?:\/\/)?(?:www\.)?youtu\.be\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/shorts\/([A-Za-z0-9_-]{6,})/i,/(?:https?:\/\/)?(?:www\.)?youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/i];for(const r of e){const n=t.match(r);if(n&&n[1])return n[1]}return""}function Hs(t){if(!t)return null;const e=/(?:https?:\/\/)?open\.spotify\.com\/(track|album|playlist|episode|show)\/([A-Za-z0-9]+)(?:\?[^ \n]*)?/i,r=t.match(e);return r?{type:r[1],id:r[2]}:null}function Us(t){if(!t)return"";const e=t.match(/https?:\/\/music\.yandex\.ru\/iframe\/#([A-Za-z0-9/_-]+)/i);if(e&&e[1])return`https://music.yandex.ru/iframe/#${e[1]}`;const r=t.match(/https?:\/\/music\.yandex\.ru\/album\/(\d+)\/track\/(\d+)/i);if(r){const o=r[1];return`https://music.yandex.ru/iframe/#track/${r[2]}/${o}`}const n=t.match(/https?:\/\/music\.yandex\.ru\/track\/(\d+)/i);return n?`https://music.yandex.ru/iframe/#track/${n[1]}`:""}function Nn(t){if(!t)return"";let e=t;const r=[/https?:\/\/(?:www\.)?youtu\.be\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/watch\?v=[A-Za-z0-9_-]+(?:\&[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/shorts\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/(?:www\.)?youtube\.com\/embed\/[A-Za-z0-9_-]+(?:\?[^ \n]*)?/gi,/https?:\/\/open\.spotify\.com\/(track|album|playlist|episode|show)\/[A-Za-z0-9]+(?:\?[^ \n]*)?/gi,/https?:\/\/music\.yandex\.ru\/iframe\/#[A-Za-z0-9/_-]+/gi,/https?:\/\/music\.yandex\.ru\/album\/\d+\/track\/\d+/gi,/https?:\/\/music\.yandex\.ru\/track\/\d+/gi];for(const n of r)e=e.replace(n,"");return e.replace(/\n{3,}/g,`

`).trim()}function me(){const t=new Uint8Array(12);return crypto.getRandomValues(t),Array.from(t,e=>e.toString(16).padStart(2,"0")).join("")}function mt(){ar.innerHTML="",a.rooms.forEach(t=>{const e=document.createElement("div");e.className="room"+(t===a.currentRoom?" active":"");const r=document.createElement("span");r.textContent=t;const n=document.createElement("span");n.className="count",n.textContent=a.roomCounts[t]||0;const o=document.createElement("button");o.className="room-remove",o.textContent="×",o.title="Remove room",o.addEventListener("click",async s=>{if(s.stopPropagation(),a.rooms.length<=1){z("At least one room must remain.");return}await Os({title:"Remove room",body:`Remove room ${t}?`,okText:"Remove"})&&(await Q("remove_room",{room:t}),a.rooms=a.rooms.filter(c=>c!==t),a.currentRoom===t&&(a.currentRoom=a.rooms[0],Vt.textContent=a.currentRoom,await jt(a.currentRoom)),mt(),Et(`Left ${t}.`))}),e.append(r,n,o),e.addEventListener("click",async()=>{document.body.classList.remove("sidebar-open"),a.currentRoom=t,Vt.textContent=t,mt(),await jt(t)}),ar.appendChild(e)})}function oo(){if(!qt)return;qt.innerHTML="";const t=document.createElement("option");t.value="",t.textContent="All",qt.appendChild(t);const e=Array.from(a.peers.values()).sort((r,n)=>r.nick.localeCompare(n.nick));for(const r of e){const n=document.createElement("option");n.value=r.id,n.textContent=`${r.nick} · ${r.id.slice(0,8)}`,qt.appendChild(n)}}function Ks(t,{autoScroll:e=!0}={}){if(Y.clearAll(),V.innerHTML="",!t.length){const i=document.createElement("div");i.className="empty-state",i.textContent="No messages yet. Try /join #room or type a message.",V.appendChild(i)}const r=[...t].sort((i,c)=>ge(i,c));let n=null,o=null,s=!1;if(r.forEach(i=>{i.createdAtSec=i.createdAtSec||ot(i),i.receivedAtMs=i.receivedAtMs||ut();const c=$t(i.createdAtSec);c!==o&&(V.appendChild(Cn(i.createdAtSec)),o=c,n=null,s=!1);const l=!i.system,f=!(l&&s&&n===i.nick);Ee(i,{showMeta:f}),i!=null&&i.id&&(ye.add(i.id),zt.set(i.id,i)),l?(n=i.nick,s=!0):(n=null,s=!1)}),e?Gt(!0):(a.isAtBottom=Ge(),Tt()),r.length){const i=r[r.length-1];i&&i.id&&a.lastMessageId.set(a.currentRoom,i.id)}}function Gt(t=!1){if(!t&&!a.isAtBottom){Tt();return}requestAnimationFrame(()=>{V.scrollTop=V.scrollHeight,a.isAtBottom=!0,Tt()})}function Et(t){const e={nick:"system",createdAtSec:Math.floor(ut()/1e3),ts:ut(),text:t,action:!1,attachments:[],system:!0};Ee(e),Gt()}function Ee(t,{sorted:e=!1,showMeta:r=!0}={}){const n=document.createElement("div");n.className=t.system?"message system":"message",t&&t.id&&(n.dataset.msgId=t.id);const o=(t==null?void 0:t.createdAtSec)||ot(t)||0;n.dataset.createdAtSec=String(o),n.dataset.dayKey=$t(o),n.dataset.author=t.nick||"Anonymous",n.dataset.groupable=t.system?"0":"1";const s=V.querySelector(".empty-state");s&&s.remove();const i=document.createElement("div"),c=qs(t.text),l=Hs(t.text),f=Us(t.text),y=t.attachments&&t.attachments.length||c||l||f,g=t.action?`* ${t.nick} ${t.text}`:Nn(t.text),d=y&&!!!g;i.className="message-body",y&&i.classList.add("has-media"),d&&i.classList.add("media-only");const x=document.createElement("div");x.className="meta";const S=document.createElement("div");S.className="meta-left";const R=document.createElement("span");R.className="nick",R.textContent=t.nick||"Anonymous",R.style.color=fs(R.textContent);const b=document.createElement("span");if(b.className="time",b.textContent=ro(t.createdAtSec||ot(t)),S.append(R,b),x.appendChild(S),!t.system){const w=document.createElement("button");w.className="reply-btn",w.textContent="Reply",w.addEventListener("click",L=>{L.stopPropagation(),hs(t)}),x.appendChild(w)}const I=document.createElement("div");I.className="text";const M=g;I.textContent=M;const U=document.createElement("div");if(U.className="message-content",t.reply&&t.reply.id){const w=document.createElement("div");w.className="reply-snippet-inline";const L=t.reply.nick||"Anonymous",F=t.reply.text||"";w.textContent=`${L}: ${F}`,w.addEventListener("mouseenter",()=>ys(w,t.reply.id)),w.addEventListener("mouseleave",ps),w.addEventListener("click",()=>ms(t.reply.id)),U.appendChild(w)}M&&U.appendChild(I),i.appendChild(U),n.appendChild(x);const K=document.createElement("div");K.className="attachments";const W=c?(()=>{const w=document.createElement("div");w.className="youtube-embed";const L=document.createElement("iframe"),F=encodeURIComponent(window.location.origin);return L.src=`https://www.youtube-nocookie.com/embed/${c}?enablejsapi=1&origin=${F}&playsinline=1`,L.title="YouTube video",L.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share",L.referrerPolicy="origin-when-cross-origin",L.allowFullscreen=!0,L.id=`yt-${t.id||me()}`,w.appendChild(L),w})():null,st=l?(()=>{const w=document.createElement("div");w.className="spotify-embed";const L=document.createElement("iframe");return L.src=`https://open.spotify.com/embed/${l.type}/${l.id}`,L.title="Spotify",L.allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture",L.loading="lazy",L.referrerPolicy="origin-when-cross-origin",L.id=`sp-${t.id||me()}`,w.appendChild(L),w})():null,it=f?(()=>{const w=document.createElement("div");w.className="yandex-embed";const L=document.createElement("iframe");return L.src=f,L.title="Yandex Music",L.allow="autoplay; clipboard-write; encrypted-media",L.loading="lazy",L.referrerPolicy="origin-when-cross-origin",L.id=`ym-${t.id||me()}`,w.appendChild(L),w})():null;if(t.attachments&&t.attachments.length&&t.attachments.forEach(w=>{const L=document.createElement("img");L.src=w.data,L.alt="attachment",L.addEventListener("click",()=>Ps(w.data)),K.appendChild(L)}),W&&K.appendChild(W),st&&K.appendChild(st),it&&K.appendChild(it),y&&i.insertBefore(K,U),n.appendChild(i),r||Re(n,!1),e){const w=Array.from(V.querySelectorAll(".message"));let L=!1;for(const F of w){const T={createdAtSec:Number(F.dataset.createdAtSec||0),id:F.dataset.msgId||""};if(ge(t,T)<0){V.insertBefore(n,F),L=!0;break}}L||V.appendChild(n),gs(n,t),fr(n),fr(Xr(n))}else V.appendChild(n);if(W){const w=W.querySelector("iframe");w&&xs(w,Nn(t.text)||"YouTube")}if(st){const w=st.querySelector("iframe");w&&dr(w,{type:"spotify",title:"Spotify"})}if(it){const w=it.querySelector("iframe");w&&dr(w,{type:"yandex",title:"Yandex Music"})}return n.querySelectorAll("audio").forEach(w=>Ss(w)),t&&t.id&&a.lastMessageId.set(t.room||a.currentRoom,t.id),n}function Ps(t){t&&(Yr.src=t,Ye.classList.remove("hidden"))}function so(){Ye.classList.add("hidden"),Yr.src=""}function io(){cr.innerHTML="",a.attachments.forEach(t=>{const e=document.createElement("img");e.src=t.data,cr.appendChild(e)})}function Ds(t){const e=JSON.stringify(t);return new TextEncoder().encode(e).length/1024}async function Zs(){var r,n;a.settings=ls(),je=Wr(a.settings.nostr_pubkey);const t=await Q("get_state",{});a.settings=t.settings;const e=Un(t.settings.rooms);a.rooms=e,a.roomCounts=t.counts||{},a.currentRoom=a.rooms[0]||"#test",a.maxImageKB=t.settings.max_image_kb,a.maxPayloadKB=t.settings.max_payload_kb,tt&&(tt.value=t.settings.nick),ct&&(ct.value=t.settings.relays.join(`
`)),Bt&&(Bt.value=t.settings.max_image_kb),kt&&(kt.value=t.settings.max_payload_kb),re&&(re.checked=!!t.settings.supabase_upload),oe&&(oe.value=t.settings.supabase_url||""),se&&(se.value=t.settings.supabase_anon_key||""),ie&&(ie.value=t.settings.supabase_bucket||"echochan-images"),Qt&&(Qt.value=((r=t.settings.stun_urls)==null?void 0:r.join(`
`))||""),ae&&(ae.checked=t.settings.use_tor||!1),ce&&(ce.value=t.settings.proxy_url||""),te&&(te.value=((n=t.settings.turn_urls)==null?void 0:n.join(`
`))||""),ee&&(ee.value=t.settings.turn_username||""),ne&&(ne.value=t.settings.turn_password||""),le&&(le.value=t.settings.max_p2p_mb||5),ue&&(ue.value=t.settings.p2p_timeout_sec||15),fe&&(fe.value=t.settings.p2p_recent_minutes||10),de&&(de.value=t.settings.p2p_max_sessions||2),Vt.textContent=a.currentRoom,mt(),qt&&oo(),await jt(a.currentRoom),Je(t.relay_summary),JSON.stringify(e)!==JSON.stringify(t.settings.rooms)&&(a.settings.rooms=e,await Q("save_settings",{settings:a.settings})),Et(`Relays configured: ${a.settings.relays.length}`),Dn(),a.isAtBottom=!0,Tt(),zs()}function zs(){a.relayPollId||(a.relayPollId=setInterval(async()=>{try{const t=await Q("get_state",{});t&&t.relay_summary&&Je(t.relay_summary)}catch{}},4e3))}function Je(t){if(!t)return;const e=t.total??(t.items?t.items.length:0),r=t.connected??0,n=t.errors??0;a.relayItems=t.items||[],e>0&&r===0&&n===0?z(`Connecting to ${e} relays...`):r>0?z(`Connected to ${r}/${e} relays, ${n} errors`):z(`Connected to 0 relays, ${n} errors`),Ys(t.items||[]),Fs(t.items||[]),Vs(t),a.pendingRelayDetail&&js(t)}function Vs(t){const e=[];t.total===0?e.push("No relays configured. Open Settings and add wss:// relays."):t.connected===0&&e.push("No relay connections yet. Check relay errors in Settings.");const r=(t.items||[]).filter(o=>o.last_error);if(r.length)for(const o of r)o.last_error?e.push(`${o.url} error: ${o.last_error}`):e.push(`${o.url} error`);if(!e.length)return;const n=e.join(" ");n!==a.lastRelayNotice&&(a.lastRelayNotice=n,At(n,"error"))}function js(t){const e=t.items||[];if(!e.length)return;const n=`Relay status: ${e.map(o=>o.last_error?`${o.state}: ${o.url} (${o.last_error})`:`${o.state}: ${o.url}`).join(" | ")}`;n!==a.lastRelayDetail&&(a.lastRelayDetail=n,At(n,"info",5e3),a.pendingRelayDetail=!1)}function Ys(t){const e=_e&&!_t.classList.contains("hidden"),r=e?_e.scrollTop:0;if(Be){if(Be.innerHTML="",!t.length){const n=document.createElement("div");n.textContent="No relay status yet. Click Test relays.",Be.appendChild(n),e&&(_e.scrollTop=r);return}t.forEach(n=>{const o=document.createElement("div");o.className="relay-status-item";const s=document.createElement("div");s.textContent=n.url;const i=document.createElement("div");i.className=`state ${n.state}`,i.textContent=n.state;const c=document.createElement("button");if(c.textContent="Remove",c.addEventListener("click",async()=>{const l=a.settings.relays.filter(f=>f!==n.url);if(!l.length){z("At least one relay must remain.");return}ct.value=l.join(`
`),await Xe({close:!1})}),o.append(s,i,c),n.last_error){const l=document.createElement("div");l.className="error",l.textContent=n.last_error,o.appendChild(l)}Be.appendChild(o)}),e&&(_e.scrollTop=r)}}function Fs(t){const e=t.filter(n=>n.last_error);if(Wt.innerHTML="",!e.length){Wt.classList.add("hidden");return}Wt.classList.remove("hidden");const r=document.createElement("div");r.className="title",r.textContent="Relay errors",Wt.appendChild(r),e.forEach(n=>{const o=document.createElement("div");o.className="item",o.textContent=n.last_error?`${n.url} — ${n.last_error}`:`${n.url} — error`,Wt.appendChild(o)})}async function jt(t){const e=await Q("get_room_messages",{room:t});a.roomCounts[t]=e.length,Ks(e),lo(e),mt()}async function Vn(){var t;if(z("Connecting..."),At("Connecting to relays...","info",3e3),ws(),(t=a.settings)!=null&&t.use_tor){const e=a.settings.proxy_url||"socks5://127.0.0.1:9150";At(`Using SOCKS5 proxy: ${e}`,"info",4e3)}a.pendingRelayDetail=!0;try{const e=await Q("connect_relays",{});Je(e);const r=e.total??(e.items?e.items.length:0),n=e.connected??0,o=e.errors??0;r>0&&n===0&&o===0?At("Connecting to chat...","info",3e3):At("Connected to chat.","info",3e3)}catch(e){z(String(e)),At(String(e),"error",5e3)}}async function Gs(t){const e=t.trim();if(e){if(e.startsWith("/join ")){const r=et(e.replace("/join","").trim());if(!r)return;a.rooms.includes(r)||(a.rooms.push(r),mt(),await Q("add_room",{room:r})),a.currentRoom=r,Vt.textContent=r,Et(`Joined ${r}.`),await jt(r);return}if(e.startsWith("/leave ")){const r=et(e.replace("/leave","").trim());if(!r)return;if(a.rooms.length<=1){z("At least one room must remain.");return}if(!a.rooms.includes(r)){z("Room not found.");return}await Q("remove_room",{room:r}),a.rooms=a.rooms.filter(n=>n!==r),a.currentRoom===r&&(a.currentRoom=a.rooms[0],Vt.textContent=a.currentRoom,await jt(a.currentRoom)),mt(),Et(`Left ${r}.`);return}if(e.startsWith("/nick ")){const r=e.replace("/nick","").trim();if(!r)return;a.settings.nick=r,tt.value=r,await Q("save_settings",{settings:a.settings}),Et(`Nick changed to ${r}.`);return}}}async function ao(t){const e=t.trim();if(!e)return;if(e.startsWith("/join ")||e.startsWith("/nick ")||e.startsWith("/leave ")){await Gs(e),ht.value="",Ln(),Pe();return}let r=!1,n=e;e.startsWith("/me ")&&(r=!0,n=e.replace("/me","").trim());const o=a.replyTo?{id:a.replyTo.id,nick:a.replyTo.nick,text:a.replyTo.text,ts:a.replyTo.ts}:null,s={type:"message",room:et(a.currentRoom),nick:a.settings.nick,createdAtSec:Math.floor(Date.now()/1e3),ts:Date.now(),text:n,attachments:a.attachments,id:"0".repeat(64),action:r,reply:o};if(Ds(s)>a.maxPayloadKB){z(`Payload exceeds ${a.maxPayloadKB}KB limit.`);return}try{const i=await Q("send_message",{message:{room:et(a.currentRoom),nick:a.settings.nick,text:n,attachments:a.attachments,action:r,reply:o}});a.attachments=[],Ln(),io(),ht.value="",Pe(),a.roomCounts[a.currentRoom]=(a.roomCounts[a.currentRoom]||0)+1,Ee(i),mt(),Gt(!0)}catch(i){z(String(i))}}async function Ws(t,e,r){const n=await createImageBitmap(t),o=Math.max(n.width,n.height),s=Math.min(1,e/o),i=[1,.9,.8,.7,.6],c=[.75,.6,.45,.3],l=document.createElement("canvas"),f=l.getContext("2d");for(const y of i){const g=s*y,u=Math.max(1,Math.round(n.width*g)),d=Math.max(1,Math.round(n.height*g));l.width=u,l.height=d,f.clearRect(0,0,u,d),f.drawImage(n,0,0,u,d);for(const x of c){const S=l.toDataURL("image/webp",x),R=S.split(",")[1]||"",b=Math.floor(R.length*.75);if(b<=r*1024)return{kind:"inline",mime:"image/webp",data:S,w:u,h:d,size:b}}}throw new Error("Image too large after compression.")}async function Js(t,e){const r=a.settings.supabase_url,n=a.settings.supabase_anon_key,o=a.settings.supabase_bucket;if(!r||!n||!o)throw new Error("Supabase upload is enabled but credentials are missing.");const s=(t.split(",")[1]||"").trim();if(!s)throw new Error("Invalid image data.");const i=Uint8Array.from(atob(s),g=>g.charCodeAt(0)),c=String(e).replace(/[^\w.-]+/g,"_"),l=`uploads/${Date.now()}_${Math.random().toString(16).slice(2)}_${c}.webp`,f=`${r}/storage/v1/object/${o}/${l}`,y=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${n}`,apikey:n,"Content-Type":"image/webp","x-upsert":"true"},body:i});if(!y.ok){const g=await y.text();throw new Error(`Supabase upload failed: ${y.status} ${g}`)}return`${r}/storage/v1/object/public/${o}/${l}`}async function co(t){for(const e of t){if(a.attachments.length>=2){z("Only 2 inline images allowed.");break}try{const r=await Ws(e,1280,a.maxImageKB);if(a.settings.supabase_upload){z("Uploading image...");const n=await Js(r.data,e.name||"image");a.attachments.push({kind:"link",mime:r.mime,data:n,w:r.w,h:r.h,size:r.size}),z("Image uploaded.")}else a.attachments.push(r);io()}catch(r){z(String(r))}}}function Xs(){_t.classList.remove("hidden")}function jn(){_t.classList.add("hidden"),Yn()}async function Xe({close:t=!0}={}){const e=Fe(((ct==null?void 0:ct.value)||"").split(`
`)),r=((Qt==null?void 0:Qt.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length),n=((te==null?void 0:te.value)||"").split(`
`).map(i=>i.trim()).filter(i=>i.length);a.settings.nick=(tt==null?void 0:tt.value.trim())||a.settings.nick,a.settings.relays=e,ct&&(ct.value=e.join(`
`));const o=Number(Bt==null?void 0:Bt.value)||a.maxImageKB,s=Number(kt==null?void 0:kt.value)||a.maxPayloadKB;a.settings.max_image_kb=Math.max(20,Math.min(80,o)),a.settings.max_payload_kb=Math.max(60,Math.min(200,s)),a.settings.supabase_upload=!!(re!=null&&re.checked),a.settings.supabase_url=(oe==null?void 0:oe.value.trim())||"",a.settings.supabase_anon_key=(se==null?void 0:se.value.trim())||"",a.settings.supabase_bucket=(ie==null?void 0:ie.value.trim())||"echochan-images",Bt&&(Bt.value=String(a.settings.max_image_kb)),kt&&(kt.value=String(a.settings.max_payload_kb)),a.settings.stun_urls=r,a.settings.use_tor=(ae==null?void 0:ae.checked)||!1,a.settings.proxy_url=(ce==null?void 0:ce.value.trim())||"",a.settings.turn_urls=n,a.settings.turn_username=(ee==null?void 0:ee.value)||"",a.settings.turn_password=(ne==null?void 0:ne.value)||"",a.settings.max_p2p_mb=Number(le==null?void 0:le.value)||5,a.settings.p2p_timeout_sec=Number(ue==null?void 0:ue.value)||15,a.settings.p2p_recent_minutes=Number(fe==null?void 0:fe.value)||10,a.settings.p2p_max_sessions=Number(de==null?void 0:de.value)||2,a.maxImageKB=a.settings.max_image_kb,a.maxPayloadKB=a.settings.max_payload_kb,await Q("save_settings",{settings:a.settings}),t&&jn(),await Vn()}async function Yn(){if(!tt)return;const t=tt.value.trim()||"Anonymous";t!==a.settings.nick&&(a.settings.nick=t,await Q("save_settings",{settings:a.settings}))}function lo(t){if(qt){for(const e of t){if(!e.client_id)continue;const r=e.client_id,n=a.peers.get(r),o=e.nick||r.slice(0,8),s=(e.createdAtSec||ot(e))*1e3||ut();(!n||n.lastSeen<s)&&a.peers.set(r,{id:r,nick:o,lastSeen:s})}oo()}}async function Qs(t){{z("P2P is disabled.");return}}async function ti(t){}Vr.addEventListener("click",async()=>{const t=et(kn.value);t&&(a.rooms.includes(t)||(a.rooms.push(t),mt(),await Q("add_room",{room:t})),a.currentRoom=t,Vt.textContent=t,Et(`Joined ${t}.`),await jt(t),kn.value="")});ts.addEventListener("click",Xs);es.addEventListener("click",jn);ns.addEventListener("click",Xe);tt==null||tt.addEventListener("blur",Yn);tt==null||tt.addEventListener("change",Yn);_t.addEventListener("click",t=>{t.target===_t&&jn()});cn==null||cn.addEventListener("click",async()=>{await Vn()});ln==null||ln.addEventListener("click",async()=>{ct&&(ct.value=Fr.join(`
`)),await Xe({close:!1})});un==null||un.addEventListener("click",async()=>{try{const t=await Q("check_tor",{});Et(t?"Tor proxy is reachable.":"Tor is disabled. Enable Use Tor to test.")}catch(t){Et(`Tor check failed: ${String(t)}`)}});fn==null||fn.addEventListener("click",async()=>{const t=new Set(a.relayItems.filter(r=>r.state==="error").map(r=>r.url));if(!t.size){z("No failing relays to remove.");return}const e=a.settings.relays.filter(r=>!t.has(r));if(!e.length){z("All relays would be removed.");return}ct.value=e.join(`
`),await Xe({close:!1})});jr.addEventListener("click",()=>We(!0));ss.addEventListener("click",()=>We(!1));pe.addEventListener("click",t=>{t.target===pe&&We(!1)});Ye.addEventListener("click",()=>{so()});dn==null||dn.addEventListener("click",()=>{window.innerWidth<=900?document.body.classList.toggle("sidebar-open"):document.body.classList.toggle("sidebar-collapsed")});hn==null||hn.addEventListener("click",()=>{document.body.classList.remove("sidebar-open")});Qo.addEventListener("click",()=>An.click());an==null||an.addEventListener("click",()=>{Rt==null||Rt.click()});Rt==null||Rt.addEventListener("change",async t=>{var r;((r=t.target.files)==null?void 0:r[0])&&await Qs(),Rt.value=""});An.addEventListener("change",async t=>{const e=Array.from(t.target.files||[]);await co(e),An.value=""});kn.addEventListener("keydown",async t=>{t.key==="Enter"&&(t.preventDefault(),Vr.click())});Xo.addEventListener("click",async()=>ao(ht.value));ht.addEventListener("keydown",async t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),await ao(ht.value))});ht.addEventListener("paste",async t=>{var n;const e=(n=t.clipboardData)==null?void 0:n.items;if(!e)return;const r=[];for(const o of e)if(o.kind==="file"&&o.type.startsWith("image/")){const s=o.getAsFile();s&&r.push(s)}r.length&&(t.preventDefault(),await co(r))});ht.addEventListener("input",Pe);V.addEventListener("scroll",()=>{a.isAtBottom=Ge(),Tt()});Ut==null||Ut.addEventListener("click",()=>{Gt(!0)});yn==null||yn.addEventListener("click",()=>{Ln()});he==null||he.addEventListener("click",()=>{Y.isPlaying()?Y.pauseCurrent():Y.playCurrent()});gn==null||gn.addEventListener("click",()=>Y.stopCurrent());wn==null||wn.addEventListener("click",()=>Y.switchSource());document.addEventListener("keydown",t=>{t.key==="Escape"&&!pe.classList.contains("hidden")&&We(!1),t.key==="Escape"&&!Ye.classList.contains("hidden")&&so()});Hn("new-message",t=>{const e=t.payload;if(!(!e||!e.room)){if(a.roomCounts[e.room]||(a.roomCounts[e.room]=0),a.roomCounts[e.room]+=1,e.room===a.currentRoom){const r=Ge();Ee(e,{sorted:!0}),r?Gt(!0):(a.isAtBottom=!1,Tt()),lo([e])}mt()}});Hn("relay-status",t=>{Je(t.payload)});Hn("signal-message",t=>{ti(t.payload).catch(()=>{})});Zs().then(Vn).catch(t=>z(String(t)));Pe();
